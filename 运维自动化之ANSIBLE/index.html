<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/M_32px.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/M_16px.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":7,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="运维自动化发展历程及技术应用企业实际应用场景分析Dev开发环境 使用者:程序员 功能:程序员开发软件，测试BUG的环境 管理者:程序员 测试环境 使用者:QA测试工程师 功能:测试经过Dev环境测试通过的软件的功能 管理者:运维 说明:测试环境往往有多套,测试环境满足测试功能即可，不宜过多 1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试 2、通常测试环境">
<meta property="og:type" content="article">
<meta property="og:title" content="运维自动化之ANSIBLE(一)">
<meta property="og:url" content="http://yoursite.com/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BANSIBLE/index.html">
<meta property="og:site_name" content="Mark blog">
<meta property="og:description" content="运维自动化发展历程及技术应用企业实际应用场景分析Dev开发环境 使用者:程序员 功能:程序员开发软件，测试BUG的环境 管理者:程序员 测试环境 使用者:QA测试工程师 功能:测试经过Dev环境测试通过的软件的功能 管理者:运维 说明:测试环境往往有多套,测试环境满足测试功能即可，不宜过多 1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试 2、通常测试环境">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-12-21T05:00:51.000Z">
<meta property="article:modified_time" content="2019-01-01T03:33:08.211Z">
<meta property="article:author" content="Mark">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BANSIBLE/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>运维自动化之ANSIBLE(一) | Mark blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Mark blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">知行合一 划水归档</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BANSIBLE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          运维自动化之ANSIBLE(一)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-21 13:00:51" itemprop="dateCreated datePublished" datetime="2018-12-21T13:00:51+08:00">2018-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-01-01 11:33:08" itemprop="dateModified" datetime="2019-01-01T11:33:08+08:00">2019-01-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="运维自动化发展历程及技术应用"><a href="#运维自动化发展历程及技术应用" class="headerlink" title="运维自动化发展历程及技术应用"></a>运维自动化发展历程及技术应用</h3><h5 id="企业实际应用场景分析"><a href="#企业实际应用场景分析" class="headerlink" title="企业实际应用场景分析"></a>企业实际应用场景分析</h5><p>Dev开发环境</p>
<p>使用者:程序员</p>
<p>功能:程序员开发软件，测试BUG的环境</p>
<p>管理者:程序员</p>
<p>测试环境</p>
<p>使用者:QA测试工程师</p>
<p>功能:测试经过Dev环境测试通过的软件的功能</p>
<p>管理者:运维</p>
<p>说明:测试环境往往有多套,测试环境满足测试功能即可，不宜过多</p>
<p>1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试</p>
<p>2、通常测试环境有多少套和产品线数量保持一样</p>
<p>发布环境:代码发布机，有些公司为堡垒机（安全屏障）</p>
<p>使用者:运维</p>
<p>功能:发布代码至生产环境</p>
<p>管理者:运维（有经验）</p>
<p>发布机:往往需要有2台（主备）</p>
<p>生产环境</p>
<p>使用者:运维，少数情况开放权限给核心开发人员，极少数公司将权限完全开放给开发人员并其维护</p>
<p>功能:对用户提供公司产品的服务</p>
<p>管理者:只能是运维</p>
<p>生产环境服务器数量:一般比较多，且应用非常重要。往往需要自动工具协助部署配置应用<br>灰度环境（生产环境的一部分）</p>
<p>使用者:运维</p>
<p>功能:在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基于主机或用户执行灰度发布</p>
<p>案例:共100台生产服务器，先发布其中的10台服务器，这10台服务器就是灰度服务器</p>
<p>管理者:运维</p>
<p>灰度环境:往往该版本功能变更较大，为保险起见特意先让一部分用户优化体验该功能，待这部分用户使用没有重大问题的时候，再全量发布至所有服务器</p>
<h5 id="程序发布"><a href="#程序发布" class="headerlink" title="程序发布"></a>程序发布</h5><p>程序发布要求:</p>
<p>不能导致系统故障或造成系统完全不可用</p>
<p>不能影响用户体验</p>
<p>预发布验证:</p>
<p>新版本的代码先发布到服务器（跟线上环境配置完全相同，只是未接入到调度器）</p>
<p>灰度发布:</p>
<p>基于主机，用户，业务</p>
<p>发布路径:</p>
<pre><code>/webapp/markupzh 

/webapp/markupzh-1.1 

/webapp/markupzh-1.2</code></pre><p>发布过程:</p>
<p>在调度器上下线一批主机(标记为maintanance状态) –&gt; 关闭服务 –&gt; 部署新版本的应用程序 –&gt; 启动服务 –&gt; 在调度器上启用这一批服务器</p>
<p>自动化灰度发布:</p>
<p>脚本、发布平台</p>
<h5 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h5><p>文件传输</p>
<p>应用部署</p>
<p>配置管理</p>
<p>任务流编排</p>
<h5 id="常用自动化运维工具"><a href="#常用自动化运维工具" class="headerlink" title="常用自动化运维工具"></a>常用自动化运维工具</h5><pre><code>Ansible:python,Agentless,中小型应用环境

Saltstack:python，一般需部署agent，执行效率更高

Puppet:ruby, 功能强大,配置复杂，重型,适合大型环境

Fabric:python，agentless

Chef: ruby,国内应用少

Cfengine

func</code></pre><h3 id="企业级自动化运维工具应用实战ansible"><a href="#企业级自动化运维工具应用实战ansible" class="headerlink" title="企业级自动化运维工具应用实战ansible"></a>企业级自动化运维工具应用实战ansible</h3><p>公司计划在年底做一次大型市场促销活动，全面冲刺下交易额，为明年的上市做准备。公司要求各业务组对年底大促做准备，运维部要求所有业务容量进行三倍的扩容，并搭建出多套环境可以共开发和测试人员做测试，运维老大为了在年底有所表现，要求运维部门同学尽快实现，接到这个任务时，有没有更快的解决方案？</p>
<h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><p>模块化:调用特定的模块，完成特定任务</p>
<p>有Paramiko，PyYAML，Jinja2（模板语言）三个关键模块</p>
<p>支持自定义模块</p>
<p>基于Python语言实现</p>
<p>部署简单，基于python和SSH(默认已安装)，agentless</p>
<p>安全，基于OpenSSH</p>
<p>支持playbook编排任务</p>
<p>幂等性:一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</p>
<p>无需代理不依赖PKI（无需ssl）</p>
<p>可使用任何编程语言写模块</p>
<p>YAML格式，编排任务，支持丰富的数据结构</p>
<p>较强大的多层解决方案</p>
<h4 id="Ansible主要组成部分"><a href="#Ansible主要组成部分" class="headerlink" title="Ansible主要组成部分"></a>Ansible主要组成部分</h4><p>ANSIBLE PLAYBOOKS:任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</p>
<p>INVENTORY:Ansible管理主机的清单/etc/anaible/hosts</p>
<p>MODULES:Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</p>
<p>PLUGINS:模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</p>
<p>API:供第三方程序调用的应用程序编程接口</p>
<p>ANSIBLE:组合INVENTORY、API、MODULES、PLUGINS的绿框，可以理解为是ansible命令工具，其为核心执行工具</p>
<p>Ansible命令执行来源:</p>
<pre><code>USER，普通用户，即SYSTEM ADMINISTRATOR

CMDB（配置管理数据库） API 调用

PUBLIC/PRIVATE CLOUD API调用

USER-&gt; Ansible Playbook -&gt; Ansibile</code></pre><p>利用ansible实现管理的方式:</p>
<pre><code>Ad-Hoc 即ansible命令，主要用于临时命令使用场景

Ansible-playbook 主要用于长期规划好的，大型项目的场景，需要有前提的规划</code></pre><p>Ansible-playbook（剧本）执行过程:</p>
<pre><code>将已有编排好的任务集写入Ansible-Playbook

通过ansible-playbook命令分拆任务集至逐条ansible命令，按预定规则逐条执行</code></pre><p>Ansible主要操作对象:</p>
<pre><code>HOSTS主机

NETWORKING网络设备</code></pre><p>注意事项</p>
<p>执行ansible的主机一般称为主控端，中控，master或堡垒机</p>
<p>主控端Python版本需要2.6或以上</p>
<p>被控端Python版本小于2.4需要安装python-simplejson</p>
<p>被控端如开启SELinux需要安装libselinux-python</p>
<p>windows不能做为主控端</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><h5 id="rpm包安装-EPEL源"><a href="#rpm包安装-EPEL源" class="headerlink" title="rpm包安装: EPEL源"></a>rpm包安装: EPEL源</h5><p><code>yum install ansible</code>    </p>
<p>编译安装:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tar xf ansible-1.5.4.tar.gz </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ansible-1.5.4 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> python setup.py build </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> python setup.py install </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/ansible</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp -r examples/* /etc/ansible</span></span><br></pre></td></tr></table></figure>

<h5 id="Git方式"><a href="#Git方式" class="headerlink" title="Git方式:"></a>Git方式:</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> git://github.com/ansible/ansible.git --recursive <span class="built_in">cd</span> ./ansible</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> ./hacking/env-setup</span></span><br></pre></td></tr></table></figure>

<h5 id="pip安装"><a href="#pip安装" class="headerlink" title="pip安装:"></a>pip安装:</h5><p>pip是安装Python包的管理器，类似yum </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum install python-pip python-devel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel pip install --upgrade pip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pip install ansible --upgrade</span></span><br></pre></td></tr></table></figure>

<h5 id="确认安装"><a href="#确认安装" class="headerlink" title="确认安装:"></a>确认安装:</h5><p><code>ansible --version</code></p>
<h4 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h4><h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><pre><code>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性                     

/etc/ansible/hosts 主机清单

/etc/ansible/roles/ 存放角色的目录</code></pre><h5 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h5><pre><code>/usr/bin/ansible 主程序，临时命令执行工具 

/usr/bin/ansible-doc 查看配置文档，模块功能查看工具 

/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台

/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具

/usr/bin/ansible-pull 远程执行命令的工具

/usr/bin/ansible-vault 文件加密工具 

/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</code></pre><h5 id="主机清单inventory"><a href="#主机清单inventory" class="headerlink" title="主机清单inventory"></a>主机清单inventory</h5><p>Inventory 主机清单</p>
<p>ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名</p>
<p>默认的inventory file为/etc/ansible/hosts</p>
<p>inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成</p>
<p>/etc/ansible/hosts文件格式</p>
<p>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中；此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ntp.markupzh.com</span><br><span class="line">[webservers]</span><br><span class="line">www1.markupzh.com:2222</span><br><span class="line">www2.markupzh.com</span><br><span class="line">[dbservers]</span><br><span class="line">db1.markupzh.com</span><br><span class="line">db2.markupzh.com</span><br><span class="line">db3.markupzh.com</span><br></pre></td></tr></table></figure>

<p>如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www[01:100].example.com</span><br><span class="line">[dbsrvs] </span><br><span class="line">db-[a:f].example.com</span><br></pre></td></tr></table></figure>

<h5 id="ansible-配置文件"><a href="#ansible-配置文件" class="headerlink" title="ansible 配置文件"></a>ansible 配置文件</h5><p>Ansible 配置文件/etc/ansible/ansible.cfg （一般保持默认）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"><span class="meta">#</span><span class="bash">inventory = /etc/ansible/hosts <span class="comment"># 主机列表配置文件</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">library = /usr/share/my_modules/ <span class="comment"># 库文件存放目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment">#临时py命令文件存放在远程主机目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment"># 本机的临时命令执行目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">forks = 5	<span class="comment"># 默认并发数</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">sudo_user = root <span class="comment"># 默认sudo 用户</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_sudo_pass = True <span class="comment">#每次执行ansible命令是否询问ssh密码</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_pass = True</span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_port = 22</span></span><br><span class="line"><span class="meta">#</span><span class="bash">host_key_checking = False <span class="comment"># 检查对应服务器的host_key，建议取消注释 #log_path=/var/log/ansible.log #日志文件</span></span></span><br></pre></td></tr></table></figure>

<h4 id="ansible系列命令"><a href="#ansible系列命令" class="headerlink" title="ansible系列命令"></a>ansible系列命令</h4><p>ansible ansible-doc </p>
<p>ansible-playbook </p>
<p>ansible-vault </p>
<p>ansible-console     </p>
<p>ansible-galaxy </p>
<p>ansible-pull</p>
<p>ansible-doc: 显示模块帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc options</span><br><span class="line">-a	显示所有模块的文档</span><br><span class="line">-l, --list	列出可用模块</span><br><span class="line">-s, --snippet显示指定模块的playbook片段</span><br></pre></td></tr></table></figure>

<h5 id="示例"><a href="#示例" class="headerlink" title="示例:"></a>示例:</h5><p>ansible-doc –l 列出所有模块<br>ansible-doc ping 查看指定模块帮助用法<br>ansible-doc –s ping 查看指定模块帮助用法</p>
<p>ansible通过ssh实现配置管理、应用部署、任务执行等功能，建议配置ansible端能基于密钥认证的方式联系各被管理节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible &lt;host-pattern&gt; -m module_name</span><br><span class="line">--version 显示版本</span><br><span class="line">-m module	指定模块，默认为command</span><br><span class="line">-v 详细过程 –vv -vvv更详细</span><br><span class="line">--list-hosts 显示主机列表，可简写 --list</span><br><span class="line">-k, --ask-pass	提示输入ssh连接密码，默认Key验证</span><br><span class="line">-K, --ask-become-pass 提示输入sudo时的口令</span><br><span class="line">-C, --check	检查，并不执行</span><br><span class="line">-T, --timeout=TIMEOUT 执行命令的超时时间，默认10s </span><br><span class="line">-u, --user=REMOTE_USER 执行远程执行的用户 </span><br><span class="line">-b, --become 代替旧版的sudo 切换</span><br></pre></td></tr></table></figure>

<h5 id="ansible的Host-pattern"><a href="#ansible的Host-pattern" class="headerlink" title="ansible的Host-pattern"></a>ansible的Host-pattern</h5><p>匹配主机的列表</p>
<p>All :表示所有Inventory中的所有主机 </p>
<pre><code>ansible all –m ping</code></pre><p><code>*</code>:通配符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible "*" -m ping</span><br><span class="line">ansible 192.168.1.* -m ping</span><br><span class="line">ansible "*srvs" -m ping</span><br></pre></td></tr></table></figure>

<p>或关系</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible "websrvs:appsrvs" -m ping</span><br><span class="line">ansible "192.168.1.10:192.168.1.20"  -m ping</span><br></pre></td></tr></table></figure>

<p>逻辑与</p>
<p><code>ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</code></p>
<p>在websrvs组并且在dbsrvs组中的主机</p>
<p>逻辑非</p>
<p><code>ansible &#39;websrvs:!dbsrvs&#39; –m ping</code></p>
<p>在websrvs组，但不在dbsrvs组中的主机注意:此处为单引号</p>
<p>综合逻辑</p>
<p><code>ansible &#39;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#39; –m ping</code></p>
<p>正则表达式</p>
<p><code>ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</code></p>
<p><code>ansible &quot;~(web|db).*\.markupzh\.com&quot; –m ping</code></p>
<h4 id="ansible命令执行过程"><a href="#ansible命令执行过程" class="headerlink" title="ansible命令执行过程"></a>ansible命令执行过程</h4><pre><code>1. 加载自己的配置文件 默认/etc/ansible/ansible.cfg

2. 加载自己对应的模块文件，如command

3. 通过ansible将模块或命令生成对应的临时py文件，并将该 文件传输至远程服务器的对应执行用户$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件

4. 给文件+x执行

5. 执行并返回结果

6. 删除临时py文件，sleep 0退出

执行状态:

    绿色:执行成功并且不需要做改变的操作

    黄色:执行成功并且对目标主机做变更

    红色:执行失败</code></pre><h4 id="ansible使用示例"><a href="#ansible使用示例" class="headerlink" title="ansible使用示例"></a>ansible使用示例</h4><p>以mark用户执行ping存活检测 </p>
<p><code>ansible all -m ping -u mark -k</code></p>
<p>以mark sudo至root执行ping存活检测 </p>
<p><code>ansible all -m ping -u mark –b -k</code></p>
<p>以mark sudo至markupzh用户执行ping存活检测</p>
<p><code>ansible all -m ping -u mark –b -k --become-user markupzh</code></p>
<p>以mark sudo至root用户执行ls</p>
<p><code>ansible all -m command -u mark --become-user=root -a &#39;ls /root&#39; -b –k -K</code></p>
<h4 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h4><p>Command:在远程主机执行命令，默认模块，可忽略-m选项</p>
<p><code>ansible srvs -m command -a &#39;service vsftpd start&#39;</code></p>
<p><code>ansible srvs -m command -a &#39;echo markupzh |passwd --stdin mark&#39;</code>不成功</p>
<p>此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，用shell模块实现</p>
<p>Shell:和command相似，用shell执行命令</p>
<p><code>ansible srv -m shell -a &#39;echo markupzh |passwd –stdin mark&#39;</code></p>
<p>调用bash执行命令 类似 cat /tmp/stanley.md | awk -F’|’ ‘{print $1,$2}’ &amp;&gt; /tmp/example.txt 这些复杂命令，即使使用shell也可能会失败，解决办法:写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器</p>
<p><strong>Script</strong>:运行脚本</p>
<p><code>-a &quot;/PATH/TO/SCRIPT_FILE&quot;</code></p>
<p><code>snsible websrvs -m script -a f1.sh</code></p>
<p><strong>Copy</strong>:从服务器复制文件到客户端</p>
<p><code>ansible srv -m copy -a &quot;src=/root/f1.sh dest=/tmp/f2.sh owner=mark mode=600 backup=yes&quot;</code></p>
<p>如目标存在，默认覆盖，此处指定先备份</p>
<p><code>ansible srv -m copy -a &quot;content=&#39;test content\n&#39; dest=/tmp/f1.txt&quot;</code></p>
<p>利用内容，直接生成目标文件</p>
<p><strong>Fetch</strong>:从客户端取文件至服务器端，copy相反，目录可先tar</p>
<p><code>ansible srv -m fetch -a &#39;src=/root/a.sh dest=/data/scripts&#39;</code></p>
<p><strong>File</strong>:设置文件属性</p>
<p><code>ansible srv -m file -a &quot;path=/root/a.sh owner=mark mode=755&quot;</code></p>
<p><code>ansible web -m file -a &#39;src=/app/testfile dest=/app/testfile-link state=link&#39;</code></p>
<p><strong>Hostname</strong>:管理主机名</p>
<p><code>ansible node1 -m hostname -a &quot;name=websrv&quot;</code></p>
<p><strong>Cron</strong>:计划任务</p>
<p>支持时间:minute，hour，day，month，weekday</p>
<p><code>ansible srv -m cron -a &quot;minute=*/5 job=&#39;/usr/sbin/ntpdate</code></p>
<p><code>172.16.0.1 &amp;&gt;/dev/null&#39; name=Synctime&quot;</code>创建任务</p>
<p><code>ansible srv -m cron -a &#39;state=absent name=Synctime&#39;</code> 删除任务</p>
<p><strong>Yum</strong>:管理包</p>
<p><code>ansible srv -m yum -a &#39;name=httpd state=latest&#39;</code> 安装</p>
<p><code>ansible srv -m yum -a &#39;name=httpd state=absent&#39;</code> 删除</p>
<p><strong>Service</strong>:管理服务</p>
<p><code>ansible srv -m service -a &#39;name=httpd state=stopped&#39;</code></p>
<p><code>ansible srv -m service -a &#39;name=httpd state=started&#39;</code></p>
<p><code>ansible srv –m service –a &#39;name=httpd state=reloaded&#39;</code></p>
<p><code>ansible srv -m service -a &#39;name=httpd state=restarted&#39;</code></p>
<p><strong>User</strong>:管理用户</p>
<p><code>ansible srv -m user -a &#39;name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1 group=root&#39;</code></p>
<p><code>ansible srv -m user -a &#39;name=sysuser1 system=yes home=/app/sysuser1 &#39;</code></p>
<p><code>ansible srv -m user -a &#39;name=user1 state=absent remove=yes&#39;</code>删除用户及家目录等数据</p>
<p><strong>Group</strong>:管理组</p>
<p><code>ansible srv -m group -a &quot;name=testgroup system=yes&quot;</code></p>
<p><code>ansible srv -m group -a &quot;name=testgroup state=absent&quot;</code></p>
<h4 id="ansible系列命令-1"><a href="#ansible系列命令-1" class="headerlink" title="ansible系列命令"></a>ansible系列命令</h4><p><code>ansible-galaxy</code></p>
<p>连接 <a href="https://galaxy.ansible.com" target="_blank" rel="noopener">https://galaxy.ansible.com</a> 下载相应的roles</p>
<p>列出所有已安装的galaxy</p>
<p><code>ansible-galaxy list</code></p>
<p>安装galaxy</p>
<p><code>ansible-galaxy install geerlingguy.redis</code></p>
<p>删除galaxy</p>
<p><code>ansible-galaxy remove geerlingguy.redis</code></p>
<p>ansible-pull</p>
<p>推送命令至远程，效率无限提升，对运维要求较高</p>
<h5 id="Ansible-playbook"><a href="#Ansible-playbook" class="headerlink" title="Ansible-playbook"></a>Ansible-playbook</h5><p>ansible-playbook hello.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">hello.yml</span></span><br><span class="line"><span class="comment">#hello world yml file</span></span><br><span class="line"><span class="string">-hosts:</span> <span class="string">websrvs</span></span><br><span class="line">    <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">tasks:</span></span><br><span class="line">    <span class="string">-name:</span> <span class="string">hello</span> <span class="string">world</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">/usr/bin/wall</span> <span class="string">hello</span> <span class="string">world</span></span><br></pre></td></tr></table></figure>

<h5 id="Ansible-vault"><a href="#Ansible-vault" class="headerlink" title="Ansible-vault"></a>Ansible-vault</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">功能:管理加密解密yml文件</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">[create|decrypt|edit|encrypt|rekey|view]</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">encrypt</span> <span class="string">hello.yml</span> <span class="string">加密</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">decrypt</span> <span class="string">hello.yml</span> <span class="string">解密</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">view</span> <span class="string">hello.yml</span> <span class="string">查看</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">edit</span> <span class="string">hello.yml</span> <span class="string">编辑加密文件</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">rekey</span> <span class="string">hello.yml</span> <span class="string">修改口令</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">create</span> <span class="string">new.yml</span> <span class="string">创建新文件</span></span><br></pre></td></tr></table></figure>

<h5 id="Ansible-console"><a href="#Ansible-console" class="headerlink" title="Ansible-console"></a>Ansible-console</h5><p>Ansible-console:2.0+新增，可交互执行命令，支持tab</p>
<p><code>root@test (2)[f:10] $</code></p>
<p>执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$</p>
<p>设置并发数: forks n 例如: forks 10</p>
<p>切换组: cd 主机组 例如: cd web</p>
<p>列出当前组主机列表: list</p>
<p>列出所有的内置命令: ?或help</p>
<p>示例:    </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@all (2)[f:5]$ list </span><br><span class="line">root@all (2)[f:5]$ cd appsrvs </span><br><span class="line">root@appsrvs (2)[f:5]$ list</span><br><span class="line">root@appsrvs (2)[f:5]$ yum name=httpd state=present </span><br><span class="line">root@appsrvs (2)[f:5]$ service name=httpd state=started</span><br></pre></td></tr></table></figure>

<h5 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h5><p>playbook是由一个或多个”play”组成的列表</p>
<p>play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上来讲，所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可以让它们联同起来按事先编排的机制同唱一台大戏</p>
<p>Playbook采用YAML语言编写</p>
<h4 id="YAML介绍"><a href="#YAML介绍" class="headerlink" title="YAML介绍"></a>YAML介绍</h4><p>YAML是一个可读性高的用来表达资料序列的格式。YAML参考了其他多种语言，包括:XML、C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者</p>
<p>YAML Ain’t Markup Language，即YAML不是XML。不过，在开发的这种语言时，YAML的意思其实是:”Yet Another Markup Language”（仍是一种标记语言）</p>
<p>特性    </p>
<p>YAML的可读性好</p>
<p>YAML和脚本语言的交互性好</p>
<p>YAML使用实现语言的数据类型</p>
<p>YAML有一个一致的信息模型</p>
<p>YAML易于实现</p>
<p>YAML可以基于流来处理</p>
<p>YAML表达能力强，扩展性好</p>
<p>更多的内容及规范参见<a href="http://www.yaml.org" target="_blank" rel="noopener">http://www.yaml.org</a></p>
<h5 id="YAML语法简介"><a href="#YAML语法简介" class="headerlink" title="YAML语法简介"></a>YAML语法简介</h5><p>在单一档案中，可用连续三个连字号(——)区分多个档案。另外，还有选择性的连续三个点号( … )用来表示档案结尾</p>
<p>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</p>
<p>使用#号注释代码</p>
<p>缩进必须是统一的，不能空格和tab混用</p>
<p>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</p>
<p>YAML文件内容是区别大小写的，k/v的值均需大小写敏感</p>
<p>k/v的值可同行写也可换行写。同行使用:分隔</p>
<p>v可是个字符串，也可是另一个列表</p>
<p>一个完整的代码块功能需最少元素需包括 name: task</p>
<p>一个name只能包括一个task</p>
<p>YAML文件扩展名通常为yml或yaml</p>
<p>List:列表，其所有元素均使用”-“打头</p>
<h5 id="示例-1"><a href="#示例-1" class="headerlink" title="示例:"></a>示例:</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">A</span> <span class="string">list</span> <span class="string">of</span> <span class="string">tasty</span> <span class="string">fruits</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Apple</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Orange</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Strawberry</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Mango</span></span><br></pre></td></tr></table></figure>

<p>Dictionary:字典，通常由多个key与value构成</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">An</span> <span class="string">employee</span> <span class="string">record</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Example</span> <span class="string">Developer</span></span><br><span class="line"><span class="attr">job:</span> <span class="string">Developer</span></span><br><span class="line"><span class="attr">skill:</span> <span class="string">Elite</span></span><br></pre></td></tr></table></figure>

<p>也可以将key:value放置于{}中进行表示，用,分隔多个key:value</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">An</span> <span class="string">employee</span> <span class="string">record</span></span><br><span class="line"><span class="string">&#123;name:</span> <span class="string">Example</span> <span class="string">Developer,</span> <span class="attr">job:</span> <span class="string">Developer,</span> <span class="attr">skill:</span> <span class="string">Elite&#125;</span></span><br></pre></td></tr></table></figure>

<p>YAML语法</p>
<p>YAML的语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据结构。其结构（Structure）通过空格来展示，序列（Sequence）里的项用”-“来代表，Map里的键值对用”:”分隔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">John</span> <span class="string">Smith</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">41</span></span><br><span class="line"><span class="attr">gender:</span> <span class="string">Male</span> </span><br><span class="line"><span class="attr">spouse:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">Jane</span> <span class="string">Smith</span></span><br><span class="line">	<span class="attr">age:</span> <span class="number">37</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Female</span> </span><br><span class="line"><span class="attr">children:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Jimmy</span> <span class="string">Smith</span></span><br><span class="line">	<span class="attr">age:</span> <span class="number">17</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Male</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Jenny</span> <span class="string">Smith</span> </span><br><span class="line">	<span class="string">age</span> <span class="number">13</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Female</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h4><p>Hosts  执行的远程主机列表<br>Tasks  任务集<br>Varniables 内置变量或自定义变量在playbook中调用<br>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件<br>Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行<br>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断<br><code>ansible-playbook –t tagsname useradd.yml</code></p>
<h4 id="playbook基础组件"><a href="#playbook基础组件" class="headerlink" title="playbook基础组件"></a>playbook基础组件</h4><p>Hosts:<br>playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中<br>可以是如下形式:<br>​    one.example.com<br>​    one.example.com:two.example.com<br>​    192.168.1.50<br>​    192.168.1.*</p>
<p>Websrvs:dbsrvs   两个组的并集</p>
<p>Websrvs:&amp;dbsrvs   两个组的交集</p>
<p>webservers:!phoenix 在websrvs组，但不在dbsrvs组</p>
<p>示例: - hosts: websrvs:dbsrvs</p>
<p>remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">	<span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">	<span class="string">-name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line"><span class="attr">ping:</span></span><br><span class="line">	<span class="attr">remote_user:</span> <span class="string">markupzh</span></span><br><span class="line">	<span class="attr">sudo:</span> <span class="literal">yes</span>	<span class="string">默认sudo为root</span></span><br><span class="line">	<span class="string">sudo_user:mark</span>	<span class="string">sudo为mark</span></span><br></pre></td></tr></table></figure>

<p>task列表和action<br>play的主体部分是task list。task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后，再开始第二个任务</p>
<p>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</p>
<p>每个task都应该有其name，用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤。如果未提供name，则action的结果将用于输出</p>
<p>playbook基础组件<br>tasks:任务列表</p>
<p>格式:<br>(1) action: module arguments</p>
<p>(2) module: arguments    建议使用</p>
<p>注意:shell和command模块后面跟命令，而非key=value</p>
<p>某任务的状态在运行后为changed时，可通过”notify”通知给相应的 handlers</p>
<p>任务可以通过”tags”打标签，而后可在ansible-playbook命令上使用-t指定进行调用</p>
<p>示例: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">disable</span> <span class="string">selinux</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">/sbin/setenforce</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>如果命令或脚本的退出码不为零，可以使用如下方式替代 </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br></pre></td></tr></table></figure>

<p>或者使用ignore_errors来忽略错误信息:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">/usr/bin/somecommand</span></span><br><span class="line">  <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h4 id="运行playbook"><a href="#运行playbook" class="headerlink" title="运行playbook"></a>运行playbook</h4><p>运行playbook的方式</p>
<p><code>ansible-playbook &lt;filename.yml&gt; ... [options]</code></p>
<p>常见选项</p>
<p>–check 只检测可能会发生的改变，但不真正执行操作</p>
<p>–list-hosts 列出运行任务的主机</p>
<p>–limit 主机列表 只针对主机列表中的主机执行</p>
<p>-v 显示过程 -vv -vvv 更详细</p>
<p>示例</p>
<p><code>ansible-playbook file.yml --check</code> 只检测 </p>
<p><code>ansible-playbook file.yml</code></p>
<p><code>ansible-playbook file.yml --limit websrvs</code></p>
<h4 id="Playbook与ShellScripts相比较"><a href="#Playbook与ShellScripts相比较" class="headerlink" title="Playbook与ShellScripts相比较"></a>Playbook与ShellScripts相比较</h4><p>SHELL脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装Apache</span></span><br><span class="line">yum install --quiet -y httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制配置文件</span></span><br><span class="line">cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf </span><br><span class="line">cp /tmp/vhosts.conf /etc/httpd/conf.d/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动Apache，并设置开机启动 </span></span><br><span class="line">service httpd start </span><br><span class="line">chkconfig httpd on</span><br></pre></td></tr></table></figure>

<p>Playbook定义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span> </span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"安装Apache"</span></span><br><span class="line">  <span class="attr">yum:</span>  <span class="string">name=httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=/tmp/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=/tmp/vhosts.conf</span> <span class="string">dest=/etc/httpd/conf.cd/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"启动Apache，并设置开机启动"</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook示例"><a href="#Playbook示例" class="headerlink" title="Playbook示例"></a>Playbook示例</h4><p>示例:sysuser.yml创建mysql用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">mysql</span> <span class="string">user</span></span><br><span class="line">	<span class="attr">user:</span> <span class="string">name=mysql</span> <span class="string">system=yes</span> <span class="string">uid=36</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">group</span></span><br><span class="line">	<span class="attr">group:</span> <span class="string">name=httpd</span> <span class="string">system=yes</span></span><br></pre></td></tr></table></figure>

<p>示例:httpd.yml安装httpd</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<h4 id="handlers和notify结合使用触发条件"><a href="#handlers和notify结合使用触发条件" class="headerlink" title="handlers和notify结合使用触发条件"></a>handlers和notify结合使用触发条件</h4><p>Handlers</p>
<p>是task列表，这些task与前述的task并没有本质上的不同,用于当关注的资源发生变化时，才会采取一定的操作</p>
<p>Notify此action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作</p>
<h4 id="Playbook中handlers使用"><a href="#Playbook中handlers使用" class="headerlink" title="Playbook中handlers使用"></a>Playbook中handlers使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span> <span class="attr">handlers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">status=restarted</span></span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=/root/config.txt</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">notify:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">Process</span> </span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> <span class="string">enabled=yes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">process</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">killall</span> <span class="number">-0</span> <span class="string">nginx</span> <span class="string">&gt;</span> <span class="string">/tmp/nginx.log</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook中tags使用"><a href="#Playbook中tags使用" class="headerlink" title="Playbook中tags使用"></a>Playbook中tags使用</h4><p>示例:httpd.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">conf</span></span><br><span class="line"></span><br><span class="line"> 	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line"> 	<span class="attr">tags:</span> <span class="string">service</span></span><br><span class="line"> 	<span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line">  <span class="string">ansible-playbook</span> <span class="string">–t</span> <span class="string">conf</span> <span class="string">httpd.yml</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook中变量使用"><a href="#Playbook中变量使用" class="headerlink" title="Playbook中变量使用"></a>Playbook中变量使用</h4><p>变量名:</p>
<p>仅能由字母、数字和下划线组成，且只能以字母开头</p>
<p>变量来源:</p>
<p>1 ansible setup facts 远程主机的所有变量都可直接调用</p>
<p>2 在/etc/ansible/hosts中定义</p>
<p>普通变量:主机组中主机单独定义，优先级高于公共变量公共（组）变量:针对主机组中所有主机定义统一变量</p>
<p>3 通过命令行指定变量，优先级最高</p>
<p>ansible-playbook –e varname=value</p>
<p>4 在playbook中定义<br>  vars:<br>​    -    var1: value1<br>​    -    var2: value2</p>
<p>5 在独立的变量YAML文件中定义</p>
<p>6 在role中定义<br>变量命名<br>变量名仅能由字母、数字和下划线组成，且只能以字母开头</p>
<p>变量定义:key=value<br>示例:http_port=80</p>
<p>变量调用方式:<br>​<br>通过 调用变量，且变量名前后必须有空格，有时用”“才生效</p>
<p>ansible-playbook –e 选项指定<br><code>ansible-playbook test.yml -e &quot;hosts=www user=markupzh&quot;</code></p>
<p>示例:使用setup变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">log</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">name=/var/log/</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_fqdn</span> <span class="string">&#125;&#125;</span> <span class="string">state=touch</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">var.yml</span></span><br></pre></td></tr></table></figure>
<p>示例:变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">–e</span> <span class="string">pkname=httpd</span> <span class="string">var.yml</span></span><br></pre></td></tr></table></figure>

<p>示例:变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">username:</span> <span class="string">user1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">groupname:</span> <span class="string">group1</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">	  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">var.yml</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">-e</span> <span class="string">"username=user2 groupname=group2"</span>  <span class="string">var2.yml</span></span><br></pre></td></tr></table></figure>

<p>主机变量</p>
<p>可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www1.markupzh.com http_port=80 maxRequestsPerChild=808 www2.markupzh.com http_port=8080 maxRequestsPerChild=909</span><br></pre></td></tr></table></figure>

<p>组变量</p>
<p>组变量是指赋予给指定组内所有主机上的在playbook中可用的变量</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www1.markupzh.com</span><br><span class="line">www2.markupzh.com</span><br><span class="line">[websrvs:vars]</span><br><span class="line">ntp_server=ntp.markupzh.com nfs_server=nfs.markupzh.com</span><br></pre></td></tr></table></figure>

<p>普通变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">192.168.99.101 http_port=8080 hname=www1</span><br><span class="line">192.168.99.102 http_port=80   hname=www2</span><br></pre></td></tr></table></figure>

<p>公共（组）变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[websvrs:vars] </span><br><span class="line">http_port=808</span><br><span class="line">mark="_"</span><br><span class="line"></span><br><span class="line">[websrvs]</span><br><span class="line">192.168.99.101 http_port=8080 hname=www1</span><br><span class="line">192.168.99.102 http_port=80 hname=www2</span><br><span class="line"></span><br><span class="line">ansible websvrs –m hostname –a 'name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;'</span><br></pre></td></tr></table></figure>

<p>命令行指定变量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible websvrs –e http_port&#x3D;8000 –m hostname –a &#39;name&#x3D;&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>使用变量文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat vars.yml </span><br><span class="line"></span><br><span class="line">var1: httpd </span><br><span class="line">var2: nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat var.yml</span><br><span class="line"></span><br><span class="line">- hosts: web</span><br><span class="line">  remote_user: root </span><br><span class="line">  vars_files:</span><br><span class="line">    - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create httpd log</span><br><span class="line">    file: name=/app/&#123;&#123; var1 &#125;&#125;.log state=touch</span><br><span class="line">    - name: create nginx log</span><br><span class="line">    file: name=/app/&#123;&#123; var2 &#125;&#125;.log state=touch</span><br></pre></td></tr></table></figure>

<p>模板templates</p>
<p>文本文件，嵌套有脚本（使用模板编程语言编写）</p>
<p>Jinja2语言，使用字面量，有下面形式字符串:使用单引号或双引号</p>
<p>数字:整数，浮点数</p>
<p>列表:[item1, item2, …]</p>
<p>元组:(item1, item2, …)</p>
<p>字典:{key1:value1, key2:value2, …}</p>
<p>布尔型:true/false</p>
<p>算术运算:+, -, <em>, /, //, %, *</em></p>
<p>比较操作:==, !=, &gt;, &gt;=, &lt;, &lt;=</p>
<p>逻辑运算:and, or, not</p>
<p>流表达式:For If When</p>
<h4 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h4><p>templates功能:根据模块文件动态生成对应的配置文件</p>
<p>templates文件必须存放于templates目录下，且命名为 .j2 结尾</p>
<p>yaml/yml 文件需和templates目录平级，目录结构如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">├── temnginx.yml</span><br><span class="line">└── templates</span><br><span class="line">	  └── nginx.conf.j2</span><br></pre></td></tr></table></figure>

<h4 id="Templates示例"><a href="#Templates示例" class="headerlink" title="Templates示例"></a>Templates示例</h4><p>示例:利用templates 同步nginx配置文件准备templates/nginx.conf.j2文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim temnginx.yml</span><br><span class="line"></span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: template config to remote hosts</span><br><span class="line">	 template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">ansible-playbook temnginx.yml</span><br></pre></td></tr></table></figure>

<h4 id="Playbook中template变更替换"><a href="#Playbook中template变更替换" class="headerlink" title="Playbook中template变更替换"></a>Playbook中template变更替换</h4><p>修改文件nginx.conf.j2 下面行为</p>
<p><code>worker_processes ;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat temnginx2.yml</span><br><span class="line"></span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">	- name: template config to remote hosts</span><br><span class="line">	template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">ansible-playbook temnginx2.yml</span><br></pre></td></tr></table></figure>

<h4 id="Playbook中template算术运算"><a href="#Playbook中template算术运算" class="headerlink" title="Playbook中template算术运算"></a>Playbook中template算术运算</h4><p>算法运算:</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf.j2</span><br><span class="line"></span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;; </span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus+2 &#125;&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="when"><a href="#when" class="headerlink" title="when"></a>when</h4><p>条件测试:如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,通过when语句实现，在task中使用，jinja2的语法格式</p>
<p>when语句</p>
<p>在task后添加when子句即可使用条件测试；when语句支持Jinja2表达式语法</p>
<p>示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"shutdown RedHat flavored systems"</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">/sbin/shutdown</span> <span class="string">-h</span> <span class="string">now</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br></pre></td></tr></table></figure>

<p>示例:when条件判断</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br></pre></td></tr></table></figure>

<p>示例:when条件判断</p>
<p>示例: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos7</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=nginx.conf.c7.j2</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos6</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=nginx.conf.c6.j2</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br></pre></td></tr></table></figure>

<p>迭代:with_items</p>
<p>迭代:当有需要重复性执行的任务时，可以使用迭代机制</p>
<p>对迭代项的引用，固定变量名为”item”</p>
<p>要在task中使用with_items给定要迭代的元素列表</p>
<p>列表格式:</p>
<p>字符串</p>
<p>字典</p>
<p>示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="string">groups=wheel</span> </span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">testuser1</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">testuser2</span></span><br></pre></td></tr></table></figure>

<p>上面语句的功能等同于下面的语句:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser1</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=testuser1</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser2</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=testuser2</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<p>将多个文件进行copy到被控端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">testsrv</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="string">tasks</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">rsyncd</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/etc/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsyncd.secrets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsyncd.conf</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">file</span></span><br><span class="line">	  <span class="attr">copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/tmp/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file1</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file2</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file3</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">apr</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">apr-util</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">httpd</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts:websrvs</span> </span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="string">tasks</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">some</span> <span class="string">packages</span></span><br><span class="line">	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">memcached</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">php-fpm</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代嵌套子变量</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts:websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group3</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span></span><br><span class="line">	  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="attr">with_items:</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user1'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group1'</span> <span class="string">&#125;</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user2'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group2'</span> <span class="string">&#125;</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user3'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group3'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h4><p>ansilbe自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中</p>
<p>复杂场景:建议使用roles，代码复用度高</p>
<p>变更指定主机或主机组</p>
<p>如命名不规范维护和传承成本大</p>
<p>某些功能需多个Playbook，通过Includes即可实现</p>
<p>角色(roles):角色集合 </p>
<p>roles/</p>
<p>  mysql/</p>
<p>  httpd/</p>
<p>  nginx/</p>
<p>  memcached/</p>
<h4 id="roles目录结构"><a href="#roles目录结构" class="headerlink" title="roles目录结构"></a>roles目录结构</h4><p>每个角色，以特定的层级目录结构进行组织</p>
<p>roles目录结构: </p>
<p>playbook.yml </p>
<p>  roles/<br>​     project/<br>​     tasks/<br>​     files/<br>​     vars/<br>​     templates/<br>​     handlers/<br>​     default/  不常用<br>​     meta/    不常用</p>
<p>Roles各目录作用:</p>
<pre><code>/roles/project/ :项目名称,有以下子目录

files/ :存放由copy或script模块等调用的文件

templates/:template模块查找所需要模板文件的目录

tasks/:定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

handlers/:至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

vars/:定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

meta/:定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含

default/:设定默认变量时使用此目录中的main.yml文件</code></pre><p>创建role:</p>
<pre><code>创建role的步骤

(1) 创建以roles命名的目录

(2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等

(3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；用不到的目录可以创建为空目录，也可以不创建

(4) 在playbook文件中，调用各角色</code></pre><h4 id="playbook调用角色"><a href="#playbook调用角色" class="headerlink" title="playbook调用角色"></a>playbook调用角色</h4><p>调用角色方法1:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">memcached</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>调用角色方法2:传递变量给角色</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="attr">remote_user:</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>键role用于指定角色名称</p>
<p>后续的k/v用于传递变量给角色</p>
<p>调用角色方法3:还可基于条件测试实现角色调用 roles:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx,</span> <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">'7'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="推荐资料"><a href="#推荐资料" class="headerlink" title="推荐资料"></a>推荐资料</h4><pre><code>http://galaxy.ansible.com
https://galaxy.ansible.com/explore#/
http://github.com/
http://ansible.com.cn/
https://github.com/ansible/ansible
https://github.com/ansible/ansible-examples</code></pre>
    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/%E9%85%8D%E7%BD%AELinux%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4SSH%E4%BA%92%E4%BF%A1%E8%BF%9E%E6%8E%A5/" rel="prev" title="配置Linux主机之间SSH互信连接">
      <i class="fa fa-chevron-left"></i> 配置Linux主机之间SSH互信连接
    </a></div>
      <div class="post-nav-item">
    <a href="/CLI%E5%88%9B%E5%BB%BA%E5%B9%B6%E4%BD%BF%E7%94%A8KVM/" rel="next" title="CLI创建并使用KVM">
      CLI创建并使用KVM <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#运维自动化发展历程及技术应用"><span class="nav-number">1.</span> <span class="nav-text">运维自动化发展历程及技术应用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#企业实际应用场景分析"><span class="nav-number">1.0.1.</span> <span class="nav-text">企业实际应用场景分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#程序发布"><span class="nav-number">1.0.2.</span> <span class="nav-text">程序发布</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#自动化运维应用场景"><span class="nav-number">1.0.3.</span> <span class="nav-text">自动化运维应用场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#常用自动化运维工具"><span class="nav-number">1.0.4.</span> <span class="nav-text">常用自动化运维工具</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#企业级自动化运维工具应用实战ansible"><span class="nav-number">2.</span> <span class="nav-text">企业级自动化运维工具应用实战ansible</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#特性"><span class="nav-number">2.1.</span> <span class="nav-text">特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ansible主要组成部分"><span class="nav-number">2.2.</span> <span class="nav-text">Ansible主要组成部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装"><span class="nav-number">2.3.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#rpm包安装-EPEL源"><span class="nav-number">2.3.1.</span> <span class="nav-text">rpm包安装: EPEL源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Git方式"><span class="nav-number">2.3.2.</span> <span class="nav-text">Git方式:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pip安装"><span class="nav-number">2.3.3.</span> <span class="nav-text">pip安装:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#确认安装"><span class="nav-number">2.3.4.</span> <span class="nav-text">确认安装:</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#相关文件"><span class="nav-number">2.4.</span> <span class="nav-text">相关文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#配置文件"><span class="nav-number">2.4.1.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#程序"><span class="nav-number">2.4.2.</span> <span class="nav-text">程序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#主机清单inventory"><span class="nav-number">2.4.3.</span> <span class="nav-text">主机清单inventory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ansible-配置文件"><span class="nav-number">2.4.4.</span> <span class="nav-text">ansible 配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ansible系列命令"><span class="nav-number">2.5.</span> <span class="nav-text">ansible系列命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#示例"><span class="nav-number">2.5.1.</span> <span class="nav-text">示例:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ansible的Host-pattern"><span class="nav-number">2.5.2.</span> <span class="nav-text">ansible的Host-pattern</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ansible命令执行过程"><span class="nav-number">2.6.</span> <span class="nav-text">ansible命令执行过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ansible使用示例"><span class="nav-number">2.7.</span> <span class="nav-text">ansible使用示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ansible常用模块"><span class="nav-number">2.8.</span> <span class="nav-text">ansible常用模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ansible系列命令-1"><span class="nav-number">2.9.</span> <span class="nav-text">ansible系列命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Ansible-playbook"><span class="nav-number">2.9.1.</span> <span class="nav-text">Ansible-playbook</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Ansible-vault"><span class="nav-number">2.9.2.</span> <span class="nav-text">Ansible-vault</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Ansible-console"><span class="nav-number">2.9.3.</span> <span class="nav-text">Ansible-console</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#playbook"><span class="nav-number">2.9.4.</span> <span class="nav-text">playbook</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#YAML介绍"><span class="nav-number">2.10.</span> <span class="nav-text">YAML介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#YAML语法简介"><span class="nav-number">2.10.1.</span> <span class="nav-text">YAML语法简介</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例-1"><span class="nav-number">2.10.2.</span> <span class="nav-text">示例:</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook核心元素"><span class="nav-number">2.11.</span> <span class="nav-text">Playbook核心元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#playbook基础组件"><span class="nav-number">2.12.</span> <span class="nav-text">playbook基础组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行playbook"><span class="nav-number">2.13.</span> <span class="nav-text">运行playbook</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook与ShellScripts相比较"><span class="nav-number">2.14.</span> <span class="nav-text">Playbook与ShellScripts相比较</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook示例"><span class="nav-number">2.15.</span> <span class="nav-text">Playbook示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handlers和notify结合使用触发条件"><span class="nav-number">2.16.</span> <span class="nav-text">handlers和notify结合使用触发条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook中handlers使用"><span class="nav-number">2.17.</span> <span class="nav-text">Playbook中handlers使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook中tags使用"><span class="nav-number">2.18.</span> <span class="nav-text">Playbook中tags使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook中变量使用"><span class="nav-number">2.19.</span> <span class="nav-text">Playbook中变量使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#templates"><span class="nav-number">2.20.</span> <span class="nav-text">templates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Templates示例"><span class="nav-number">2.21.</span> <span class="nav-text">Templates示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook中template变更替换"><span class="nav-number">2.22.</span> <span class="nav-text">Playbook中template变更替换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Playbook中template算术运算"><span class="nav-number">2.23.</span> <span class="nav-text">Playbook中template算术运算</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#when"><span class="nav-number">2.24.</span> <span class="nav-text">when</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#roles"><span class="nav-number">2.25.</span> <span class="nav-text">roles</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#roles目录结构"><span class="nav-number">2.26.</span> <span class="nav-text">roles目录结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#playbook调用角色"><span class="nav-number">2.27.</span> <span class="nav-text">playbook调用角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#推荐资料"><span class="nav-number">2.28.</span> <span class="nav-text">推荐资料</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mark"
      src="/images/mark_avatar.png">
  <p class="site-author-name" itemprop="name">Mark</p>
  <div class="site-description" itemprop="description">半吊子民工 英特纳雄耐尔就一定要实现</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:markupzh@gmail.com" title="E-Mail → mailto:markupzh@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mark</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
