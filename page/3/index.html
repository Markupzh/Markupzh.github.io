<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/M_32px.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/M_16px.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":7,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
<meta property="og:type" content="website">
<meta property="og:title" content="Mark blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Mark blog">
<meta property="og:description" content="半吊子民工 英特纳雄耐尔就一定要实现">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Mark">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Mark blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Mark blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">知行合一 划水归档</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BANSIBLE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BANSIBLE/" class="post-title-link" itemprop="url">运维自动化之ANSIBLE(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-21 13:00:51" itemprop="dateCreated datePublished" datetime="2018-12-21T13:00:51+08:00">2018-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-01-01 11:33:08" itemprop="dateModified" datetime="2019-01-01T11:33:08+08:00">2019-01-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="运维自动化发展历程及技术应用"><a href="#运维自动化发展历程及技术应用" class="headerlink" title="运维自动化发展历程及技术应用"></a>运维自动化发展历程及技术应用</h3><h5 id="企业实际应用场景分析"><a href="#企业实际应用场景分析" class="headerlink" title="企业实际应用场景分析"></a>企业实际应用场景分析</h5><p>Dev开发环境</p>
<p>使用者:程序员</p>
<p>功能:程序员开发软件，测试BUG的环境</p>
<p>管理者:程序员</p>
<p>测试环境</p>
<p>使用者:QA测试工程师</p>
<p>功能:测试经过Dev环境测试通过的软件的功能</p>
<p>管理者:运维</p>
<p>说明:测试环境往往有多套,测试环境满足测试功能即可，不宜过多</p>
<p>1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试</p>
<p>2、通常测试环境有多少套和产品线数量保持一样</p>
<p>发布环境:代码发布机，有些公司为堡垒机（安全屏障）</p>
<p>使用者:运维</p>
<p>功能:发布代码至生产环境</p>
<p>管理者:运维（有经验）</p>
<p>发布机:往往需要有2台（主备）</p>
<p>生产环境</p>
<p>使用者:运维，少数情况开放权限给核心开发人员，极少数公司将权限完全开放给开发人员并其维护</p>
<p>功能:对用户提供公司产品的服务</p>
<p>管理者:只能是运维</p>
<p>生产环境服务器数量:一般比较多，且应用非常重要。往往需要自动工具协助部署配置应用<br>灰度环境（生产环境的一部分）</p>
<p>使用者:运维</p>
<p>功能:在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基于主机或用户执行灰度发布</p>
<p>案例:共100台生产服务器，先发布其中的10台服务器，这10台服务器就是灰度服务器</p>
<p>管理者:运维</p>
<p>灰度环境:往往该版本功能变更较大，为保险起见特意先让一部分用户优化体验该功能，待这部分用户使用没有重大问题的时候，再全量发布至所有服务器</p>
<h5 id="程序发布"><a href="#程序发布" class="headerlink" title="程序发布"></a>程序发布</h5><p>程序发布要求:</p>
<p>不能导致系统故障或造成系统完全不可用</p>
<p>不能影响用户体验</p>
<p>预发布验证:</p>
<p>新版本的代码先发布到服务器（跟线上环境配置完全相同，只是未接入到调度器）</p>
<p>灰度发布:</p>
<p>基于主机，用户，业务</p>
<p>发布路径:</p>
<pre><code>/webapp/markupzh 

/webapp/markupzh-1.1 

/webapp/markupzh-1.2</code></pre><p>发布过程:</p>
<p>在调度器上下线一批主机(标记为maintanance状态) –&gt; 关闭服务 –&gt; 部署新版本的应用程序 –&gt; 启动服务 –&gt; 在调度器上启用这一批服务器</p>
<p>自动化灰度发布:</p>
<p>脚本、发布平台</p>
<h5 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h5><p>文件传输</p>
<p>应用部署</p>
<p>配置管理</p>
<p>任务流编排</p>
<h5 id="常用自动化运维工具"><a href="#常用自动化运维工具" class="headerlink" title="常用自动化运维工具"></a>常用自动化运维工具</h5><pre><code>Ansible:python,Agentless,中小型应用环境

Saltstack:python，一般需部署agent，执行效率更高

Puppet:ruby, 功能强大,配置复杂，重型,适合大型环境

Fabric:python，agentless

Chef: ruby,国内应用少

Cfengine

func</code></pre><h3 id="企业级自动化运维工具应用实战ansible"><a href="#企业级自动化运维工具应用实战ansible" class="headerlink" title="企业级自动化运维工具应用实战ansible"></a>企业级自动化运维工具应用实战ansible</h3><p>公司计划在年底做一次大型市场促销活动，全面冲刺下交易额，为明年的上市做准备。公司要求各业务组对年底大促做准备，运维部要求所有业务容量进行三倍的扩容，并搭建出多套环境可以共开发和测试人员做测试，运维老大为了在年底有所表现，要求运维部门同学尽快实现，接到这个任务时，有没有更快的解决方案？</p>
<h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><p>模块化:调用特定的模块，完成特定任务</p>
<p>有Paramiko，PyYAML，Jinja2（模板语言）三个关键模块</p>
<p>支持自定义模块</p>
<p>基于Python语言实现</p>
<p>部署简单，基于python和SSH(默认已安装)，agentless</p>
<p>安全，基于OpenSSH</p>
<p>支持playbook编排任务</p>
<p>幂等性:一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</p>
<p>无需代理不依赖PKI（无需ssl）</p>
<p>可使用任何编程语言写模块</p>
<p>YAML格式，编排任务，支持丰富的数据结构</p>
<p>较强大的多层解决方案</p>
<h4 id="Ansible主要组成部分"><a href="#Ansible主要组成部分" class="headerlink" title="Ansible主要组成部分"></a>Ansible主要组成部分</h4><p>ANSIBLE PLAYBOOKS:任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</p>
<p>INVENTORY:Ansible管理主机的清单/etc/anaible/hosts</p>
<p>MODULES:Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</p>
<p>PLUGINS:模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</p>
<p>API:供第三方程序调用的应用程序编程接口</p>
<p>ANSIBLE:组合INVENTORY、API、MODULES、PLUGINS的绿框，可以理解为是ansible命令工具，其为核心执行工具</p>
<p>Ansible命令执行来源:</p>
<pre><code>USER，普通用户，即SYSTEM ADMINISTRATOR

CMDB（配置管理数据库） API 调用

PUBLIC/PRIVATE CLOUD API调用

USER-&gt; Ansible Playbook -&gt; Ansibile</code></pre><p>利用ansible实现管理的方式:</p>
<pre><code>Ad-Hoc 即ansible命令，主要用于临时命令使用场景

Ansible-playbook 主要用于长期规划好的，大型项目的场景，需要有前提的规划</code></pre><p>Ansible-playbook（剧本）执行过程:</p>
<pre><code>将已有编排好的任务集写入Ansible-Playbook

通过ansible-playbook命令分拆任务集至逐条ansible命令，按预定规则逐条执行</code></pre><p>Ansible主要操作对象:</p>
<pre><code>HOSTS主机

NETWORKING网络设备</code></pre><p>注意事项</p>
<p>执行ansible的主机一般称为主控端，中控，master或堡垒机</p>
<p>主控端Python版本需要2.6或以上</p>
<p>被控端Python版本小于2.4需要安装python-simplejson</p>
<p>被控端如开启SELinux需要安装libselinux-python</p>
<p>windows不能做为主控端</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><h5 id="rpm包安装-EPEL源"><a href="#rpm包安装-EPEL源" class="headerlink" title="rpm包安装: EPEL源"></a>rpm包安装: EPEL源</h5><p><code>yum install ansible</code>    </p>
<p>编译安装:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tar xf ansible-1.5.4.tar.gz </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ansible-1.5.4 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> python setup.py build </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> python setup.py install </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/ansible</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp -r examples/* /etc/ansible</span></span><br></pre></td></tr></table></figure>

<h5 id="Git方式"><a href="#Git方式" class="headerlink" title="Git方式:"></a>Git方式:</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> git://github.com/ansible/ansible.git --recursive <span class="built_in">cd</span> ./ansible</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> ./hacking/env-setup</span></span><br></pre></td></tr></table></figure>

<h5 id="pip安装"><a href="#pip安装" class="headerlink" title="pip安装:"></a>pip安装:</h5><p>pip是安装Python包的管理器，类似yum </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum install python-pip python-devel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel pip install --upgrade pip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pip install ansible --upgrade</span></span><br></pre></td></tr></table></figure>

<h5 id="确认安装"><a href="#确认安装" class="headerlink" title="确认安装:"></a>确认安装:</h5><p><code>ansible --version</code></p>
<h4 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h4><h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><pre><code>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性                     

/etc/ansible/hosts 主机清单

/etc/ansible/roles/ 存放角色的目录</code></pre><h5 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h5><pre><code>/usr/bin/ansible 主程序，临时命令执行工具 

/usr/bin/ansible-doc 查看配置文档，模块功能查看工具 

/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台

/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具

/usr/bin/ansible-pull 远程执行命令的工具

/usr/bin/ansible-vault 文件加密工具 

/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</code></pre><h5 id="主机清单inventory"><a href="#主机清单inventory" class="headerlink" title="主机清单inventory"></a>主机清单inventory</h5><p>Inventory 主机清单</p>
<p>ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名</p>
<p>默认的inventory file为/etc/ansible/hosts</p>
<p>inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成</p>
<p>/etc/ansible/hosts文件格式</p>
<p>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中；此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ntp.markupzh.com</span><br><span class="line">[webservers]</span><br><span class="line">www1.markupzh.com:2222</span><br><span class="line">www2.markupzh.com</span><br><span class="line">[dbservers]</span><br><span class="line">db1.markupzh.com</span><br><span class="line">db2.markupzh.com</span><br><span class="line">db3.markupzh.com</span><br></pre></td></tr></table></figure>

<p>如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www[01:100].example.com</span><br><span class="line">[dbsrvs] </span><br><span class="line">db-[a:f].example.com</span><br></pre></td></tr></table></figure>

<h5 id="ansible-配置文件"><a href="#ansible-配置文件" class="headerlink" title="ansible 配置文件"></a>ansible 配置文件</h5><p>Ansible 配置文件/etc/ansible/ansible.cfg （一般保持默认）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"><span class="meta">#</span><span class="bash">inventory = /etc/ansible/hosts <span class="comment"># 主机列表配置文件</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">library = /usr/share/my_modules/ <span class="comment"># 库文件存放目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment">#临时py命令文件存放在远程主机目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment"># 本机的临时命令执行目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">forks = 5	<span class="comment"># 默认并发数</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">sudo_user = root <span class="comment"># 默认sudo 用户</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_sudo_pass = True <span class="comment">#每次执行ansible命令是否询问ssh密码</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_pass = True</span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_port = 22</span></span><br><span class="line"><span class="meta">#</span><span class="bash">host_key_checking = False <span class="comment"># 检查对应服务器的host_key，建议取消注释 #log_path=/var/log/ansible.log #日志文件</span></span></span><br></pre></td></tr></table></figure>

<h4 id="ansible系列命令"><a href="#ansible系列命令" class="headerlink" title="ansible系列命令"></a>ansible系列命令</h4><p>ansible ansible-doc </p>
<p>ansible-playbook </p>
<p>ansible-vault </p>
<p>ansible-console     </p>
<p>ansible-galaxy </p>
<p>ansible-pull</p>
<p>ansible-doc: 显示模块帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc options</span><br><span class="line">-a	显示所有模块的文档</span><br><span class="line">-l, --list	列出可用模块</span><br><span class="line">-s, --snippet显示指定模块的playbook片段</span><br></pre></td></tr></table></figure>

<h5 id="示例"><a href="#示例" class="headerlink" title="示例:"></a>示例:</h5><p>ansible-doc –l 列出所有模块<br>ansible-doc ping 查看指定模块帮助用法<br>ansible-doc –s ping 查看指定模块帮助用法</p>
<p>ansible通过ssh实现配置管理、应用部署、任务执行等功能，建议配置ansible端能基于密钥认证的方式联系各被管理节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible &lt;host-pattern&gt; -m module_name</span><br><span class="line">--version 显示版本</span><br><span class="line">-m module	指定模块，默认为command</span><br><span class="line">-v 详细过程 –vv -vvv更详细</span><br><span class="line">--list-hosts 显示主机列表，可简写 --list</span><br><span class="line">-k, --ask-pass	提示输入ssh连接密码，默认Key验证</span><br><span class="line">-K, --ask-become-pass 提示输入sudo时的口令</span><br><span class="line">-C, --check	检查，并不执行</span><br><span class="line">-T, --timeout=TIMEOUT 执行命令的超时时间，默认10s </span><br><span class="line">-u, --user=REMOTE_USER 执行远程执行的用户 </span><br><span class="line">-b, --become 代替旧版的sudo 切换</span><br></pre></td></tr></table></figure>

<h5 id="ansible的Host-pattern"><a href="#ansible的Host-pattern" class="headerlink" title="ansible的Host-pattern"></a>ansible的Host-pattern</h5><p>匹配主机的列表</p>
<p>All :表示所有Inventory中的所有主机 </p>
<pre><code>ansible all –m ping</code></pre><p><code>*</code>:通配符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible "*" -m ping</span><br><span class="line">ansible 192.168.1.* -m ping</span><br><span class="line">ansible "*srvs" -m ping</span><br></pre></td></tr></table></figure>

<p>或关系</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible "websrvs:appsrvs" -m ping</span><br><span class="line">ansible "192.168.1.10:192.168.1.20"  -m ping</span><br></pre></td></tr></table></figure>

<p>逻辑与</p>
<p><code>ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</code></p>
<p>在websrvs组并且在dbsrvs组中的主机</p>
<p>逻辑非</p>
<p><code>ansible &#39;websrvs:!dbsrvs&#39; –m ping</code></p>
<p>在websrvs组，但不在dbsrvs组中的主机注意:此处为单引号</p>
<p>综合逻辑</p>
<p><code>ansible &#39;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#39; –m ping</code></p>
<p>正则表达式</p>
<p><code>ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</code></p>
<p><code>ansible &quot;~(web|db).*\.markupzh\.com&quot; –m ping</code></p>
<h4 id="ansible命令执行过程"><a href="#ansible命令执行过程" class="headerlink" title="ansible命令执行过程"></a>ansible命令执行过程</h4><pre><code>1. 加载自己的配置文件 默认/etc/ansible/ansible.cfg

2. 加载自己对应的模块文件，如command

3. 通过ansible将模块或命令生成对应的临时py文件，并将该 文件传输至远程服务器的对应执行用户$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件

4. 给文件+x执行

5. 执行并返回结果

6. 删除临时py文件，sleep 0退出

执行状态:

    绿色:执行成功并且不需要做改变的操作

    黄色:执行成功并且对目标主机做变更

    红色:执行失败</code></pre><h4 id="ansible使用示例"><a href="#ansible使用示例" class="headerlink" title="ansible使用示例"></a>ansible使用示例</h4><p>以mark用户执行ping存活检测 </p>
<p><code>ansible all -m ping -u mark -k</code></p>
<p>以mark sudo至root执行ping存活检测 </p>
<p><code>ansible all -m ping -u mark –b -k</code></p>
<p>以mark sudo至markupzh用户执行ping存活检测</p>
<p><code>ansible all -m ping -u mark –b -k --become-user markupzh</code></p>
<p>以mark sudo至root用户执行ls</p>
<p><code>ansible all -m command -u mark --become-user=root -a &#39;ls /root&#39; -b –k -K</code></p>
<h4 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h4><p>Command:在远程主机执行命令，默认模块，可忽略-m选项</p>
<p><code>ansible srvs -m command -a &#39;service vsftpd start&#39;</code></p>
<p><code>ansible srvs -m command -a &#39;echo markupzh |passwd --stdin mark&#39;</code>不成功</p>
<p>此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，用shell模块实现</p>
<p>Shell:和command相似，用shell执行命令</p>
<p><code>ansible srv -m shell -a &#39;echo markupzh |passwd –stdin mark&#39;</code></p>
<p>调用bash执行命令 类似 cat /tmp/stanley.md | awk -F’|’ ‘{print $1,$2}’ &amp;&gt; /tmp/example.txt 这些复杂命令，即使使用shell也可能会失败，解决办法:写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器</p>
<p><strong>Script</strong>:运行脚本</p>
<p><code>-a &quot;/PATH/TO/SCRIPT_FILE&quot;</code></p>
<p><code>snsible websrvs -m script -a f1.sh</code></p>
<p><strong>Copy</strong>:从服务器复制文件到客户端</p>
<p><code>ansible srv -m copy -a &quot;src=/root/f1.sh dest=/tmp/f2.sh owner=mark mode=600 backup=yes&quot;</code></p>
<p>如目标存在，默认覆盖，此处指定先备份</p>
<p><code>ansible srv -m copy -a &quot;content=&#39;test content\n&#39; dest=/tmp/f1.txt&quot;</code></p>
<p>利用内容，直接生成目标文件</p>
<p><strong>Fetch</strong>:从客户端取文件至服务器端，copy相反，目录可先tar</p>
<p><code>ansible srv -m fetch -a &#39;src=/root/a.sh dest=/data/scripts&#39;</code></p>
<p><strong>File</strong>:设置文件属性</p>
<p><code>ansible srv -m file -a &quot;path=/root/a.sh owner=mark mode=755&quot;</code></p>
<p><code>ansible web -m file -a &#39;src=/app/testfile dest=/app/testfile-link state=link&#39;</code></p>
<p><strong>Hostname</strong>:管理主机名</p>
<p><code>ansible node1 -m hostname -a &quot;name=websrv&quot;</code></p>
<p><strong>Cron</strong>:计划任务</p>
<p>支持时间:minute，hour，day，month，weekday</p>
<p><code>ansible srv -m cron -a &quot;minute=*/5 job=&#39;/usr/sbin/ntpdate</code></p>
<p><code>172.16.0.1 &amp;&gt;/dev/null&#39; name=Synctime&quot;</code>创建任务</p>
<p><code>ansible srv -m cron -a &#39;state=absent name=Synctime&#39;</code> 删除任务</p>
<p><strong>Yum</strong>:管理包</p>
<p><code>ansible srv -m yum -a &#39;name=httpd state=latest&#39;</code> 安装</p>
<p><code>ansible srv -m yum -a &#39;name=httpd state=absent&#39;</code> 删除</p>
<p><strong>Service</strong>:管理服务</p>
<p><code>ansible srv -m service -a &#39;name=httpd state=stopped&#39;</code></p>
<p><code>ansible srv -m service -a &#39;name=httpd state=started&#39;</code></p>
<p><code>ansible srv –m service –a &#39;name=httpd state=reloaded&#39;</code></p>
<p><code>ansible srv -m service -a &#39;name=httpd state=restarted&#39;</code></p>
<p><strong>User</strong>:管理用户</p>
<p><code>ansible srv -m user -a &#39;name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1 group=root&#39;</code></p>
<p><code>ansible srv -m user -a &#39;name=sysuser1 system=yes home=/app/sysuser1 &#39;</code></p>
<p><code>ansible srv -m user -a &#39;name=user1 state=absent remove=yes&#39;</code>删除用户及家目录等数据</p>
<p><strong>Group</strong>:管理组</p>
<p><code>ansible srv -m group -a &quot;name=testgroup system=yes&quot;</code></p>
<p><code>ansible srv -m group -a &quot;name=testgroup state=absent&quot;</code></p>
<h4 id="ansible系列命令-1"><a href="#ansible系列命令-1" class="headerlink" title="ansible系列命令"></a>ansible系列命令</h4><p><code>ansible-galaxy</code></p>
<p>连接 <a href="https://galaxy.ansible.com" target="_blank" rel="noopener">https://galaxy.ansible.com</a> 下载相应的roles</p>
<p>列出所有已安装的galaxy</p>
<p><code>ansible-galaxy list</code></p>
<p>安装galaxy</p>
<p><code>ansible-galaxy install geerlingguy.redis</code></p>
<p>删除galaxy</p>
<p><code>ansible-galaxy remove geerlingguy.redis</code></p>
<p>ansible-pull</p>
<p>推送命令至远程，效率无限提升，对运维要求较高</p>
<h5 id="Ansible-playbook"><a href="#Ansible-playbook" class="headerlink" title="Ansible-playbook"></a>Ansible-playbook</h5><p>ansible-playbook hello.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">hello.yml</span></span><br><span class="line"><span class="comment">#hello world yml file</span></span><br><span class="line"><span class="string">-hosts:</span> <span class="string">websrvs</span></span><br><span class="line">    <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">tasks:</span></span><br><span class="line">    <span class="string">-name:</span> <span class="string">hello</span> <span class="string">world</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">/usr/bin/wall</span> <span class="string">hello</span> <span class="string">world</span></span><br></pre></td></tr></table></figure>

<h5 id="Ansible-vault"><a href="#Ansible-vault" class="headerlink" title="Ansible-vault"></a>Ansible-vault</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">功能:管理加密解密yml文件</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">[create|decrypt|edit|encrypt|rekey|view]</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">encrypt</span> <span class="string">hello.yml</span> <span class="string">加密</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">decrypt</span> <span class="string">hello.yml</span> <span class="string">解密</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">view</span> <span class="string">hello.yml</span> <span class="string">查看</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">edit</span> <span class="string">hello.yml</span> <span class="string">编辑加密文件</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">rekey</span> <span class="string">hello.yml</span> <span class="string">修改口令</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">create</span> <span class="string">new.yml</span> <span class="string">创建新文件</span></span><br></pre></td></tr></table></figure>

<h5 id="Ansible-console"><a href="#Ansible-console" class="headerlink" title="Ansible-console"></a>Ansible-console</h5><p>Ansible-console:2.0+新增，可交互执行命令，支持tab</p>
<p><code>root@test (2)[f:10] $</code></p>
<p>执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$</p>
<p>设置并发数: forks n 例如: forks 10</p>
<p>切换组: cd 主机组 例如: cd web</p>
<p>列出当前组主机列表: list</p>
<p>列出所有的内置命令: ?或help</p>
<p>示例:    </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@all (2)[f:5]$ list </span><br><span class="line">root@all (2)[f:5]$ cd appsrvs </span><br><span class="line">root@appsrvs (2)[f:5]$ list</span><br><span class="line">root@appsrvs (2)[f:5]$ yum name=httpd state=present </span><br><span class="line">root@appsrvs (2)[f:5]$ service name=httpd state=started</span><br></pre></td></tr></table></figure>

<h5 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h5><p>playbook是由一个或多个”play”组成的列表</p>
<p>play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上来讲，所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可以让它们联同起来按事先编排的机制同唱一台大戏</p>
<p>Playbook采用YAML语言编写</p>
<h4 id="YAML介绍"><a href="#YAML介绍" class="headerlink" title="YAML介绍"></a>YAML介绍</h4><p>YAML是一个可读性高的用来表达资料序列的格式。YAML参考了其他多种语言，包括:XML、C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者</p>
<p>YAML Ain’t Markup Language，即YAML不是XML。不过，在开发的这种语言时，YAML的意思其实是:”Yet Another Markup Language”（仍是一种标记语言）</p>
<p>特性    </p>
<p>YAML的可读性好</p>
<p>YAML和脚本语言的交互性好</p>
<p>YAML使用实现语言的数据类型</p>
<p>YAML有一个一致的信息模型</p>
<p>YAML易于实现</p>
<p>YAML可以基于流来处理</p>
<p>YAML表达能力强，扩展性好</p>
<p>更多的内容及规范参见<a href="http://www.yaml.org" target="_blank" rel="noopener">http://www.yaml.org</a></p>
<h5 id="YAML语法简介"><a href="#YAML语法简介" class="headerlink" title="YAML语法简介"></a>YAML语法简介</h5><p>在单一档案中，可用连续三个连字号(——)区分多个档案。另外，还有选择性的连续三个点号( … )用来表示档案结尾</p>
<p>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</p>
<p>使用#号注释代码</p>
<p>缩进必须是统一的，不能空格和tab混用</p>
<p>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</p>
<p>YAML文件内容是区别大小写的，k/v的值均需大小写敏感</p>
<p>k/v的值可同行写也可换行写。同行使用:分隔</p>
<p>v可是个字符串，也可是另一个列表</p>
<p>一个完整的代码块功能需最少元素需包括 name: task</p>
<p>一个name只能包括一个task</p>
<p>YAML文件扩展名通常为yml或yaml</p>
<p>List:列表，其所有元素均使用”-“打头</p>
<h5 id="示例-1"><a href="#示例-1" class="headerlink" title="示例:"></a>示例:</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">A</span> <span class="string">list</span> <span class="string">of</span> <span class="string">tasty</span> <span class="string">fruits</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Apple</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Orange</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Strawberry</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Mango</span></span><br></pre></td></tr></table></figure>

<p>Dictionary:字典，通常由多个key与value构成</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">An</span> <span class="string">employee</span> <span class="string">record</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Example</span> <span class="string">Developer</span></span><br><span class="line"><span class="attr">job:</span> <span class="string">Developer</span></span><br><span class="line"><span class="attr">skill:</span> <span class="string">Elite</span></span><br></pre></td></tr></table></figure>

<p>也可以将key:value放置于{}中进行表示，用,分隔多个key:value</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">An</span> <span class="string">employee</span> <span class="string">record</span></span><br><span class="line"><span class="string">&#123;name:</span> <span class="string">Example</span> <span class="string">Developer,</span> <span class="attr">job:</span> <span class="string">Developer,</span> <span class="attr">skill:</span> <span class="string">Elite&#125;</span></span><br></pre></td></tr></table></figure>

<p>YAML语法</p>
<p>YAML的语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据结构。其结构（Structure）通过空格来展示，序列（Sequence）里的项用”-“来代表，Map里的键值对用”:”分隔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">John</span> <span class="string">Smith</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">41</span></span><br><span class="line"><span class="attr">gender:</span> <span class="string">Male</span> </span><br><span class="line"><span class="attr">spouse:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">Jane</span> <span class="string">Smith</span></span><br><span class="line">	<span class="attr">age:</span> <span class="number">37</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Female</span> </span><br><span class="line"><span class="attr">children:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Jimmy</span> <span class="string">Smith</span></span><br><span class="line">	<span class="attr">age:</span> <span class="number">17</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Male</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Jenny</span> <span class="string">Smith</span> </span><br><span class="line">	<span class="string">age</span> <span class="number">13</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Female</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h4><p>Hosts  执行的远程主机列表<br>Tasks  任务集<br>Varniables 内置变量或自定义变量在playbook中调用<br>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件<br>Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行<br>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断<br><code>ansible-playbook –t tagsname useradd.yml</code></p>
<h4 id="playbook基础组件"><a href="#playbook基础组件" class="headerlink" title="playbook基础组件"></a>playbook基础组件</h4><p>Hosts:<br>playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中<br>可以是如下形式:<br>​    one.example.com<br>​    one.example.com:two.example.com<br>​    192.168.1.50<br>​    192.168.1.*</p>
<p>Websrvs:dbsrvs   两个组的并集</p>
<p>Websrvs:&amp;dbsrvs   两个组的交集</p>
<p>webservers:!phoenix 在websrvs组，但不在dbsrvs组</p>
<p>示例: - hosts: websrvs:dbsrvs</p>
<p>remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">	<span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">	<span class="string">-name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line"><span class="attr">ping:</span></span><br><span class="line">	<span class="attr">remote_user:</span> <span class="string">markupzh</span></span><br><span class="line">	<span class="attr">sudo:</span> <span class="literal">yes</span>	<span class="string">默认sudo为root</span></span><br><span class="line">	<span class="string">sudo_user:mark</span>	<span class="string">sudo为mark</span></span><br></pre></td></tr></table></figure>

<p>task列表和action<br>play的主体部分是task list。task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后，再开始第二个任务</p>
<p>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</p>
<p>每个task都应该有其name，用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤。如果未提供name，则action的结果将用于输出</p>
<p>playbook基础组件<br>tasks:任务列表</p>
<p>格式:<br>(1) action: module arguments</p>
<p>(2) module: arguments    建议使用</p>
<p>注意:shell和command模块后面跟命令，而非key=value</p>
<p>某任务的状态在运行后为changed时，可通过”notify”通知给相应的 handlers</p>
<p>任务可以通过”tags”打标签，而后可在ansible-playbook命令上使用-t指定进行调用</p>
<p>示例: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">disable</span> <span class="string">selinux</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">/sbin/setenforce</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>如果命令或脚本的退出码不为零，可以使用如下方式替代 </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br></pre></td></tr></table></figure>

<p>或者使用ignore_errors来忽略错误信息:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">/usr/bin/somecommand</span></span><br><span class="line">  <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h4 id="运行playbook"><a href="#运行playbook" class="headerlink" title="运行playbook"></a>运行playbook</h4><p>运行playbook的方式</p>
<p><code>ansible-playbook &lt;filename.yml&gt; ... [options]</code></p>
<p>常见选项</p>
<p>–check 只检测可能会发生的改变，但不真正执行操作</p>
<p>–list-hosts 列出运行任务的主机</p>
<p>–limit 主机列表 只针对主机列表中的主机执行</p>
<p>-v 显示过程 -vv -vvv 更详细</p>
<p>示例</p>
<p><code>ansible-playbook file.yml --check</code> 只检测 </p>
<p><code>ansible-playbook file.yml</code></p>
<p><code>ansible-playbook file.yml --limit websrvs</code></p>
<h4 id="Playbook与ShellScripts相比较"><a href="#Playbook与ShellScripts相比较" class="headerlink" title="Playbook与ShellScripts相比较"></a>Playbook与ShellScripts相比较</h4><p>SHELL脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装Apache</span></span><br><span class="line">yum install --quiet -y httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制配置文件</span></span><br><span class="line">cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf </span><br><span class="line">cp /tmp/vhosts.conf /etc/httpd/conf.d/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动Apache，并设置开机启动 </span></span><br><span class="line">service httpd start </span><br><span class="line">chkconfig httpd on</span><br></pre></td></tr></table></figure>

<p>Playbook定义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span> </span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"安装Apache"</span></span><br><span class="line">  <span class="attr">yum:</span>  <span class="string">name=httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=/tmp/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=/tmp/vhosts.conf</span> <span class="string">dest=/etc/httpd/conf.cd/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"启动Apache，并设置开机启动"</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook示例"><a href="#Playbook示例" class="headerlink" title="Playbook示例"></a>Playbook示例</h4><p>示例:sysuser.yml创建mysql用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">mysql</span> <span class="string">user</span></span><br><span class="line">	<span class="attr">user:</span> <span class="string">name=mysql</span> <span class="string">system=yes</span> <span class="string">uid=36</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">group</span></span><br><span class="line">	<span class="attr">group:</span> <span class="string">name=httpd</span> <span class="string">system=yes</span></span><br></pre></td></tr></table></figure>

<p>示例:httpd.yml安装httpd</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<h4 id="handlers和notify结合使用触发条件"><a href="#handlers和notify结合使用触发条件" class="headerlink" title="handlers和notify结合使用触发条件"></a>handlers和notify结合使用触发条件</h4><p>Handlers</p>
<p>是task列表，这些task与前述的task并没有本质上的不同,用于当关注的资源发生变化时，才会采取一定的操作</p>
<p>Notify此action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作</p>
<h4 id="Playbook中handlers使用"><a href="#Playbook中handlers使用" class="headerlink" title="Playbook中handlers使用"></a>Playbook中handlers使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span> <span class="attr">handlers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">status=restarted</span></span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=/root/config.txt</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">notify:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">Process</span> </span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> <span class="string">enabled=yes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">process</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">killall</span> <span class="number">-0</span> <span class="string">nginx</span> <span class="string">&gt;</span> <span class="string">/tmp/nginx.log</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook中tags使用"><a href="#Playbook中tags使用" class="headerlink" title="Playbook中tags使用"></a>Playbook中tags使用</h4><p>示例:httpd.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">conf</span></span><br><span class="line"></span><br><span class="line"> 	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line"> 	<span class="attr">tags:</span> <span class="string">service</span></span><br><span class="line"> 	<span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line">  <span class="string">ansible-playbook</span> <span class="string">–t</span> <span class="string">conf</span> <span class="string">httpd.yml</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook中变量使用"><a href="#Playbook中变量使用" class="headerlink" title="Playbook中变量使用"></a>Playbook中变量使用</h4><p>变量名:</p>
<p>仅能由字母、数字和下划线组成，且只能以字母开头</p>
<p>变量来源:</p>
<p>1 ansible setup facts 远程主机的所有变量都可直接调用</p>
<p>2 在/etc/ansible/hosts中定义</p>
<p>普通变量:主机组中主机单独定义，优先级高于公共变量公共（组）变量:针对主机组中所有主机定义统一变量</p>
<p>3 通过命令行指定变量，优先级最高</p>
<p>ansible-playbook –e varname=value</p>
<p>4 在playbook中定义<br>  vars:<br>​    -    var1: value1<br>​    -    var2: value2</p>
<p>5 在独立的变量YAML文件中定义</p>
<p>6 在role中定义<br>变量命名<br>变量名仅能由字母、数字和下划线组成，且只能以字母开头</p>
<p>变量定义:key=value<br>示例:http_port=80</p>
<p>变量调用方式:<br>​<br>通过 调用变量，且变量名前后必须有空格，有时用”“才生效</p>
<p>ansible-playbook –e 选项指定<br><code>ansible-playbook test.yml -e &quot;hosts=www user=markupzh&quot;</code></p>
<p>示例:使用setup变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">log</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">name=/var/log/</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_fqdn</span> <span class="string">&#125;&#125;</span> <span class="string">state=touch</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">var.yml</span></span><br></pre></td></tr></table></figure>
<p>示例:变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">–e</span> <span class="string">pkname=httpd</span> <span class="string">var.yml</span></span><br></pre></td></tr></table></figure>

<p>示例:变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">username:</span> <span class="string">user1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">groupname:</span> <span class="string">group1</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">	  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">var.yml</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">-e</span> <span class="string">"username=user2 groupname=group2"</span>  <span class="string">var2.yml</span></span><br></pre></td></tr></table></figure>

<p>主机变量</p>
<p>可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www1.markupzh.com http_port=80 maxRequestsPerChild=808 www2.markupzh.com http_port=8080 maxRequestsPerChild=909</span><br></pre></td></tr></table></figure>

<p>组变量</p>
<p>组变量是指赋予给指定组内所有主机上的在playbook中可用的变量</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www1.markupzh.com</span><br><span class="line">www2.markupzh.com</span><br><span class="line">[websrvs:vars]</span><br><span class="line">ntp_server=ntp.markupzh.com nfs_server=nfs.markupzh.com</span><br></pre></td></tr></table></figure>

<p>普通变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">192.168.99.101 http_port=8080 hname=www1</span><br><span class="line">192.168.99.102 http_port=80   hname=www2</span><br></pre></td></tr></table></figure>

<p>公共（组）变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[websvrs:vars] </span><br><span class="line">http_port=808</span><br><span class="line">mark="_"</span><br><span class="line"></span><br><span class="line">[websrvs]</span><br><span class="line">192.168.99.101 http_port=8080 hname=www1</span><br><span class="line">192.168.99.102 http_port=80 hname=www2</span><br><span class="line"></span><br><span class="line">ansible websvrs –m hostname –a 'name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;'</span><br></pre></td></tr></table></figure>

<p>命令行指定变量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible websvrs –e http_port&#x3D;8000 –m hostname –a &#39;name&#x3D;&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>使用变量文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat vars.yml </span><br><span class="line"></span><br><span class="line">var1: httpd </span><br><span class="line">var2: nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat var.yml</span><br><span class="line"></span><br><span class="line">- hosts: web</span><br><span class="line">  remote_user: root </span><br><span class="line">  vars_files:</span><br><span class="line">    - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create httpd log</span><br><span class="line">    file: name=/app/&#123;&#123; var1 &#125;&#125;.log state=touch</span><br><span class="line">    - name: create nginx log</span><br><span class="line">    file: name=/app/&#123;&#123; var2 &#125;&#125;.log state=touch</span><br></pre></td></tr></table></figure>

<p>模板templates</p>
<p>文本文件，嵌套有脚本（使用模板编程语言编写）</p>
<p>Jinja2语言，使用字面量，有下面形式字符串:使用单引号或双引号</p>
<p>数字:整数，浮点数</p>
<p>列表:[item1, item2, …]</p>
<p>元组:(item1, item2, …)</p>
<p>字典:{key1:value1, key2:value2, …}</p>
<p>布尔型:true/false</p>
<p>算术运算:+, -, <em>, /, //, %, *</em></p>
<p>比较操作:==, !=, &gt;, &gt;=, &lt;, &lt;=</p>
<p>逻辑运算:and, or, not</p>
<p>流表达式:For If When</p>
<h4 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h4><p>templates功能:根据模块文件动态生成对应的配置文件</p>
<p>templates文件必须存放于templates目录下，且命名为 .j2 结尾</p>
<p>yaml/yml 文件需和templates目录平级，目录结构如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">├── temnginx.yml</span><br><span class="line">└── templates</span><br><span class="line">	  └── nginx.conf.j2</span><br></pre></td></tr></table></figure>

<h4 id="Templates示例"><a href="#Templates示例" class="headerlink" title="Templates示例"></a>Templates示例</h4><p>示例:利用templates 同步nginx配置文件准备templates/nginx.conf.j2文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim temnginx.yml</span><br><span class="line"></span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: template config to remote hosts</span><br><span class="line">	 template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">ansible-playbook temnginx.yml</span><br></pre></td></tr></table></figure>

<h4 id="Playbook中template变更替换"><a href="#Playbook中template变更替换" class="headerlink" title="Playbook中template变更替换"></a>Playbook中template变更替换</h4><p>修改文件nginx.conf.j2 下面行为</p>
<p><code>worker_processes ;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat temnginx2.yml</span><br><span class="line"></span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">	- name: template config to remote hosts</span><br><span class="line">	template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">ansible-playbook temnginx2.yml</span><br></pre></td></tr></table></figure>

<h4 id="Playbook中template算术运算"><a href="#Playbook中template算术运算" class="headerlink" title="Playbook中template算术运算"></a>Playbook中template算术运算</h4><p>算法运算:</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf.j2</span><br><span class="line"></span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;; </span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus+2 &#125;&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="when"><a href="#when" class="headerlink" title="when"></a>when</h4><p>条件测试:如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,通过when语句实现，在task中使用，jinja2的语法格式</p>
<p>when语句</p>
<p>在task后添加when子句即可使用条件测试；when语句支持Jinja2表达式语法</p>
<p>示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"shutdown RedHat flavored systems"</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">/sbin/shutdown</span> <span class="string">-h</span> <span class="string">now</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br></pre></td></tr></table></figure>

<p>示例:when条件判断</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br></pre></td></tr></table></figure>

<p>示例:when条件判断</p>
<p>示例: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos7</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=nginx.conf.c7.j2</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos6</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=nginx.conf.c6.j2</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br></pre></td></tr></table></figure>

<p>迭代:with_items</p>
<p>迭代:当有需要重复性执行的任务时，可以使用迭代机制</p>
<p>对迭代项的引用，固定变量名为”item”</p>
<p>要在task中使用with_items给定要迭代的元素列表</p>
<p>列表格式:</p>
<p>字符串</p>
<p>字典</p>
<p>示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="string">groups=wheel</span> </span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">testuser1</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">testuser2</span></span><br></pre></td></tr></table></figure>

<p>上面语句的功能等同于下面的语句:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser1</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=testuser1</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser2</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=testuser2</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<p>将多个文件进行copy到被控端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">testsrv</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="string">tasks</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">rsyncd</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/etc/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsyncd.secrets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsyncd.conf</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">file</span></span><br><span class="line">	  <span class="attr">copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/tmp/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file1</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file2</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file3</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">apr</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">apr-util</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">httpd</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts:websrvs</span> </span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="string">tasks</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">some</span> <span class="string">packages</span></span><br><span class="line">	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">memcached</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">php-fpm</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代嵌套子变量</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts:websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group3</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span></span><br><span class="line">	  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="attr">with_items:</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user1'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group1'</span> <span class="string">&#125;</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user2'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group2'</span> <span class="string">&#125;</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user3'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group3'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h4><p>ansilbe自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中</p>
<p>复杂场景:建议使用roles，代码复用度高</p>
<p>变更指定主机或主机组</p>
<p>如命名不规范维护和传承成本大</p>
<p>某些功能需多个Playbook，通过Includes即可实现</p>
<p>角色(roles):角色集合 </p>
<p>roles/</p>
<p>  mysql/</p>
<p>  httpd/</p>
<p>  nginx/</p>
<p>  memcached/</p>
<h4 id="roles目录结构"><a href="#roles目录结构" class="headerlink" title="roles目录结构"></a>roles目录结构</h4><p>每个角色，以特定的层级目录结构进行组织</p>
<p>roles目录结构: </p>
<p>playbook.yml </p>
<p>  roles/<br>​     project/<br>​     tasks/<br>​     files/<br>​     vars/<br>​     templates/<br>​     handlers/<br>​     default/  不常用<br>​     meta/    不常用</p>
<p>Roles各目录作用:</p>
<pre><code>/roles/project/ :项目名称,有以下子目录

files/ :存放由copy或script模块等调用的文件

templates/:template模块查找所需要模板文件的目录

tasks/:定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

handlers/:至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

vars/:定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

meta/:定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含

default/:设定默认变量时使用此目录中的main.yml文件</code></pre><p>创建role:</p>
<pre><code>创建role的步骤

(1) 创建以roles命名的目录

(2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等

(3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；用不到的目录可以创建为空目录，也可以不创建

(4) 在playbook文件中，调用各角色</code></pre><h4 id="playbook调用角色"><a href="#playbook调用角色" class="headerlink" title="playbook调用角色"></a>playbook调用角色</h4><p>调用角色方法1:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">memcached</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>调用角色方法2:传递变量给角色</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="attr">remote_user:</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>键role用于指定角色名称</p>
<p>后续的k/v用于传递变量给角色</p>
<p>调用角色方法3:还可基于条件测试实现角色调用 roles:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx,</span> <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">'7'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="推荐资料"><a href="#推荐资料" class="headerlink" title="推荐资料"></a>推荐资料</h4><pre><code>http://galaxy.ansible.com
https://galaxy.ansible.com/explore#/
http://github.com/
http://ansible.com.cn/
https://github.com/ansible/ansible
https://github.com/ansible/ansible-examples</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E9%85%8D%E7%BD%AELinux%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4SSH%E4%BA%92%E4%BF%A1%E8%BF%9E%E6%8E%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E9%85%8D%E7%BD%AELinux%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4SSH%E4%BA%92%E4%BF%A1%E8%BF%9E%E6%8E%A5/" class="post-title-link" itemprop="url">配置Linux主机之间SSH互信连接</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-12-05 15:16:37 / 修改时间：15:37:11" itemprop="dateCreated datePublished" datetime="2018-12-05T15:16:37+08:00">2018-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>无论在本地搭建实验环境还是在生产环境中,多节点并行计算设置中,建立Linux主机间的SSH互信是非常重要的环节.常见的互信机制包括RSH和SSH两种,其中SSH互信较常用到,下面介绍SSH的原理及其配置方法.</p>
<p>首先,我们先了解下配置ssh互信的原理,ssh互信,说白了,就是在目标机器上,预先设置好经过认证的key文件,当需要访问目标机器时,目标机器通过key文件,对访问者进行自动认证,从而实现互信.</p>
<p>了解了ssh互信的原理,我们把配置ssh互信的步骤,进行有效的分割:</p>
<p>1.首先,在要配置互信的机器上,生成各自的经过认证的key文件;</p>
<p>2.其次,将所有的key文件汇总到一个总的认证文件中;</p>
<p>3.将这个包含了所有互信机器认证key的认证文件,分发到各个机器中去;</p>
<p>4.验证互信;</p>
<p>实例演示:CentOS 7.5系统的两台电脑,IP分别为192.168.0.100和192.168.0.101,主机名(hostname)分别为node0和node1,默认都已安装SSH服务,要实现两个名称相同的账号root间的互信连接.</p>
<p>备注:主机名可以通过root用户修改/etc/sysconfig/network中的hostname变量名,重启设定生效,而hostname命令只修改当前显示的主机名,重启后即失效. </p>
<p>1.节点node1上,以root身份修改/etc/hosts文件,以建立主机IP和主机名(hostname)间的映射,其文件格式如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Do not remove the following line, or various programs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that require network functionality will fail.</span></span><br><span class="line">127.0.0.1       localhost.localdomain localhost</span><br><span class="line">::1             localhost6.localdomain6 localhost6</span><br><span class="line">192.168.100.100 node1.localdomain     node1</span><br><span class="line">192.168.100.101 node2.localdomain     node2</span><br></pre></td></tr></table></figure>

<p>IP hostname.domainname hostname,其中各项以Tab键隔开.</p>
<p>注意:修改该文件不是必须步骤,但方便以后用主机名直接访问各主机,省去了输入IP地址的麻烦.在节点node2上进行相同操作.</p>
<p> 2.用户root身份,在node1上生成认证RSA密钥(这里有个细节,就是ssh互信的认证文件,需要放在用户的home目录下的.ssh目录中,因此我们要首先建立这个目录,并且保证这个目录的权限是700):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir .ssh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chmod 700 .ssh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh-keygen -t rsa</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/home/deven/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in /home/deven/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /home/deven/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">89:56:d6:4a:b2:6c:4a:05:86:ae:cd:7d:80:dd:3c:f1 deven@node1</span><br></pre></td></tr></table></figure>

<p>中间过程直接3个回车.在~/.ssh/目录下,生成了两个文件:id_rsa(私钥文件放在本地) 和 id_rsa.pub(公钥文件放在信任服务器).</p>
<p>在node2上,以用户root身份进行相同操作.</p>
<p>3.将所有的公钥文件 id_rsa.pub汇总到一个总的认证文件authorized-keys中:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh root@node2 cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span></span><br></pre></td></tr></table></figure>

<p>4.经过1,2两步,目前node1上存在一份完整的认证key文件,这时候,把她拷到node2主机的对应目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> scp ~/.ssh/authorized_keys root@node2:~/.ssh/authorized_keys</span></span><br></pre></td></tr></table></figure>

<p>5.大功告成,这时候,再互相用ssh命令连接,看看是否配置成功.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/vmware-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%89%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F-%E6%A1%A5%E6%8E%A5-NAT-%E4%BB%85%E4%B8%BB%E6%9C%BA%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/vmware-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%89%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F-%E6%A1%A5%E6%8E%A5-NAT-%E4%BB%85%E4%B8%BB%E6%9C%BA%E5%8C%BA%E5%88%AB/" class="post-title-link" itemprop="url">vmware 虚拟机三种网络模式 桥接 NAT 仅主机</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-04 14:58:37" itemprop="dateCreated datePublished" datetime="2018-12-04T14:58:37+08:00">2018-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-12-05 12:18:12" itemprop="dateModified" datetime="2018-12-05T12:18:12+08:00">2018-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>vmware为我们提供了3种网络工作模式,分别是:Bridge(桥接模式),NAT(网络地址转换模式),Host-Only(仅主机模式).</p>
<p>首先在说到VMware的网络模型前,先说一下VMware的几个虚拟设备:</p>
<p>VMnet0:这是VMware用于虚拟机桥接网络下的虚拟交换机</p>
<p>VMnet1:这是VMware用于Host-Only网络下的虚拟交换机</p>
<p>VMnet8:这是VMware用于虚拟NAT网络下的虚拟交换机</p>
<p>VMware Network Adapter VMnet1:这是Host用于Host-Only虚拟网络进行通信的虚拟网卡</p>
<p>VMware Network Adapter VMnet8:这是Host用于NAT虚拟网络进行通信的虚拟网卡</p>
<p>那么如何查看这些网卡的信息呢?</p>
<p>在windows主机命令行提示符环境中输入 ipconfig 便可以查询到VMware Network Adapter VMnet1,VMware Network Adapter VMnet8的ip地址.</p>
<h4 id="Bridge-桥接模式"><a href="#Bridge-桥接模式" class="headerlink" title="Bridge(桥接模式)"></a>Bridge(桥接模式)</h4><p>桥接模式就是将主机网卡与虚拟机网卡利用虚拟网桥进行通信,在桥接的作用下,类似把主机虚拟为一个交换机,所有桥接设置的虚拟机连接到这个交换机的一个接口上,物理主机也同样连接到这个交换机中,所以所有桥接下的网卡与网卡都是交换模式的,相互可以访问而不干扰,在桥接模式下,虚拟机的ip地址需要与主机在同一个网段,如果需要联网,则网关与DNS需要与主机网卡一致.</p>
<p>在桥接模式下,VMware虚拟出来的操作系统就像是局域网中的一台独立的主机,它可以访问该类网段内任何一台机器.</p>
<p>桥接网络环境下需要做到:</p>
<p>1.手动为虚拟机系统配置ip地址,子网掩码</p>
<p>2.在桥接的模式下虚拟机必须与物理机处于同一网段,(举个例子,物理机ip:192.168.1.2 虚拟机ip:192.168.1.3)这样虚拟系统才能和真实主机进行通信.</p>
<p>当我们想利用VMware在局域网内新建一个虚拟服务器,为局域网用户提供网络服务,就应该选择桥接模式,便可将虚拟机模拟接入主机所在的局域网,桥接网络相当于虚拟机与主机在一台交换机上,同时上网,虚拟机对物理机的直接影响较小.</p>
<p>但是桥接模式也有一定的问题,如果网络环境很缺少,或者对ip的管理比较严格的话,那桥接模式就不太适用了.如果解决这个问题就引入了vmware的另一种网络模式:NAT模式</p>
<h4 id="NAT-地址转换模式"><a href="#NAT-地址转换模式" class="headerlink" title="NAT(地址转换模式)"></a>NAT(地址转换模式)</h4><p>在NAT网络中,会使用到VMnet8虚拟交换机,物理机上的VMware Network Adapter VMnet8 虚拟网卡将会和VMnet8交换机相连,来实现物理机与虚拟机之间的通信.</p>
<p>注意:VMware Network Adapter VMnet8虚拟网卡仅仅是用于和VMnet8网段通信用的,它并不为VMnet8网段提供路由功能,处于虚拟NAT网络下的Guest是使用虚拟的NAT服务器连接的Internet的.</p>
<p>VMware Network Adapter VMnet8 虚拟网卡它仅仅是为Host和NAT虚拟网络下的Guest通信提供一个接口,所以,即便去掉这块网卡,虚拟机仍然是可以上网的,只是物理机无法再访问到VMnet8网段而已.</p>
<p>1.主机需要开启vmdhcp和vmnat服务.</p>
<p>2.NAT模式下的虚拟机的TCP/IP配置信息将由VMnet8(NAT)虚拟网络的DHCP服务器自动分配,需要开启DHCP功能.</p>
<p>使用NAT模式,就是让虚拟系统借助NAT功能,通过物理机所在的网络来访问外网,也就是说,使用NAT模式可以实现在虚拟机里访问到互联网,NAT模式下的虚拟机的TCP/IP配置信息是由VMnet8(NAT)虚拟网络的DHCP服务器提供的,无法进行手动修改,因此虚拟系统也就无法和本局域网中的其他真实主机进行通讯,采用NAT模式最大的优势就是虚拟系统接入互联网非常简单,不需要进行任何其他的配置,只需要宿主机能访问互联网即可.</p>
<p>NAT模式下的网络,相当于说虚拟机是通过物理机连接上的网络,等于物理机是个路由器,申请到一个上网的名额,带着隐藏在它下下面的虚拟机上网,自然所有的虚拟机使用的网络总和都限制在实体机的一个网络通道内,虚拟机会抢占物理机的网络,对物理机上网会有很大的影响.</p>
<h4 id="Host-Only-仅主机模式"><a href="#Host-Only-仅主机模式" class="headerlink" title="Host-Only(仅主机模式)"></a>Host-Only(仅主机模式)</h4><p>Host-Only模式其实就是NAT模式去除了虚拟NAT设备,然后使用VMware Network Adapter VMnet1 虚拟网卡连接VMnet1虚拟交换机来与虚拟机通信的,Host-Only模式将虚拟机与外网隔开,是虚拟机成为一个独立的系统,只与主机相互通讯.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96-%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96-%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2-%E4%BA%8C/" class="post-title-link" itemprop="url">运维自动化-系统部署(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-09-20 20:38:21 / 修改时间：20:46:57" itemprop="dateCreated datePublished" datetime="2018-09-20T20:38:21+08:00">2018-09-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="使用cobbler"><a href="#使用cobbler" class="headerlink" title="使用cobbler"></a>使用cobbler</h3><p>Cobbler:<br>    快速网络安装linux操作系统的服务，支持众多的Linux发行版：Red Hat、Fedora、CentOS、Debian、Ubuntu和SuSE，也可以支持网络安装windows<br>    PXE的二次封装，将多种安装参数封装到一个菜单<br>    Python编写<br>    提供了CLI和Web的管理形式</p>
<h4 id="cobbler-工作流程"><a href="#cobbler-工作流程" class="headerlink" title="cobbler 工作流程"></a>cobbler 工作流程</h4><pre><code>client裸机配置了从网络启动后，开机后会广播包请求DHCP服务器（cobbler server）发送其分配好的一个IP
DHCP服务器（cobbler server）收到请求后发送responese，包括其ip地址
client裸机拿到ip后再向cobbler server发送请求OS引导文件的请求
cobbler server告诉裸机OS引导文件的名字和TFTP server的ip和port
client裸机通过上面告知的TFTP server地址通信，下载引导文件
client裸机执行执行该引导文件，确定加载信息，选择要安装的os，期间会再向 cobbler server请求kickstart文件和os image
cobbler server发送请求的kickstart和os iamge
client裸机加载kickstart文件
client裸机接收os image，安装该os image</code></pre><h4 id="cobbler-介绍"><a href="#cobbler-介绍" class="headerlink" title="cobbler 介绍"></a>cobbler 介绍</h4><p>安装包<br>    cobbler 基于EPEL源<br>cobbler 服务集成<br>    PXE<br>    DHCP<br>    rsync<br>    Http<br>    DNS<br>    Kickstart<br>    IPMI 电源管理<br>检查cobbler环境<br>    cobbler check</p>
<p>cobbler 相关术语<br>    发行版：<br>        表示一个操作系统版本，它承载了内核和 initrd 的信息，以及内核参数等其他数据<br>    配置文件：<br>        包含一个发行版、一个 kickstart 文件以及可能的存储库，还包含更多特定的内核参数等其他数据<br>    系统：<br>        表示要配置的主机，它包含一个配置文件或一个镜像，还包含 IP 和 MAC 地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息<br>    存储库：<br>        保存一个 yum 或 rsync 存储库的镜像信息</p>
<h4 id="cobbler-各种配置目录说明"><a href="#cobbler-各种配置目录说明" class="headerlink" title="cobbler 各种配置目录说明"></a>cobbler 各种配置目录说明</h4><pre><code>安装：yum install cobbler dhcp
配置文件目录 /etc/cobbler
    /etc/cobbler/settings : cobbler 主配置文件
    /etc/cobbler/iso/: iso模板配置文件
    /etc/cobbler/pxe: pxe模板文件
    /etc/cobbler/power: 电源配置文件
    /etc/cobbler/user.conf: web服务授权配置文件
    /etc/cobbler/users.digest: web访问的用户名密码配置文件
    /etc/cobbler/dhcp.template : dhcp服务器的的配置末班
    /etc/cobbler/dnsmasq.template : dns服务器的配置模板
    /etc/cobbler/tftpd.template : tftp服务的配置模板
    /etc/cobbler/modules.conf : 模块的配置文件</code></pre><h4 id="cobbler-目录介绍"><a href="#cobbler-目录介绍" class="headerlink" title="cobbler 目录介绍"></a>cobbler 目录介绍</h4><p>数据目录<br>    /var/lib/cobbler/config/: 用于存放distros，system，profiles 等信息配置文件<br>    /var/lib/cobbler/triggers/: 用于存放用户定义的cobbler命令<br>    /var/lib/cobbler/kickstart/: 默认存放kickstart文件<br>    /var/lib/cobbler/loaders/: 存放各种引导程序</p>
<p>镜像目录<br>    /var/www/cobbler/ks_mirror/: 导入的发行版系统的所有数据<br>    /var/www/cobbler/images/ : 导入发行版的kernel和initrd镜像用于远程网络启动<br>    /var/www/cobbler/repo_mirror/: yum 仓库存储目录</p>
<p>日志目录<br>    /var/log/cobbler/installing: 客户端安装日志<br>    /var/log/cobbler/cobbler.log : cobbler日志</p>
<h4 id="cobbler-命令介绍"><a href="#cobbler-命令介绍" class="headerlink" title="cobbler 命令介绍"></a>cobbler 命令介绍</h4><p>cobbler check 核对当前设置是否有问题<br>cobbler list 列出所有的cobbler元素<br>cobbler report 列出元素的详细信息<br>cobbler sync 同步配置到数据目录,更改配置最好都要执行下<br>cobbler reposync 同步yum仓库<br>cobbler distro 查看导入的发行版系统信息<br>cobbler system 查看添加的系统信息<br>cobbler profile 查看配置信息</p>
<h4 id="cobbler-重要的参数"><a href="#cobbler-重要的参数" class="headerlink" title="cobbler 重要的参数"></a>cobbler 重要的参数</h4><pre><code>/etc/cobbler/settings中重要的参数设置
default_password_crypted: &quot;$1$gEc7ilpP$pg5iSOj/mlxTxEslhRvyp/&quot;
manage_dhcp：1
manage_tftpd：1
pxe_just_once：1
next_server：&lt; tftp服务器的 IP 地址&gt;
server：&lt;cobbler服务器的 IP 地址&gt;</code></pre><h4 id="cobbler-环境检查"><a href="#cobbler-环境检查" class="headerlink" title="cobbler 环境检查"></a>cobbler 环境检查</h4><p>执行Cobbler check命令会报如下异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1 : The ‘server’ field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than localhost, or kickstarting features will not work. This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the ‘next_server’ field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.</span><br><span class="line">3 : some network boot-loaders are missing from &#x2F;var&#x2F;lib&#x2F;cobbler&#x2F;loaders, you may run ‘cobbler get-loaders’ to download them, or, if you only want to handle x86&#x2F;x86_64 netbooting, you may ensure that you have installed a recent version of the syslinux package installed and can ignore this message entirely. Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The ‘cobbler get-loaders’ command is the easiest way to resolve these requirements.</span><br><span class="line">4 : change ‘disable’ to ‘no’ in &#x2F;etc&#x2F;xinetd.d&#x2F;rsync</span><br><span class="line">5 : comment ‘dists’ on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">6 : comment ‘arches’ on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">7 : The default password used by the sample templates for newly installed machines (default_password_crypted in &#x2F;etc&#x2F;cobbler&#x2F;settings)</span><br><span class="line">is still set to ‘cobbler’ and should be changed, try: “openssl passwd -1 -salt ‘random-phrase-here’ ‘your-password-here’” to generate new one</span><br><span class="line">8 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br></pre></td></tr></table></figure>



<h4 id="cobbler-报错解决"><a href="#cobbler-报错解决" class="headerlink" title="cobbler 报错解决"></a>cobbler 报错解决</h4><pre><code>执行Cobbler check报错解决方式
修改/etc/cobbler/settings文件中的server参数的值为提供cobbler服务的主机相应的IP地址或主机名
修改/etc/cobbler/settings文件中的next_server参数的值为提供PXE服务的主机相应的IP地址
如果当前节点可以访问互联网，执行“cobbler get-loaders”命令即可；否则，需要安装syslinux程序包，而后复制/usr/share/syslinux/{pxelinux.0,memu.c32}等文件至/var/lib/cobbler/loaders/目录中
执行“chkconfig rsync on”命令即可
执行“openssl passwd -1 生成密码，并用其替换/etc/cobbler/settings文件中default_password_crypted参数的值</code></pre><h4 id="cobbler-相关管理"><a href="#cobbler-相关管理" class="headerlink" title="cobbler 相关管理"></a>cobbler 相关管理</h4><pre><code>下载启动菜单：
    联网：cobbler get-loaders
    不联网：cp /usr/share/syslinux/{pxelinux.0,menu.c32}  /var/lib/tftpboot

管理distro
    cobbler import --name=centos-7.5-x86_64 --path=/media/cdrom --arch=x86_64

管理profile
    cobbler profile add --name=centos-7.5-x86_64-basic --distro=centos-7.5-x86_64 --kickstart= /var/lib/cobbler/kickstarts/centos7_x86_64.cfg</code></pre><h4 id="cobbler-命令"><a href="#cobbler-命令" class="headerlink" title="cobbler 命令"></a>cobbler 命令</h4><pre><code>查看profiles
    cobbler profile list
查看引导文件
    cat /var/lib/tftpboot/pxelinux.cfg/default
同步cobbler配置
    cobbler sync
多系统引导方案
    cobbler import --name=CentOS-7-x86_64 --path=/media/cdrom 
    cobbler distro list
    cobbler profile list 
    cobbler sync</code></pre><h4 id="cobbler-实现步骤"><a href="#cobbler-实现步骤" class="headerlink" title="cobbler 实现步骤"></a>cobbler 实现步骤</h4><pre><code>安装包，并设置服务
检查配置
根据上面提示修改配置
下载启动相关文件菜单
配置DHCP服务
分别导入centos的安装源,并查看
准备kickstart文件并导入cobbler
测试</code></pre><h4 id="cobbler的web管理实现"><a href="#cobbler的web管理实现" class="headerlink" title="cobbler的web管理实现"></a>cobbler的web管理实现</h4><p>cobbler-web</p>
<pre><code>提供cobbler的基于web管理界面，epel源 yum install cobbler-web

认证方式
    认证方法配置文件：/etc/cobbler/modules.conf
    支持多种认证方法：
        authn_configfile
        authn_pam</code></pre><p>  使用authn_configfile模块认证cobbler_web用户<br>        vim /etc/cobbler/modules.conf<br>        [authentication]<br>        module=authn_configfile</p>
<p>创建其认证文件/etc/cobbler/users.digest，并添加所需的用户 htdigest -c /etc/cobbler/users.digest Cobbler admin<br>注意:添加第一个用户时,使用“-c”选项，后续添加其他用户时不要再使用，cobbler_web的realm只能为Cobbler</p>
<pre><code>使用authn_pam模块认证cobbler_web用户
    vim /etc/cobbler/modules.conf 
    [authentication]
    module = authn_pam
创建cobbler用户：useradd cobbler
    vim /etc/cobbler/users.conf
    [admins]
    admin = &quot;cobbler“

Web访问cobbler
    重启cobblerd服务
    通过https://cobblerserver/cobbler_web访问</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96-%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2-%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96-%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2-%E4%B8%80/" class="post-title-link" itemprop="url">运维自动化-系统部署(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-09-20 19:35:31 / 修改时间：20:46:52" itemprop="dateCreated datePublished" datetime="2018-09-20T19:35:31+08:00">2018-09-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安装Linux系统"><a href="#安装Linux系统" class="headerlink" title="安装Linux系统"></a>安装Linux系统</h3><p>CentOS系统安装系统启动流程：<br>    bootloader–&gt;kernel(initramfs)–&gt;rootfs–&gt;/sbin/init</p>
<p>anaconda: 系统安装程序<br>    gui：图形窗口<br>    tui: 基于图形库curses的文本窗口</p>
<h4 id="安装程序启动过程"><a href="#安装程序启动过程" class="headerlink" title="安装程序启动过程"></a>安装程序启动过程</h4><p>MBR：isolinux/boot.cat<br>stage2: isolinux/isolinux.bin<br>配置文件：isolinux/isolinux.cfg<br>    每个对应的菜单选项：<br>        加载内核：isolinuz/vmlinuz<br>        向内核传递参数：append initrd=initrd.img …<br>装载根文件系统，并启动anaconda<br>    默认启动GUI接口<br>    若是显式指定使用TUI接口：向内核传递text参数即可<br>    (1)按tab键,在后面增加text<br>    (2)按ESC键：boot: linux text</p>
<h3 id="anaconda工作过程"><a href="#anaconda工作过程" class="headerlink" title="anaconda工作过程"></a>anaconda工作过程</h3><p>Anaconda安装系统分成三个阶段：<br><strong>安装前配置阶段</strong><br>    安装过程使用的语言键盘类型<br>    安装目标存储设备<br>        Basic Storage：本地磁盘<br>        特殊设备：iSCSI<br>    设定主机名<br>    配置网络接口时区<br>    管理员密码<br>    设定分区方式及MBR的安装位置<br>    创建一个普通用户<br>    选定要安装的程序包</p>
<p><strong>安装阶段</strong><br>    在目标磁盘创建分区，执行格式化操作等<br>    将选定的程序包安装至目标位置<br>    安装bootloader和initramfs</p>
<p><strong>图形模式首次启动</strong><br>    iptables<br>    selinux<br>    core dump</p>
<h4 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h4><p>启动安装过程一般应位于引导设备；后续的anaconda及其安装用到的程序包等可来自下面几种方式:<br>    本地光盘<br>    本地硬盘<br>    NFS<br>    URL:<br>        ftp server: yum repository<br>        http server: yum repostory<br>如果想手动指定安装源：<br>    boot: linux askmethod</p>
<h4 id="指定安装源"><a href="#指定安装源" class="headerlink" title="指定安装源"></a>指定安装源</h4><p><strong>centos6</strong><br>    DVD drive        repo=cdrom :device<br>    Hard Drive        repo=hd:device/path<br>    HTTP Server        repo=<a href="http://host/path" target="_blank" rel="noopener">http://host/path</a><br>    HTTPS Server    repo=<a href="https://host/path" target="_blank" rel="noopener">https://host/path</a><br>    FTP Server        repo=<a href="ftp://username:password@">ftp://username:password@</a> host/path<br>    NFS Server        repo=nfs:server:/path<br>    ISO images on an NFS Server repo=nfsiso:server:/path</p>
<p><strong>centos7</strong><br>    Any CD/DVD drive    inst.repo=cdrom<br>    Hard Drive            inst.repo=hd:device:/path<br>    HTTP Server            inst.repo=<a href="http://host/path" target="_blank" rel="noopener">http://host/path</a><br>    HTTPS Server        inst.repo=<a href="https://host/path" target="_blank" rel="noopener">https://host/path</a><br>    FTP Server            inst.repo=<a href="ftp://username:password@">ftp://username:password@</a> host/path<br>    NFS Server            inst.repo=nfs:[options:]server:/path</p>
<h4 id="系统安装-1"><a href="#系统安装-1" class="headerlink" title="系统安装"></a>系统安装</h4><p>anaconda的配置方式：<br>    (1)    交互式配置方式<br>    (2)    通过读取事先给定的配置文件自动完成配置按特定语法给出的配置选项kickstart文件</p>
<p>安装boot引导选项：boot:<br>    text: 文本安装方式<br>    askmethod: 手动指定使用的安装方法</p>
<p>与网络相关的引导选项：<br>ip=IPADDR<br>netmask=MASK<br>gateway=GW<br>dns=DNS_SERVER_IP<br>ifname=NAME:MAC_ADDR    </p>
<p>与远程访问功能相关的引导选项：<br>    vnc<br>    vncpassword=’PASSWORD’</p>
<p>指明kickstart文件的位置： ks=<br>    DVD drive: ks=cdrom:/PATH/TO/KICKSTART_FILE<br>    Hard drive: ks=hd:device:/directory/KICKSTART_FILE<br>    HTTP server: ks=<a href="http://host:port/path/to/KICKSTART_FILE">http://host:port/path/to/KICKSTART_FILE</a><br>    FTP server: ks=<a href="ftp://host:port/path/to/KICKSTART_FILE">ftp://host:port/path/to/KICKSTART_FILE</a><br>    HTTPS server: ks=<a href="https://host:port/path/to/KICKSTART_FILE">https://host:port/path/to/KICKSTART_FILE</a><br>    NFS server:ks=nfs:host:/path/to/KICKSTART_FILE</p>
<p>启动紧急救援模式：<br>    rescue</p>
<p>官方文档：《Installation Guide》</p>
<h4 id="kickstart文件的格式"><a href="#kickstart文件的格式" class="headerlink" title="kickstart文件的格式"></a>kickstart文件的格式</h4><p>命令段：指明各种安装前配置，如键盘类型等<br>程序包段：指明要安装的程序包组或程序包，不安装的程序包等<br>    %packages<br>    @group_name<br>    package<br>    -package<br>    %end</p>
<p>脚本段：<br>%pre: 安装前脚本<br>    运行环境：运行于安装介质上的微型Linux环境</p>
<p>%post: 安装后脚本<br>    运行环境：安装完成的系统</p>
<p>命令段中的命令：<br>必备命令<br>    authconfig: 认证方式配置<br>        authconfig –useshadow –passalgo=sha512<br>    bootloader：bootloader的安装位置及相关配置<br>        bootloader –location=mbr –driveorder=sda – append=”crashkernel=auto rhgb quiet”<br>    keyboard: 设定键盘类型<br>    lang: 语言类型<br>    part: 创建分区<br>    rootpw: 指明root的密码<br>    timezone: 时区</p>
<p>可选命令<br>    install OR upgrade<br>    text: 文本安装界面<br>    network<br>    firewall<br>    selinux<br>    halt<br>    poweroff<br>    reboot<br>    repo<br>    user：安装完成后为系统创建新用户<br>    url: 指明安装源<br>    key –skip 跳过安装号码,适用于rhel版本</p>
<p>创建kickstart文件的方式<br>    直接手动编辑<br>        依据某模板修改<br>    可使用创建工具：system-config-kickstart<br>        依据某模板修改并生成新配置<br>        /root/anaconda-ks.cfg<br>    检查ks文件的语法错误：ksvalidator<br>        ksvalidator /PATH/TO/KICKSTART_FILE</p>
<p>系统光盘中isolinux目录列表<br>    solinux.bin：光盘引导程序，在mkisofs的选项中需要明确给出文件路径，这个文件属于SYSLINUX项目<br>    isolinux.cfg：isolinux.bin的配置文件，当光盘启动后（即运行isolinux.bin），会自动去找isolinux.cfg文件<br>    vesamenu.c32：是光盘启动后的安装图形界面，也属于SYSLINUX项目，menu.c32版本是纯文本的菜单<br>    Memtest：内存检测，这是一个独立的程序<br>    splash.jgp：光盘启动界面的背景图<br>    vmlinuz是内核映像<br>    initrd.img是ramfs (先cpio，再gzip压缩)</p>
<h4 id="制作引导光盘和U盘"><a href="#制作引导光盘和U盘" class="headerlink" title="制作引导光盘和U盘"></a>制作引导光盘和U盘</h4><p>创建引导光盘：<br>    mkdir –pv /app/myiso<br>    cp -r /misc/cd/isolinux/ /app/myiso/<br>    vim /app/myiso/isolinux/isolinux.cfg initrd=initrd.img text ks=cdrom:/myks.cfg<br>    cp /root/myks.cfg /app/myiso/<br>    mkisofs -R -J -T -v –no-emul-boot –boot-load-size 4 –boot-info-table -V “CentOS 6.9 x86_64 boot” -b isolinux/isolinux.bin -c isolinux/boot.cat -o /root/boot.iso /app/myiso/<br>    注意：以上相对路径都是相对于光盘的根，和工作目录无关</p>
<p>创建U盘启动盘<br>    dd if=/dev/sr0 of=/dev/sdb</p>
<h5 id="mkisofs选项"><a href="#mkisofs选项" class="headerlink" title="mkisofs选项"></a>mkisofs选项</h5><pre><code>-o 指定映像文件的名称。
-b 指定在制作可开机光盘时所需的开机映像文件。
-c 制作可开机光盘时，会将开机映像文件中的 no-eltorito-catalog 全部内容作成一个文件。
-no-emul-boot 非模拟模式启动。
-boot-load-size 4 设置载入部分的数量
-boot-info-table 在启动的图像中现实信息
-R 或 -rock   使用 Rock RidgeExtensions
-J 或 -joliet   使用 Joliet 格式的目录与文件名称
-v 或 -verbose   执行时显示详细的信息
-T 或 -translation-table 建立文件名的转换表，适用于不支持 Rock Ridge Extensions 的系统上</code></pre><h3 id="DHCP服务"><a href="#DHCP服务" class="headerlink" title="DHCP服务"></a>DHCP服务</h3><p>网络配置<br>    静态指定<br>    动态获取: bootp:boot protocol MAC与IP一一静态对应dhcp:增强的bootp，动态</p>
<p>DHCP: （Dynamic Host Configuration Protocol）<br>    动态主机配置协议<br>    局域网协议，UDP协议</p>
<p>主要用途：<br>    用于内部网络和网络服务供应商自动分配IP地址给用户<br>    用于内部网络管理员作为对所有电脑作集中管理的手段</p>
<p>使用场景<br>    自动化安装系统<br>    解决IPV4资源不足问题</p>
<p>DHCP共有八种报文<br>    DHCP DISCOVER：客户端到服务器<br>    DHCP OFFER ：服务器到客户端<br>    DHCP REQUEST：客户端到服务器<br>    DHCP ACK ：服务器到客户端<br>    DHCP NAK：服务器到客户端,通知用户无法分配合适的IP地址<br>    DHCP DECLINE ：客户端到服务器，指示地址已被使用<br>    DHCP RELEASE：客户端到服务器，放弃网络地址和取消剩余的租约时间<br>    DHCP INFORM：客户端到服务器, 客户端如果需要从DHCP服务器端获取更为详细的配置信息，则发送Inform报文向服务器进行请求，极少用到</p>
<p>续租<br>    50% ：租赁时间达到50%时来续租，刚向DHCP服务器发向新的DHCPREQUEST请求。如果dhcp服务没有拒绝的理由，则回应DHCPACK信息。当DHCP客户端收到该应答信息后，就重新开始新的租用周期<br>    87.5%：如果之前DHCP Server没有回应续租请求，等到租约期的7/8时，主机会再发送一次广播请求</p>
<h4 id="DHCP服务简介"><a href="#DHCP服务简介" class="headerlink" title="DHCP服务简介"></a>DHCP服务简介</h4><p>同网段多DHCP服务<br>    DHCP服务必须基于本地<br>    先到先得的原则</p>
<p>跨网段<br>    RFC 1542 Compliant Routers<br>    dhcrelay: 中继</p>
<p>相关协议<br>    Arp<br>    rarp</p>
<h4 id="DHCP实现"><a href="#DHCP实现" class="headerlink" title="DHCP实现"></a>DHCP实现</h4><p>Linux DHCP协议的实现程序：dhcp, dnsmasq（dhcp,dns）</p>
<p>Dhcp Server<br>    /usr/sbin/dhcpd<br>    /etc/dhcp/dhcpd.conf –&gt; /etc/rc.d/init.d/dhcpd<br>    /etc/dhcp/dhcpd6.conf–&gt; /etc/rc.d/init.d/dhcpd6<br>    /usr/sbin/dhcrelay<br>    /etc/rc.d/init.d/dhcrelay<br>    dhcp server:67/udp<br>    dhcp client: 68/udp<br>    dhcpv6 client:546/udp</p>
<p>Dhcp client<br>    dhclient<br>    自动获取的IP信息：    /var/lib/dhclient</p>
<h4 id="DHCP配置文件"><a href="#DHCP配置文件" class="headerlink" title="DHCP配置文件"></a>DHCP配置文件</h4><p>dhcpd.conf:<br>    帮助参考：man 5 dhcpd.conf<br>    全局配置<br>    subnet {<br>        …<br>    }<br>    host {</p>
<p>​    }</p>
<p>地址分配记录<br>    /var/lib/dhcpd/dhcpd.leases</p>
<h4 id="dhcpd-conf示例"><a href="#dhcpd-conf示例" class="headerlink" title="dhcpd.conf示例"></a>dhcpd.conf示例</h4><p>option domain-name “magedu.com”;<br>option domain-name-servers 192.168.0.1,8.8.8.8;<br>default-lease-time 86400;<br>max-lease-time 86400;<br>subnet 192.168.100.0 netmask 255.255.255.0 {<br>    range 192.168.100.1 192.168.100.200;<br>    option routers 192.168.100.1;<br>}</p>
<p>其它配置选项：<br>    filename: 指明引导文件名称<br>    next-server：提供引导文件的服务器IP地址<br>示例：<br>    filename “pxelinux.0”;<br>    next-server 192.168.100.100;<br>检查语法<br>    service dhcpd configtest</p>
<h3 id="PXE介绍"><a href="#PXE介绍" class="headerlink" title="PXE介绍"></a>PXE介绍</h3><p>PXE：<br>    Preboot Excution Environment 预启动执行环境<br>    Intel公司研发<br>    基于Client/Server的网络模式，支持远程主机通过网络从远端服务器下载映像，并由此支持通过网络启动操作系统<br>    PXE可以引导和安装Windows,linux等多种操作系统</p>
<p>PXE工作原理<br>    Client向PXE Server上的DHCP发送IP地址请求消息，DHCP检测Client是否合法（主要是检测Client的网卡MAC地址），如果合法则返回Client的IP地址，同时将启动文件pxelinux.0的位置信息一并传送给Client<br>    Client向PXE Server上的TFTP发送获取pxelinux.0请求消息，TFTP接收到消息之后再向Client<br>发送pxelinux.0大小信息，试探Client是否满意，当TFTP收到Client发回的同意大小信息之后，正式向Client发送pxelinux.0<br>    Client执行接收到的pxelinux.0文件<br>    Client向TFTP Server发送针对本机的配置信息文件（在TFTP 服务的pxelinux.cfg目录下），<br>TFTP将配置文件发回Client，继而Client根据配置文件执行后续操作。<br>    Client向TFTP发送Linux内核请求信息，TFTP接收到消息之后将内核文件发送给Client<br>    Client向TFTP发送根文件请求信息，TFTP接收到消息之后返回Linux根文件系统<br>    Client启动Linux内核<br>    Client下载安装源文件，读取自动化安装脚本</p>
<h4 id="PXE自动化安装CentOS-7"><a href="#PXE自动化安装CentOS-7" class="headerlink" title="PXE自动化安装CentOS 7"></a>PXE自动化安装CentOS 7</h4><p>安装前准备：关闭防火墙和SELINUX，DHCP服务器静态IP<br>安装软件包<br>    httpd tftp-server dhcp syslinux system-config-kickstart<br>配置文件共享服务：<br>    systemctl enable httpd<br>    systemctl start httpd<br>    mkdir /var/www/html/centos/7<br>    mount /dev/sr0 /var/www/html/centos/7<br>准备kickstart文件<br>    /var/www/html/ks/centos7.cfg 注意：权限<br>配置tftp服务<br>    systemctl enable tftp.socket<br>    systemctl start tftp.socket<br>配置DHCP服务<br>    vim /etc/dhcp/dhcpd.conf<br>    option domain-name “example.com”;<br>    default-lease-time 600;<br>    max-lease-time 7200;<br>    subnet 192.168.100.0 netmask 255.255.255.0 {<br>        range 192.168.100.1 192.168.100.200;<br>        filename “pxelinux.0”;<br>        next-server 192.168.100.100;<br>    }<br>    systemctl enable dhcpd<br>    systemctl start dhcpd</p>
<p>准备相关文件<br>mkdir /var/lib/tftpboot/pxelinux.cfg/<br>cp /usr/share/syslinux/{pxelinux.0,menu.c32} /var/lib/tftpboot/<br>cp /misc/cd/isolinux/{vmlinuz,initrd.img} /var/lib/tftpboot/<br>cp /misc/cd/isolinux/isolinux.cfg  /var/lib/tftpboot/pxelinux.cfg/default</p>
<p>文件列表如下：</p>
<p>/var/lib/tftpboot/<br>├── initrd.img<br>├── menu.c32<br>├── pxelinux.0<br>├── pxelinux.cfg<br>│    └── default<br>└── vmlinuz</p>
<p>准备启动菜单<br>    Vim /var/lib/tftpboot/pxelinux.cfg/default<br>    default menu.c32<br>    timeout 600<br>    menu title PXE INSTALL MENU<br>    label auto<br>        menu label Auto Install CentOS 7<br>        kernel vmlinuz<br>        append initrd=initrd.img ks=<a href="http://192.168.100.100/ks/centos7.cfg" target="_blank" rel="noopener">http://192.168.100.100/ks/centos7.cfg</a><br>    label manual<br>        menu label Manual Install CentOS 7<br>        kernel vmlinuz<br>        append initrd=initrd.img inst.repo=<a href="http://192.168.100.100/centos/7" target="_blank" rel="noopener">http://192.168.100.100/centos/7</a><br>    label local<br>        menu default<br>        menu label ^Boot from local drive<br>        localboot 0xffff</p>
<p>安装前准备：关闭防火墙和SELINUX，DHCP服务器静态IP</p>
<h5 id="1-安装相应软件包"><a href="#1-安装相应软件包" class="headerlink" title="1 安装相应软件包"></a>1 安装相应软件包</h5><pre><code>yum install dhcp httpd tftp-server syslinux chkconfig tftp on
chkconfig xinetd on 
chkconfig httpd on 
chkconfig dhcpd on 
service httpd start 
service xneted start</code></pre><h5 id="2-准备Yum-源和相关目录"><a href="#2-准备Yum-源和相关目录" class="headerlink" title="2 准备Yum 源和相关目录"></a>2 准备Yum 源和相关目录</h5><pre><code>mkdir -pv /var/www/html/centos/{6,ks} 
mount /dev/sr0 /var/www/html/centos/6</code></pre><h5 id="3-准备kickstart文件"><a href="#3-准备kickstart文件" class="headerlink" title="3 准备kickstart文件"></a>3 准备kickstart文件</h5><pre><code>/var/www/html/centos/ks/centos6.cfg</code></pre><p>注意权限：<br>    chmod 644 /var/www/html/centos/ks/centos6.cfg</p>
<h5 id="4-准备相关的启动文件"><a href="#4-准备相关的启动文件" class="headerlink" title="4 准备相关的启动文件"></a>4 准备相关的启动文件</h5><pre><code>mkdir /var/lib/tftpboot/pxelinux.cfg/
cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/ 
cd /misc/cd/images/pxeboot/
cp vmlinuz initrd.img /var/lib/tftpboot 
cd /misc/cd/isolinux/
cp boot.msg vesamenu.c32 splash.jpg /var/lib/tftpboot</code></pre><h5 id="5-准备启动菜单文件"><a href="#5-准备启动菜单文件" class="headerlink" title="5 准备启动菜单文件"></a>5 准备启动菜单文件</h5><pre><code>cp /misc/cd/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default
vim /var/lib/tftpboot/pxelinux.cfg/default 
default vesamenu.c32 指定菜单风格 
#prompt 1
timeout 600 
display boot.msg
menu background splash.jpg
menu title Welcome to wang CentOS 6 
menu color border 0 #ffffffff #00000000 
menu color sel 7 #ffffffff #ff000000 
menu color title 0 #ffffffff #00000000 
menu color tabmsg 0 #ffffffff #00000000 
menu color unsel 0 #ffffffff #00000000 
menu color hotsel 0 #ff000000 #ffffffff 
menu color hotkey 7 #ffffffff #ff000000 
menu color scrollbar 0 #ffffffff #00000000
label auto
    menu label ^Automatic Install Centos6
    kernel vmlinuz
    append initrd=initrd.img ks=http://192.168.100.100/centos/ks/centos6.cfg
label manual
    menu label ^Manual Install Centos
    kernel vmlinuz
    append initrd=initrd.img inst.repo=http://192.168.100.100/centos/6
label local
    menu default
    menu label Boot from ^local drive
    localboot 0xffff</code></pre><p>目录结构如下：<br>    tree /var/lib/tftpboot/<br>    /var/lib/tftpboot/<br>    ├── boot.msg<br>    ├── initrd.img<br>    ├── pxelinux.0<br>    ├── pxelinux.cfg<br>    │    └── default<br>    ├── splash.jpg<br>    ├── vesamenu.c32<br>    └── vmlinuz</p>
<p>​    1 directory, 7 files</p>
<h5 id="6-配置dhcp服务"><a href="#6-配置dhcp服务" class="headerlink" title="6 配置dhcp服务"></a>6 配置dhcp服务</h5><p>​    cp /usr/share/doc/dhcp-4.1.1/dhcpd.conf.sample /etc/dhcp/dhcpd.conf<br>    vim /etc/dhcp/dhcpd.conf<br>    option domain-name “magedu.com”;<br>    option domain-name-servers 192.168.100.1;<br>    subnet 192.168.100.0 netmask 255.255.255.0 {<br>        range 192.168.100.1 192.168.100.200;<br>        option routers 192.168.100.1;<br>        filename “pxelinux.0”;<br>        next-server 192.168.100.100;<br>    }</p>
<p>​    service dhcpd start</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E5%8A%A0%E5%AF%86%E4%B8%8E%E5%AE%89%E5%85%A8-%E4%BA%94/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E5%8A%A0%E5%AF%86%E4%B8%8E%E5%AE%89%E5%85%A8-%E4%BA%94/" class="post-title-link" itemprop="url">加密与安全(五)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-09-20 19:30:26 / 修改时间：19:31:11" itemprop="dateCreated datePublished" datetime="2018-09-20T19:30:26+08:00">2018-09-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="PAM认证机制"><a href="#PAM认证机制" class="headerlink" title="PAM认证机制"></a>PAM认证机制</h3><p>PAM:Pluggable Authentication Modules<br>    认证库:文本文件,MySQL,NIS,LDAP等<br>    Sun公司于1995 年开发的一种与认证相关的通用框架机制<br>    PAM 是关注如何为服务验证用户的 API,通过提供一些动态链接库和一套统一的API,将系统提供的服务和该服务的认证方式分开<br>    使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序<br>    一种认证框架,自身不做认证</p>
<p>它提供了对所有服务进行认证的中央机制,适用于login,远程登录(telnet,rlogin,fsh,ftp,点对点协议 (PPP)),su等应用程序中.系统管理员通过PAM配置文件来制定不同应用程序的不同认证策略；应用程序开发者通过在服务程序中使用PAM API(pam_xxxx( ))来实现对认证方法的调用；而PAM服务模块的开发者则利用PAM SPI来编写模块(主要调用函数pam_sm_xxxx( )供PAM接口库调用,将不同的认证机制加入到系统中；PAM接口库(libpam)则读取配置文件,将应用程序和相应的PAM服务模块联系起来</p>
<h4 id="图解PAM架构"><a href="#图解PAM架构" class="headerlink" title="图解PAM架构"></a>图解PAM架构</h4><p><img data-src="https://github.com/Markupzh/Markupzh.github.io/blob/master/photo/post_secure_safe_08.png" alt=""></p>
<h4 id="PAM认证原理"><a href="#PAM认证原理" class="headerlink" title="PAM认证原理"></a>PAM认证原理</h4><p>PAM认证一般遵循这样的顺序:Service(服务)→PAM(配置文件)→pam_*.so<br>PAM认证首先要确定那一项服务,然后加载相应的PAM的配置文件(位于/etc/pam.d下),最后调用认证文件(位于/lib/security下)进行安全认证</p>
<p><img data-src="https://github.com/Markupzh/Markupzh.github.io/blob/master/photo/post_secure_safe_09.png" alt=""></p>
<h4 id="PAM认证机制-1"><a href="#PAM认证机制-1" class="headerlink" title="PAM认证机制"></a>PAM认证机制</h4><h5 id="PAM相关文件"><a href="#PAM相关文件" class="headerlink" title="PAM相关文件"></a>PAM相关文件</h5><p>模块文件目录:/lib64/security/*.so<br>环境相关的设置:/etc/security/<br>主配置文件:/etc/pam.conf,默认不存在<br>为每种应用模块提供一个专用的配置文 件:/etc/pam.d/APP_NAME<br>注意:如/etc/pam.d存在,/etc/pam.conf将失效</p>
<h5 id="PAM认证过程"><a href="#PAM认证过程" class="headerlink" title="PAM认证过程:"></a>PAM认证过程:</h5><p>1.使用者执行/usr/bin/passwd 程序,并输入密码<br>2.passwd开始调用PAM模块,PAM模块会搜寻passwd程序的PAM相关设置文件,这个设置文件一般是在/etc/pam.d/里边的与程序同名的文件,即PAM会搜寻/etc/pam.d/passwd此设置文件<br>3.经由/etc/pam.d/passwd设定文件的数据,取用PAM所提供的相关模块来进行验证<br>4.将验证结果回传给passwd这个程序,而passwd这个程序会根据PAM回传的结果决定下一个动作(重新输入密码或者通过验证)</p>
<h5 id="PAM认证文件"><a href="#PAM认证文件" class="headerlink" title="PAM认证文件:"></a>PAM认证文件:</h5><p>通用配置文件/etc/pam.conf格式<br>    application type control module-path arguments<br>专用配置文件/etc/pam.d/* 格式<br>    type control module-path arguments<br>说明:<br>    服务名(application)<br>    telnet、login、ftp等,服务名字“OTHER”代表所有没有在该文件中明确配置的其它服务<br>    模块类型(module-type)<br>    control PAM库该如何处理与该服务相关的PAM模块的成功或失败情况<br>    module-path 用来指明本模块对应的程序文件的路径名<br>    Arguments 用来传递给该模块的参数</p>
<h5 id="PAM模块类型-module-type"><a href="#PAM模块类型-module-type" class="headerlink" title="PAM模块类型(module-type)"></a>PAM模块类型(module-type)</h5><p>Auth 账号的认证和授权<br>Account 与账号管理相关的非认证类的功能,如:用来限制/允许用户对某个服务的访问时间,当前有效的系统资源(最多可以有多少个用户),限制用户的位置(例如:root用户只能从控制台登录)<br>Password 用户修改密码时密码复杂度检查机制等功能<br>Session 用户获取到服务之前或使用服务完成之后需要进行一些附加的操作,如:记录打开/关闭数据的信息,监视目录等<br>-type 表示因为缺失而不能加载的模块将不记录到系统日志,对于那些不总是安装在系统上的模块有用</p>
<h5 id="PAM参数"><a href="#PAM参数" class="headerlink" title="PAM参数"></a>PAM参数</h5><p>Control:<br>PAM库如何处理与该服务相关的PAM模块成功或失败情况<br>两种方式实现:<br>    简单和复杂<br>简单方式实现:一个关健词实现<br>    required :一票否决,表示本模块必须返回成功才能通过认证,但是如果该模块返回失败,失败结果也不会立即通知用户,而是要等到同一type中的所有模块全部执行完毕再将失败结果返回给应用程序.即为必要条件</p>
<p>requisite :一票否决,该模块必须返回成功才能通过认证,但是一旦该模块返回失败,将不再执行同一type内的任何模块,而是直接将控制权返回给应用程序.是一个必要条件<br>sufficient :一票通过,表明本模块返回成功则通过身份认证的要求,不必再执行同一type内的其它模块,但如果本模块返回失败可忽略,即为充分条件<br>optional :表明本模块是可选的,它的成功与否不会对身份认证起关键作用,其返回值一般被忽略<br>include: 调用其他的配置文件中定义的配置信息</p>
<p>复杂详细实现:使用一个或多个“status=action”<br>[status1=action1 status2=action …]<br>    Status:检查结果的返回状态<br>    Action:采取行为 ok,done,die,bad,ignore,reset<br>ok 模块通过,继续检查<br>done 模块通过,返回最后结果给应用<br>bad 结果失败,继续检查<br>die 结果失败,返回失败结果给应用<br>ignore 结果忽略,不影响最后结果<br>reset 忽略已经得到的结果</p>
<p>module-path: 模块路径<br>    相对路径:<br>        /lib64/security目录下的模块可使用相对路径<br>        如:pam_shells.so、pam_limits.so<br>    绝对路径:<br>模块通过读取配置文件完成用户对系统资源的使用控制<br>    /etc/security/*.conf<br>注意:修改PAM配置文件将马上生效<br>建议:编辑pam规则时,保持至少打开一个root会话,以防止root身份验证错误<br>Arguments 用来传递给该模块的参数</p>
<h5 id="PAM文档说明"><a href="#PAM文档说明" class="headerlink" title="PAM文档说明"></a>PAM文档说明</h5><p>/user/share/doc/pam-*<br>rpm -qd pam<br>man –k pam_<br>man 模块名 如man rootok<br>《The Linux-PAM System Administrators’ Guide》</p>
<h5 id="PAM模块示例"><a href="#PAM模块示例" class="headerlink" title="PAM模块示例"></a>PAM模块示例</h5><h6 id="模块-pam-shells"><a href="#模块-pam-shells" class="headerlink" title="模块:pam_shells"></a>模块:pam_shells</h6><p>功能:检查有效shell<br>man pam_shells<br>示例:不允许使用/bin/csh的用户本地登录<br>vim /etc/pam.d/login<br>    auth required pam_shells.so<br>vim /etc/shells<br>    去掉 /bin/csh<br>useradd –s /bin/csh testuser<br>testuser将不可登录<br>tail /var/log/secure</p>
<h6 id="模块-pam-securetty-so"><a href="#模块-pam-securetty-so" class="headerlink" title="模块:pam_securetty.so"></a>模块:pam_securetty.so</h6><p>功能:只允许root用户在/etc/securetty列出的安全终端上登陆<br>示例:允许root在telnet登陆<br>vi /etc/pam.d/remote<br>#auth required pam_securetty.so #将这一行加上注释</p>
<p>或者/etc/securetty文件中加入<br>pts/0,pts/1…pts/n</p>
<h6 id="模块-pam-nologin-so"><a href="#模块-pam-nologin-so" class="headerlink" title="模块:pam_nologin.so"></a>模块:pam_nologin.so</h6><p>功能:<br>    如果/etc/nologin文件存在,将导致非root用户不能登陆<br>    如果用户shell是/sbin/nologin 时,当该用户登陆时,会显示/etc/nologin文件内容,并拒绝登陆</p>
<h6 id="模块-pam-limits-so"><a href="#模块-pam-limits-so" class="headerlink" title="模块:pam_limits.so"></a>模块:pam_limits.so</h6><p>功能:在用户级别实现对其可使用的资源的限制,例如:可打开的文件数量,可运行的进程数量,可用内存空间<br>修改限制的实现方式:<br>(1) ulimit命令,立即生效,但无法保存<br>    -n 最多的打开的文件描述符个数<br>    -u 最大用户进程数<br>    -S 使用 soft(软)资源限制<br>    -H 使用 hard(硬)资源限制<br>(2) 配置文件:/etc/security/limits.conf, /etc/security/limits.d/*.conf<br>配置文件:每行一个定义；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\&lt;domain\&gt;    \&lt;type\&gt;      \&lt;item\&gt;       \&lt;value&gt;</span><br></pre></td></tr></table></figure>

<h5 id="PAM图解"><a href="#PAM图解" class="headerlink" title="PAM图解"></a>PAM图解</h5><p><img data-src="https://github.com/Markupzh/Markupzh.github.io/blob/master/photo/post_secure_safe_10.png" alt=""></p>
<h5 id="pam-limits-so"><a href="#pam-limits-so" class="headerlink" title="pam_limits.so"></a>pam_limits.so</h5><p> &lt;domain&gt;应用于哪些对象<br>    Username 单个用户<br>    @group 组内所有用户<br>    * 所有用户<br> &lt;type&gt;限制的类型<br>    Soft 软限制,普通用户自己可以修改<br>    Hard 硬限制,由root用户设定,且通过kernel强制生效<br>    - 二者同时限定<br> &lt;item&gt;限制的资源<br>    nofile 所能够同时打开的最大文件数量,默认为1024<br>    nproc 所能够同时运行的进程的最大数量,默认为1024<br> &lt;value&gt;指定具体值</p>
<h6 id="pam-limits-so-1"><a href="#pam-limits-so-1" class="headerlink" title="pam_limits.so"></a>pam_limits.so</h6><p>限制用户最多打开的文件数和运行进程数<br>/etc/pam.d/system-auth<br>    session required pam_limits.so<br>vim /etc/security/limits.conf<br>    apache – nofile 10240 用户apache可打开10240个文件<br>    student hard nproc 20 用户student不能运行超过20个进程</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E5%8A%A0%E5%AF%86%E4%B8%8E%E5%AE%89%E5%85%A8-%E5%9B%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E5%8A%A0%E5%AF%86%E4%B8%8E%E5%AE%89%E5%85%A8-%E5%9B%9B/" class="post-title-link" itemprop="url">加密与安全(四)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-09-14 22:20:43" itemprop="dateCreated datePublished" datetime="2018-09-14T22:20:43+08:00">2018-09-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-09-20 19:31:09" itemprop="dateModified" datetime="2018-09-20T19:31:09+08:00">2018-09-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="AIDE"><a href="#AIDE" class="headerlink" title="AIDE"></a>AIDE</h3><h5 id="AIDE简介"><a href="#AIDE简介" class="headerlink" title="AIDE简介"></a>AIDE简介</h5><p>当一个入侵者进入了你的系统并且种植了木马,通常会想办法来隐蔽这个木马(除了木马自身的一些隐蔽特性外,他会尽量给你检查系统的过程设置障碍),通常入侵者会修改一些文件,比如管理员通常用ps -aux来查看系统进程,那么入侵者很可能用自己经过修改的ps程序来替换掉你系统上的ps程序,以使用ps命令查不到正在运行的木马程序.如果入侵者发现管理员正在运行crontab作业,也有可能替换掉crontab程序等等.所以由此可以看出对于系统文件或是关键文件的检查是很必要的.目前就系统完整性检查的工具用的比较多的有两款:Tripwire和AIDE,前者是一款商业软件,后者是一款免费的但功能也很强大的工具</p>
<p>AIDE(Advanced Intrusion Detection Environment)<br>• 高级入侵检测环境)是一个入侵检测工具,主要用途是检查文件的完整性,审计计算机上的那些文件被更改过了.<br>• AIDE能够构造一个指定文件的数据库,它使用aide.conf作为其配置文件.AIDE数据库能够保存文件的各种属性,包括:权限(permission)、索引节点序号(inode number)、所属用户(user)、所属用户组(group)、文件大小、最后修改时间(mtime)、创建时间(ctime)、最后访问时间(atime)、增加的大小以及连接数.AIDE还能够使用下列算法:sha1、md5、rmd160、tiger,以密文形式建立每个文件的校验码或散列号.<br>• 这个数据库不应该保存那些经常变动的文件信息,例如:日志文件、邮件、/proc文件系统、用户起始目录以及临时目录.</p>
<h5 id="安装AIDE"><a href="#安装AIDE" class="headerlink" title="安装AIDE"></a>安装AIDE</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install aide</span><br></pre></td></tr></table></figure>

<h5 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h5><p>vim /etc/aide.conf (指定对哪些文件进行检测)<br>/test/chameleon R<br>/bin/ps R+a<br>/usr/bin/crontab R+a<br>/etc PERMS<br>!/etc/mtab #“!”表示忽略这个文件的检查<br>R=p+i+n+u+g+s+m+c+md5 权限+索引节点+链接数+用户+组+大小+最后一次修改时间+创建时间+md5校验    值<br>NORMAL = R+rmd60+sha256    </p>
<h5 id="初始化默认的AIDE的库"><a href="#初始化默认的AIDE的库" class="headerlink" title="初始化默认的AIDE的库:"></a>初始化默认的AIDE的库:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;aide --init</span><br></pre></td></tr></table></figure>

<h5 id="生成检查数据库-建议初始数据库存放到安全的地方"><a href="#生成检查数据库-建议初始数据库存放到安全的地方" class="headerlink" title="生成检查数据库(建议初始数据库存放到安全的地方)"></a>生成检查数据库(建议初始数据库存放到安全的地方)</h5><p>cd /var/lib/aide<br>mv aide.db.new.gz aide.db.gz    </p>
<h5 id="检测"><a href="#检测" class="headerlink" title="检测:"></a>检测:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;aide --check</span><br></pre></td></tr></table></figure>

<h5 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a>更新数据库</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aide --update</span><br></pre></td></tr></table></figure>



<h3 id="sudo更改身份"><a href="#sudo更改身份" class="headerlink" title="sudo更改身份"></a>sudo更改身份</h3><p>su 切换身份:su –l username –c ‘command’<br>sudo<br>    • 来自sudo包,man 5 sudoers<br>    • sudo能够授权指定用户在指定主机上运行某些命令.如果未授权用户尝试使用 sudo,会提示联系管理员<br>    • sudo可以提供日志,记录每个用户使用sudo操作<br>    • sudo为系统管理员提供配置文件,允许系统管理员集中地管理用户的使用权限和使用的主机<br>    • sudo使用时间戳文件来完成类似“检票”的系统,默认存活期为5分钟的“入场券”<br>    • 通过visudo命令编辑配置文件,具有语法检查功能<br>        visudo –c 检查语法<br>        visudo -f /etc/sudoers.d/test</p>
<h4 id="sudo"><a href="#sudo" class="headerlink" title="sudo"></a>sudo</h4><p>配置文件:/etc/sudoers, /etc/sudoers.d/<br>时间戳文件:/var/db/sudo<br>日志文件:/var/log/secure<br>配置文件支持使用通配符glob:<br>？:任意单一字符</p>
<p>* :匹配任意长度字符</p>
<p>[wxc]:匹配其中一个字符</p>
<p>[!wxc]:除了这三个字符的其它字符</p>
<p>\x : 转义</p>
<p>[[alpha]] :字母 示例: /bin/ls [[alpha]]*    </p>
<p>配置文件规则有两类；<br>    1、别名定义:不是必须的<br>    2、授权规则:必须的</p>
<h4 id="sudoers"><a href="#sudoers" class="headerlink" title="sudoers"></a>sudoers</h4><p>授权规则格式:<br>    用户 登入主机=(代表用户) 命令<br>示例:<br>    root ALL=(ALL) ALL<br>格式说明:<br>    user: 运行命令者的身份<br>    host: 通过哪些主机<br>    (runas):以哪个用户的身份<br>    command: 运行哪些命令</p>
<h4 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h4><p> Users和runas:<br>    username<br>    #uid<br>    %group_name<br>    %#gid<br>    user_alias|runas_alias<br> host:<br>    ip或hostname<br>    network(/netmask)<br>    host_alias<br> command:<br>    command name<br>    directory<br>    sudoedit<br>    Cmnd_Alias</p>
<h4 id="sudo别名和示例"><a href="#sudo别名和示例" class="headerlink" title="sudo别名和示例"></a>sudo别名和示例</h4><p>别名有四种类型:User_Alias, Runas_Alias, Host_Alias ,Cmnd_Alias<br>别名格式:[A-Z]([A-Z][0-9]_)*</p>
<p>别名定义:<br>Alias_Type NAME1 = item1, item2, item3 : NAME2 = item4, item5</p>
<h5 id="示例1"><a href="#示例1" class="headerlink" title="示例1:"></a>示例1:</h5><p>Student ALL=(ALL) ALL<br>%wheel ALL=(ALL) ALL</p>
<h5 id="示例2"><a href="#示例2" class="headerlink" title="示例2:"></a>示例2:</h5><p>student ALL=(root) /sbin/pidof,/sbin/ifconfig<br>%wheel ALL=(ALL) NOPASSWD: ALL</p>
<h5 id="示例3"><a href="#示例3" class="headerlink" title="示例3:"></a>示例3:</h5><p>User_Alias NETADMIN= netuser1,netuser2<br>Cmnd_Alias NETCMD = /usr/sbin/ip<br>NETADMIN ALL=(root) NETCMD</p>
<h5 id="示例4"><a href="#示例4" class="headerlink" title="示例4:"></a>示例4:</h5><p>User_Alias SYSADER=mark,jack,%admins<br>User_Alias DISKADER=tom<br>Host_Alias SERS=<a href="http://www.google.com,172.16.0.0/24" target="_blank" rel="noopener">www.google.com,172.16.0.0/24</a><br>Runas_Alias OP=root<br>Cmnd_Alias SYDCMD=/bin/chown,/bin/chmod<br>Cmnd_Alias DSKCMD=/sbin/parted,/sbin/fdisk<br>SYSADER SERS= SYDCMD,DSKCMD<br>DISKADER ALL=(OP) DSKCMD </p>
<p>User_Alias ADMINUSER = adminuser1,adminuser2<br>Cmnd_Alias ADMINCMD =             /usr/sbin/useradd,/usr/sbin/usermod,<br>/usr/bin/passwd [a-zA-Z]*, !/usr/bin/passwd root ADMINUSER ALL=(root) NOPASSWD:ADMINCMD,<br>PASSWD:/usr/sbin/userdel</p>
<h5 id="示例5"><a href="#示例5" class="headerlink" title="示例5:"></a>示例5:</h5><p>Defaults:mark runas_default=tom<br>mark ALL=(tom,jerry) ALL</p>
<h5 id="示例6"><a href="#示例6" class="headerlink" title="示例6:"></a>示例6:</h5><p>mark 192.168.1.6,192.168.1.8=(root) /usr/sbin/,!/usr/sbin/useradd</p>
<h5 id="示例7"><a href="#示例7" class="headerlink" title="示例7:"></a>示例7:</h5><p>mark ALL=(ALL) /bin/cat /var/log/messages*</p>
<h4 id="sudo命令"><a href="#sudo命令" class="headerlink" title="sudo命令"></a>sudo命令</h4><p>ls -l /usr/bin/sudo<br>sudo –i –u mark 切换身份<br>sudo [-u user] COMMAND<br>    -V 显示版本信息等配置信息<br>    -u user 默认为root<br>    -l,ll 列出用户在主机上可用的和被禁止的命令<br>    -v 再延长密码有效期限5分钟,更新时间戳<br>    -k 清除时间戳(1970-01-01),下次需要重新输密码<br>    -K 与-k类似,还要删除时间戳文件<br>    -b 在后台执行指令<br>    -p 改变询问密码的提示符号<br>    示例:-p “password on %h for user %p:” </p>
<h3 id="TCP-Wrappers"><a href="#TCP-Wrappers" class="headerlink" title="TCP_Wrappers"></a>TCP_Wrappers</h3><p>作者:Wieste Venema,IBM,Google<br>工作在第四层(传输层)的TCP协议<br>对有状态连接的特定服务进行安全检测并实现访问控制<br>以库文件形式实现<br>某进程是否接受libwrap的控制取决于发起此进程的程序在编译时是否针对libwrap进行编译的<br>判断服务程序是否能够由tcp_wrapper进行访问控制的方法:<br>    ldd /PATH/TO/PROGRAM|grep libwrap.so<br>    strings PATH/TO/PROGRAM|grep libwrap.so</p>
<h4 id="TCP-Wrappers的使用"><a href="#TCP-Wrappers的使用" class="headerlink" title="TCP_Wrappers的使用"></a>TCP_Wrappers的使用</h4><p>配置文件:/etc/hosts.allow, /etc/hosts.deny<br>帮助参考:man 5 hosts_access,man 5 hosts_options<br>检查顺序:hosts.allow,hosts.deny(默认允许)<br>    注意:一旦前面规则匹配,直接生效,将不再继续<br>基本语法:<br>    daemon_list@host: client_list [ :options :option… ]<br>Daemon_list@host格式<br>    单个应用程序的二进制文件名,而非服务名,例如vsftpd<br>    以逗号或空格分隔的应用程序文件名列表,如:sshd,vsftpd<br>    ALL表示所有接受tcp_wrapper控制的服务程序<br>    主机有多个IP,可用@hostIP来实现控制如:<a href="mailto:in.telnetd@192.168.0.254">in.telnetd@192.168.0.254</a></p>
<p>客户端Client_list格式<br>    以逗号或空格分隔的客户端列表<br>    基于IP地址:192.168.10.1 192.168.1.<br>    基于主机名:<a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a> .google.com 较少用<br>    基于网络/掩码:192.168.0.0/255.255.255.0<br>    基于net/prefixlen: 192.168.1.0/24(CentOS7)<br>    基于网络组(NIS 域):@mynetwork<br>    内置ACL:ALL,LOCAL,KNOWN,UNKNOWN,PARANOID<br>EXCEPT用法:<br>    示例:<br>    vsftpd: 172.16. EXCEPT 172.16.100.0/24 EXCEPT 172.16.100.1</p>
<p>[:options]选项:<br>帮助:man 5 hosts_options<br>    deny 主要用在/etc/hosts.allow定义“拒绝”规则<br>        如:vsftpd: 172.16. :deny<br>    allow 主要用在/etc/hosts.deny定义“允许”规则<br>        如:vsftpd:172.16. :allow<br>    spawn 启动一个外部程序完成执行的操作<br>        twist 实际动作是拒绝访问,使用指定的操作替换当前服务,标准I/O和ERROR发送到客户端,默认至/dev/null<br>测试工具:<br>    tcpdmatch [-d] daemon[@host] client<br>    -d 测试当前目录下的hosts.allow和hosts.deny</p>
<h5 id="示例1-1"><a href="#示例1-1" class="headerlink" title="示例1:"></a>示例1:</h5><p>只允许192.168.1.0/24的主机访问sshd</p>
<p>/etc/hosts.allow<br>    sshd: 192.168.1.<br>/etc/hosts.deny<br>    sshd :ALL </p>
<h5 id="示例2-1"><a href="#示例2-1" class="headerlink" title="示例2:"></a>示例2:</h5><p>只允许192.168.1.0/24的主机访问telnet和vsftpd服务</p>
<p>/etc/hosts.allow<br>    vsftpd,in.telnetd: 192.168.1.<br>/etc/host.deny<br>    vsftpd,in.telnetd: ALL </p>
<h5 id="示例3-1"><a href="#示例3-1" class="headerlink" title="示例3:"></a>示例3:</h5><p>sshd: ALL :spawn echo “$(date +%%F) login attempt from %c to<br>%s,%d” &gt;&gt;/var/log/sshd.log<br>说明:<br>    在/etc/hosts.allow中添加,允许登录,并记录日志<br>    在/etc/hosts.deny中添加,拒绝登录,并记录日志<br>    %c 客户端信息<br>    %s 服务器端信息<br>    %d 服务名<br>    %p 守护进程的PID<br>    %% 表示%<br>vsftpd: 172.16. :twist /bin/echo “connection prohibited”</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mark"
      src="/images/mark_avatar.png">
  <p class="site-author-name" itemprop="name">Mark</p>
  <div class="site-description" itemprop="description">半吊子民工 英特纳雄耐尔就一定要实现</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:markupzh@gmail.com" title="E-Mail → mailto:markupzh@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mark</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
