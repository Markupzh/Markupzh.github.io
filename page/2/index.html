<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/M_32px.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/M_16px.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":7,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
<meta property="og:type" content="website">
<meta property="og:title" content="Mark blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Mark blog">
<meta property="og:description" content="半吊子民工 英特纳雄耐尔就一定要实现">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Mark">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Mark blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Mark blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">知行合一 划水归档</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/Python-%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Python-%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="post-title-link" itemprop="url">Python 多进程与多线程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-01-05 21:43:44 / 修改时间：22:00:29" itemprop="dateCreated datePublished" datetime="2019-01-05T21:43:44+08:00">2019-01-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天电话面试被问到Python中多线程和多进程之间的关系和区别,说来丢人距上次使用Python时间久远,有些概念已经模糊了,检索查阅资料之后在此记录一下.</p>
<h3 id="1-线程和进程的基本概念"><a href="#1-线程和进程的基本概念" class="headerlink" title="1 线程和进程的基本概念"></a>1 线程和进程的基本概念</h3><p>现在的 PC 都是多核的，使用多线程能充分利用 CPU 来提供程序的执行效率。</p>
<h4 id="1-1-线程"><a href="#1-1-线程" class="headerlink" title="1.1 线程"></a>1.1 线程</h4><p>线程是一个基本的 CPU 执行单元。它必须依托于进程存活。一个线程是一个<strong>execution context（执行上下文）</strong>，即一个 CPU 执行时所需要的一串指令。</p>
<h4 id="1-2-进程"><a href="#1-2-进程" class="headerlink" title="1.2 进程"></a>1.2 进程</h4><p>进程是指一个程序在给定数据集合上的一次执行过程，是系统进行资源分配和运行调用的独立单位。可以简单地理解为操作系统中正在执行的程序。也就说，每个应用程序都有一个自己的进程。</p>
<p>每一个进程启动时都会最先产生一个线程，即主线程。然后主线程会再创建其他的子线程。</p>
<h4 id="1-3-两者的区别"><a href="#1-3-两者的区别" class="headerlink" title="1.3 两者的区别"></a>1.3 两者的区别</h4><ul>
<li>线程必须在某个进程中执行。</li>
<li>一个进程可包含多个线程，其中有且只有一个主线程。</li>
<li>多线程共享同个地址空间、打开的文件以及其他资源。</li>
<li>多进程共享物理内存、磁盘、打印机以及其他资源。</li>
</ul>
<h4 id="1-4-线程的类型"><a href="#1-4-线程的类型" class="headerlink" title="1.4 线程的类型"></a>1.4 线程的类型</h4><p>线程的因作用可以划分为不同的类型。大致可分为：</p>
<ul>
<li>主线程</li>
<li>子线程</li>
<li>守护线程（后台线程）</li>
<li>前台线程</li>
</ul>
<h3 id="2-Python-多线程"><a href="#2-Python-多线程" class="headerlink" title="2 Python 多线程"></a>2 Python 多线程</h3><h4 id="2-1-GIL"><a href="#2-1-GIL" class="headerlink" title="2.1 GIL"></a>2.1 GIL</h4><p>其他语言，CPU 是多核时是支持多个线程同时执行。但在 Python 中，无论是单核还是多核，同时只能由一个线程在执行。其根源是 GIL 的存在。</p>
<p>GIL 的全称是 Global Interpreter Lock(全局解释器锁)，来源是 Python 设计之初的考虑，为了数据安全所做的决定。某个线程想要执行，必须先拿到 GIL，我们可以把 GIL 看作是“通行证”，并且在一个 Python 进程中，GIL 只有一个。拿不到通行证的线程，就不允许进入 CPU 执行。</p>
<p>而目前 Python 的解释器有多种，例如：</p>
<ul>
<li><strong>CPython</strong>：CPython 是用C语言实现的 Python 解释器。 作为官方实现，它是最广泛使用的 Python 解释器。</li>
<li><strong>PyPy</strong>：PyPy 是用RPython实现的解释器。RPython 是 Python 的子集， 具有静态类型。这个解释器的特点是即时编译，支持多重后端（C, CLI, JVM）。PyPy 旨在提高性能，同时保持最大兼容性（参考 CPython 的实现）。</li>
<li><strong>Jython</strong>：Jython 是一个将 Python 代码编译成 Java 字节码的实现，运行在JVM (Java Virtual Machine) 上。另外，它可以像是用 Python 模块一样，导入 并使用任何Java类。</li>
<li><strong>IronPython</strong>：IronPython 是一个针对 .NET 框架的 Python 实现。它 可以用 Python 和 .NET framewor k的库，也能将 Python 代码暴露给 .NET 框架中的其他语言。</li>
</ul>
<p>GIL 只在 CPython 中才有，而在 PyPy 和 Jython 中是没有 GIL 的。</p>
<p>每次释放 GIL锁，线程进行锁竞争、切换线程，会消耗资源。这就导致打印线程执行时长，会发现耗时更长的原因。</p>
<p>并且由于 GIL 锁存在，Python 里一个进程永远只能同时执行一个线程(拿到 GIL 的线程才能执行)，这就是为什么在多核CPU上，Python 的多线程效率并不高的根本原因。</p>
<h4 id="2-2-创建多线程"><a href="#2-2-创建多线程" class="headerlink" title="2.2 创建多线程"></a>2.2 创建多线程</h4><p>Python提供两个模块进行多线程的操作，分别是<code>thread</code>和<code>threading</code>，<br> 前者是比较低级的模块，用于更底层的操作，一般应用级别的开发不常用。</p>
<ul>
<li>方法1：直接使用<code>threading.Thread()</code> </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个函数名可随便定义</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(n)</span>:</span></span><br><span class="line">    print(<span class="string">"current task："</span>, n)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    t1 = threading.Thread(target=run, args=(<span class="string">"thread 1"</span>,))</span><br><span class="line">    t2 = threading.Thread(target=run, args=(<span class="string">"thread 2"</span>,))</span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br></pre></td></tr></table></figure>

<ul>
<li>方法2：继承<code>threading.Thread</code>来自定义线程类，重写<code>run</code>方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        super(MyThread, self).__init__()  <span class="comment"># 重构run函数必须要写</span></span><br><span class="line">        self.n = n</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"current task："</span>, n)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    t1 = MyThread(<span class="string">"thread 1"</span>)</span><br><span class="line">    t2 = MyThread(<span class="string">"thread 2"</span>)</span><br><span class="line"></span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br></pre></td></tr></table></figure>

<h4 id="2-3-线程合并"><a href="#2-3-线程合并" class="headerlink" title="2.3 线程合并"></a>2.3 线程合并</h4><p><code>Join</code>函数执行顺序是逐个执行每个线程，执行完毕后继续往下执行。主线程结束后，子线程还在运行，<code>join</code>函数使得主线程等到子线程结束时才退出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        n -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    t1 = threading.Thread(target=count, args=(<span class="string">"100000"</span>,))</span><br><span class="line">    t2 = threading.Thread(target=count, args=(<span class="string">"100000"</span>,))</span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    <span class="comment"># 将 t1 和 t2 加入到主线程中</span></span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br></pre></td></tr></table></figure>

<h4 id="2-4-线程同步与互斥锁"><a href="#2-4-线程同步与互斥锁" class="headerlink" title="2.4 线程同步与互斥锁"></a>2.4 线程同步与互斥锁</h4><p>线程之间数据共享的。当多个线程对某一个共享数据进行操作时，就需要考虑到线程安全问题。<code>threading</code>模块中定义了Lock 类，提供了互斥锁的功能来保证多线程情况下数据的正确性。</p>
<p>用法的基本步骤：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建锁</span></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line"><span class="comment">#锁定</span></span><br><span class="line">mutex.acquire([timeout])</span><br><span class="line"><span class="comment">#释放</span></span><br><span class="line">mutex.release()</span><br></pre></td></tr></table></figure>

<p>其中，锁定方法acquire可以有一个超时时间的可选参数timeout。如果设定了timeout，则在超时后通过返回值可以判断是否得到了锁，从而可以进行一些其他的处理。</p>
<p>具体用法见示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">num = <span class="number">0</span></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> num </span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mutex.acquire(<span class="number">1</span>):  </span><br><span class="line">            num = num + <span class="number">1</span></span><br><span class="line">            msg = self.name + <span class="string">': num value is '</span> + str(num)</span><br><span class="line">            print(msg)</span><br><span class="line">            mutex.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        t = MyThread()</span><br><span class="line">        t.start()</span><br></pre></td></tr></table></figure>

<h4 id="2-5-可重入锁（递归锁）"><a href="#2-5-可重入锁（递归锁）" class="headerlink" title="2.5 可重入锁（递归锁）"></a>2.5 可重入锁（递归锁）</h4><p>为了满足在同一线程中多次请求同一资源的需求，Python 提供了可重入锁（RLock）。<br> <code>RLock</code>内部维护着一个<code>Lock</code>和一个<code>counter</code>变量，counter 记录了 acquire 的次数，从而使得资源可以被多次 require。直到一个线程所有的 acquire 都被 release，其他的线程才能获得资源。</p>
<p>具体用法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建 RLock</span></span><br><span class="line">mutex = threading.RLock()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> mutex.acquire(<span class="number">1</span>):</span><br><span class="line">            print(<span class="string">"thread "</span> + self.name + <span class="string">" get mutex"</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            mutex.acquire()</span><br><span class="line">            mutex.release()</span><br><span class="line">            mutex.release()</span><br></pre></td></tr></table></figure>

<h4 id="2-6-守护线程"><a href="#2-6-守护线程" class="headerlink" title="2.6 守护线程"></a>2.6 守护线程</h4><p>如果希望主线程执行完毕之后，不管子线程是否执行完毕都随着主线程一起结束。我们可以使用<code>setDaemon(bool)</code>函数，它跟<code>join</code>函数是相反的。它的作用是设置子线程是否随主线程一起结束，必须在<code>start()</code> 之前调用，默认为<code>False</code>。</p>
<h4 id="2-7-定时器"><a href="#2-7-定时器" class="headerlink" title="2.7 定时器"></a>2.7 定时器</h4><p>如果需要规定函数在多少秒后执行某个操作，需要用到<code>Timer</code>类。具体用法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Timer</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Pyhton"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定一秒钟之后执行 show 函数</span></span><br><span class="line">t = Timer(<span class="number">1</span>, hello)</span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure>

<h3 id="3-Python-多进程"><a href="#3-Python-多进程" class="headerlink" title="3 Python 多进程"></a>3 Python 多进程</h3><h4 id="3-1-创建多进程"><a href="#3-1-创建多进程" class="headerlink" title="3.1 创建多进程"></a>3.1 创建多进程</h4><p>Python 要进行多进程操作，需要用到<code>muiltprocessing</code>库，其中的<code>Process</code>类跟<code>threading</code>模块的<code>Thread</code>类很相似。所以直接看代码熟悉多进程。</p>
<ul>
<li>方法1：直接使用<code>Process</code>, 代码如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">"Process name is "</span> + name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>: </span><br><span class="line">    proc = Process(target=show, args=(<span class="string">'subprocess'</span>,))  </span><br><span class="line">    proc.start()  </span><br><span class="line">    proc.join()</span><br></pre></td></tr></table></figure>

<ul>
<li>方法2：继承<code>Process</code>来自定义进程类，重写<code>run</code>方法, 代码如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyProcess</span><span class="params">(Process)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        super(MyProcess, self).__init__()</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'process name :'</span> + str(self.name))</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        p = MyProcess(i)</span><br><span class="line">        p.start()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        p.join()</span><br></pre></td></tr></table></figure>

<h4 id="3-2-多进程通信"><a href="#3-2-多进程通信" class="headerlink" title="3.2 多进程通信"></a>3.2 多进程通信</h4><p>进程之间不共享数据的。如果进程之间需要进行通信，则要用到<code>Queue模块</code>或者<code>Pipi模块</code>来实现。</p>
<ul>
<li><strong>Queue</strong></li>
</ul>
<p>Queue 是多进程安全的队列，可以实现多进程之间的数据传递。它主要有两个函数,<code>put</code>和<code>get</code>。</p>
<p>put() 用以插入数据到队列中，put 还有两个可选参数：blocked 和 timeout。如果 blocked 为 True（默认值），并且 timeout 为正值，该方法会阻塞 timeout 指定的时间，直到该队列有剩余的空间。如果超时，会抛出 Queue.Full 异常。如果 blocked 为 False，但该 Queue 已满，会立即抛出 Queue.Full 异常。</p>
<p>get()可以从队列读取并且删除一个元素。同样，get 有两个可选参数：blocked 和 timeout。如果 blocked 为 True（默认值），并且 timeout 为正值，那么在等待时间内没有取到任何元素，会抛出 Queue.Empty 异常。如果blocked 为 False，有两种情况存在，如果 Queue 有一个值可用，则立即返回该值，否则，如果队列为空，则立即抛出 Queue.Empty 异常。</p>
<p>具体用法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Queue</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(queue)</span>:</span></span><br><span class="line">    queue.put(<span class="string">'Queue 用法'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    queue = Queue()</span><br><span class="line">    pro = Process(target=put, args=(queue,))</span><br><span class="line">    pro.start()</span><br><span class="line">    print(queue.get())   </span><br><span class="line">    pro.join()</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Pipe</strong></li>
</ul>
<p>Pipe的本质是进程之间的用管道数据传递，而不是数据共享，这和socket有点像。pipe() 返回两个连接对象分别表示管道的两端，每端都有send() 和recv()函数。</p>
<p>如果两个进程试图在同一时间的同一端进行读取和写入那么，这可能会损坏管道中的数据。</p>
<p>具体用法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Pipe</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(conn)</span>:</span></span><br><span class="line">    conn.send(<span class="string">'Pipe 用法'</span>)</span><br><span class="line">    conn.close()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parent_conn, child_conn = Pipe() </span><br><span class="line">    pro = Process(target=show, args=(child_conn,))</span><br><span class="line">    pro.start()</span><br><span class="line">    print(parent_conn.recv())   </span><br><span class="line">    pro.join()</span><br></pre></td></tr></table></figure>

<h4 id="3-3-进程池"><a href="#3-3-进程池" class="headerlink" title="3.3 进程池"></a>3.3 进程池</h4><p>创建多个进程，我们不用傻傻地一个个去创建。我们可以使用<code>Pool</code>模块来搞定。</p>
<p>Pool 常用的方法如下：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>apply()</td>
<td>同步执行（串行）</td>
</tr>
<tr>
<td>apply_async()</td>
<td>异步执行（并行）</td>
</tr>
<tr>
<td>terminate()</td>
<td>立刻关闭进程池</td>
</tr>
<tr>
<td>join()</td>
<td>主进程等待所有子进程执行完毕。必须在close或terminate()之后使用</td>
</tr>
<tr>
<td>close()</td>
<td>等待所有进程结束后，才关闭进程池</td>
</tr>
</tbody></table>
<p>具体用法见示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(num)</span>:</span></span><br><span class="line">    print(<span class="string">'num : '</span> + str(num))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    pool = Pool(processes = <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">6</span>):</span><br><span class="line">        <span class="comment"># 维持执行的进程总数为processes，当一个进程执行完毕后会添加新的进程进去</span></span><br><span class="line">        pool.apply_async(show, args=(i, ))       </span><br><span class="line">    print(<span class="string">'======  apply_async  ======'</span>)</span><br><span class="line">    pool.close()</span><br><span class="line">    <span class="comment">#调用join之前，先调用close函数，否则会出错。执行完close后不会有新的进程加入到pool,join函数等待所有子进程结束</span></span><br><span class="line">    pool.join()</span><br></pre></td></tr></table></figure>

<h3 id="4-选择多线程还是多进程？"><a href="#4-选择多线程还是多进程？" class="headerlink" title="4 选择多线程还是多进程？"></a>4 选择多线程还是多进程？</h3><p>在这个问题上，首先要看下你的程序是属于哪种类型的。一般分为两种 CPU 密集型 和 I/O 密集型。</p>
<ul>
<li>CPU 密集型：程序比较偏重于计算，需要经常使用 CPU 来运算。例如科学计算的程序，机器学习的程序等。</li>
<li>I/O 密集型：顾名思义就是程序需要频繁进行输入输出操作。爬虫程序就是典型的 I/O 密集型程序。</li>
</ul>
<p>如果程序是属于 CPU 密集型，建议使用多进程。而多线程就更适合应用于 I/O 密集型程序。</p>
<p>感谢原文作者:</p>
<p><a href="https://www.jianshu.com/u/f46becd1ed83" target="_blank" rel="noopener">猴哥Yuri</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">Linux进程间通信的几种方式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-01-05 14:54:47 / 修改时间：15:23:27" itemprop="dateCreated datePublished" datetime="2019-01-05T14:54:47+08:00">2019-01-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>进程间通信也是Linux中一个相对基础的内容,网上检索学习回顾一番之后将其记录下来加深记忆,共同学习.</p>
<hr>
<h2 id="进程间通信概述"><a href="#进程间通信概述" class="headerlink" title="进程间通信概述"></a>进程间通信概述</h2><h3 id="进程通信的目的"><a href="#进程通信的目的" class="headerlink" title="进程通信的目的"></a>进程通信的目的</h3><h4 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h4><p>一个进程需要将它的数据发送给另一个进程,发送的数据量在一个字节到几M字节之间</p>
<h4 id="共享数据"><a href="#共享数据" class="headerlink" title="共享数据"></a>共享数据</h4><p>多个进程想要操作共享数据,一个进程对共享数据</p>
<h4 id="通知事件"><a href="#通知事件" class="headerlink" title="通知事件"></a>通知事件</h4><p>一个进程需要向另一个或一组进程发送消息,通知它（它们）发生了某种事件（如进程终止时要通知父进程）.</p>
<h4 id="资源共享"><a href="#资源共享" class="headerlink" title="资源共享"></a>资源共享</h4><p>多个进程之间共享同样的资源.为了作到这一点,需要内核提供锁和同步机制.</p>
<h4 id="进程控制"><a href="#进程控制" class="headerlink" title="进程控制"></a>进程控制</h4><p>有些进程希望完全控制另一个进程的执行（如Debug进程）,此时控制进程希望能够拦截另一个进程的所有陷入和异常,并能够及时知道它的状态改变.</p>
<h3 id="Linux-进程间通信（IPC）的发展"><a href="#Linux-进程间通信（IPC）的发展" class="headerlink" title="Linux 进程间通信（IPC）的发展"></a>Linux 进程间通信（IPC）的发展</h3><p>linux下的进程通信手段基本上是从Unix平台上的进程通信手段继承而来的.而对Unix发展做出重大贡献的两大主力AT&amp;T的贝尔实验室及BSD（加州大学伯克利分校的伯克利软件发布中心）在进程间通信方面的侧重点有所不同.</p>
<p>前者对Unix早期的进程间通信手段进行了系统的改进和扩充,形成了“system V IPC”,通信进程局限在单个计算机内；</p>
<p>后者则跳过了该限制,形成了基于套接口（socket）的进程间通信机制.</p>
<p>Linux则把两者继承了下来</p>
<blockquote>
<p>早期UNIX进程间通信</p>
<p>基于System V进程间通信</p>
<p>基于Socket进程间通信</p>
<p>POSIX进程间通信.</p>
</blockquote>
<p>UNIX进程间通信方式包括：管道、FIFO、信号.</p>
<p>System V进程间通信方式包括：System V消息队列、System V信号灯、System V共享内存</p>
<p>POSIX进程间通信包括：posix消息队列、posix信号灯、posix共享内存.</p>
<p>由于Unix版本的多样性,电子电气工程协会（IEEE）开发了一个独立的Unix标准,这个新的ANSI Unix标准被称为计算机环境的可移植性操作系统界面（PSOIX）.现有大部分Unix和流行版本都是遵循POSIX标准的,而Linux从一开始就遵循POSIX标准；</p>
<p>BSD并不是没有涉足单机内的进程间通信（socket本身就可以用于单机内的进程间通信）.事实上,很多Unix版本的单机IPC留有BSD的痕迹,如4.4BSD支持的匿名内存映射、4.3+BSD对可靠信号语义的实现等等.</p>
<h3 id="linux使用的进程间通信方式"><a href="#linux使用的进程间通信方式" class="headerlink" title="linux使用的进程间通信方式"></a>linux使用的进程间通信方式</h3><p>1.管道（pipe）,流管道(s_pipe)和有名管道（FIFO）</p>
<p>2.信号（signal）</p>
<p>3.消息队列</p>
<p>4.共享内存</p>
<p>5.信号量</p>
<p>6.套接字（socket)</p>
<h4 id="管道-pipe"><a href="#管道-pipe" class="headerlink" title="管道( pipe )"></a>管道( pipe )</h4><p>管道这种通讯方式有两种限制,一是半双工的通信,数据只能单向流动,二是只能在具有亲缘关系的进程间使用.进程的亲缘关系通常是指父子进程关系.</p>
<h4 id="流管道-s-pipe"><a href="#流管道-s-pipe" class="headerlink" title="流管道(s_pipe)"></a>流管道(s_pipe)</h4><p>去除了第一种限制,可以双向传输.管道可用于具有亲缘关系进程间的通信,命名管道:name_pipe克服了管道没有名字的限制,因此,除具有管道所具有的功能外,它还允许无亲缘关系进程间的通信；</p>
<h4 id="信号量-semophore"><a href="#信号量-semophore" class="headerlink" title="信号量( semophore )"></a>信号量( semophore )</h4><p>信号量是一个计数器,可以用来控制多个进程对共享资源的访问.它常作为一种锁机制,防止某进程正在访问共享资源时,其他进程也访问该资源.因此,主要作为进程间以及同一进程内不同线程之间的同步手段.</p>
<p>信号是比较复杂的通信方式,用于通知接受进程有某种事件发生,除了用于进程间通信外,进程还可以发送信号给进程本身；linux除了支持Unix早期信号语义函数sigal外,还支持语义符合Posix.1标准的信号函数sigaction（实际上,该函数是基于BSD的,BSD为了实现可靠信号机制,又能够统一对外接口,用sigaction函数重新实现了signal函数）；</p>
<h4 id="消息队列-message-queue"><a href="#消息队列-message-queue" class="headerlink" title="消息队列( message queue )"></a>消息队列( message queue )</h4><p>消息队列是由消息的链表,存放在内核中并由消息队列标识符标识.消息队列克服了信号传递信息少、管道只能承载无格式字节流以及缓冲区大小受限等缺点.</p>
<p>消息队列是消息的链接表,包括Posix消息队列system V消息队列.有足够权限的进程可以向队列中添加消息,被赋予读权限的进程则可以读走队列中的消息.消息队列克服了信号承载信息量少,管道只能承载无格式字节流以及缓冲区大小受限等缺点.</p>
<h4 id="信号-singal"><a href="#信号-singal" class="headerlink" title="信号 ( singal )"></a>信号 ( singal )</h4><p>信号是一种比较复杂的通信方式,用于通知接收进程某个事件已经发生.</p>
<p>主要作为进程间以及同一进程不同线程之间的同步手段.</p>
<h4 id="共享内存-shared-memory"><a href="#共享内存-shared-memory" class="headerlink" title="共享内存( shared memory )"></a>共享内存( shared memory )</h4><p>共享内存就是映射一段能被其他进程所访问的内存,这段共享内存由一个进程创建,但多个进程都可以访问.共享内存是最快的 IPC 方式,它是针对其他进程间通信方式运行效率低而专门设计的.它往往与其他通信机制,如信号量,配合使用,来实现进程间的同步和通信.</p>
<p>使得多个进程可以访问同一块内存空间,是最快的可用IPC形式.是针对其他通信机制运行效率较低而设计的.往往与其它通信机制,如信号量结合使用,来达到进程间的同步及互斥.</p>
<h4 id="套接字-socket"><a href="#套接字-socket" class="headerlink" title="套接字( socket )"></a>套接字( socket )</h4><p>套解口也是一种进程间通信机制,与其他通信机制不同的是,它可用于不同机器间的进程通信</p>
<p>更为一般的进程间通信机制,可用于不同机器之间的进程间通信.起初是由Unix系统的BSD分支开发出来的,但现在一般可以移植到其它类Unix系统上：Linux和System V的变种都支持套接字.</p>
<p>进程间通信各种方式效率比较</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>无连接</th>
<th>可靠</th>
<th>流控制</th>
<th>优先级</th>
</tr>
</thead>
<tbody><tr>
<td>普通PIPE</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>流PIPE</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>命名PIPE(FIFO)</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>消息队列</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>信号量</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>共享存储</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>UNIX流SOCKET</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>UNIX数据包SOCKET</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
</tbody></table>
<p>注:无连接: 指无需调用某种形式的OPEN,就有发送消息的能力流控制;如果系统资源短缺或者不能接收更多消息,则发送进程能进行流量控制</p>
<h3 id="各种通信方式的比较和优缺点"><a href="#各种通信方式的比较和优缺点" class="headerlink" title="各种通信方式的比较和优缺点"></a>各种通信方式的比较和优缺点</h3><p>管道：速度慢,容量有限,只有父子进程能通讯</p>
<p>FIFO：任何进程间都能通讯,但速度慢</p>
<p>消息队列：容量受到系统限制,且要注意第一次读的时候,要考虑上一次没有读完数据的问题</p>
<p>信号量：不能传递复杂消息,只能用来同步</p>
<p>共享内存区：能够很容易控制容量,速度快,但要保持同步,比如一个进程在写的时候,另一个进程要注意读写的问题,相当于线程中的线程安全,当然,共享内存区同样可以用作线程间通讯,不过没这个必要,线程间本来就已经共享了同一进程内的一块内存</p>
<p>如果用户传递的信息较少或是需要通过信号来触发某些行为．前文提到的软中断信号机制不失为一种简捷有效的进程间通信方式．</p>
<p>但若是进程间要求传递的信息量比较大或者进程间存在交换数据的要求,那就需要考虑别的通信方式了.</p>
<p>无名管道简单方便．但局限于单向通信的工作方式．并且只能在创建它的进程及其子孙进程之间实现管道的共享：</p>
<p>有名管道虽然可以提供给任意关系的进程使用．但是由于其长期存在于系统之中,使用不当容易出错．所以普通用户一般不建议使用.</p>
<p>消息缓冲可以不再局限于父子进程,而允许任意进程通过共享消息队列来实现进程间通信,并由系统调用函数来实现消息发送和接收之间的同步,从而使得用户在使用消息缓冲进行通信时不再需要考虑同步问题,使用方便,但是信息的复制需要额外消耗CPU的时间,不适宜于信息量大或操作频繁的场合.</p>
<p>共享内存针对消息缓冲的缺点改而利用内存缓冲区直接交换信息,无须复制,快捷、信息量大是其优点.</p>
<p>但是共享内存的通信方式是通过将共享的内存缓冲区直接附加到进程的虚拟地址空间中来实现的,因此,这些进程之间的读写操作的同步问题操作系统无法实现.必须由各进程利用其他同步工具解决.另外,由于内存实体存在于计算机系统中,所以只能由处于同一个计算机系统中的诸进程共享.不方便网络通信.</p>
<p>共享内存块提供了在任意数量的进程之间进行高效双向通信的机制.每个使用者都可以读取写入数据,但是所有程序之间必须达成并遵守一定的协议,以防止诸如在读取信息之前覆写内存空间等竞争状态的出现.</p>
<p>不幸的是,Linux无法严格保证提供对共享内存块的独占访问,甚至是在您通过使用IPC_PRIVATE创建新的共享内存块的时候也不能保证访问的独占性. 同时,多个使用共享内存块的进程之间必须协调使用同一个键值.</p>
<p>感谢原文作者:</p>
<p> <a href="https://me.csdn.net/gatieme" target="_blank" rel="noopener">JeanCheng</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/CLI%E5%88%9B%E5%BB%BA%E5%B9%B6%E4%BD%BF%E7%94%A8KVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/CLI%E5%88%9B%E5%BB%BA%E5%B9%B6%E4%BD%BF%E7%94%A8KVM/" class="post-title-link" itemprop="url">CLI创建并使用KVM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-01-03 10:22:47 / 修改时间：10:40:27" itemprop="dateCreated datePublished" datetime="2019-01-03T10:22:47+08:00">2019-01-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在虚拟机中搭建KVM实验环境并实现KVM虚拟机之间的网络通信及分布式网站架构.实验中直接使用命令行界面实现虚拟机中系统的安装和配置,免去了图形化界面操作的步骤.系统安装完成之后配置虚拟网卡,配置虚拟网段及实现远程连接,分布式网站中跳板机的设置及ip过滤,模拟了一个小型网站的架构后期可以使用docker来替代KVM以实现更好的实验效果.</p>
<p>整个实验从配置环境到安装虚拟机,配置软件环境,配置网络通信等方面实现了KVM虚拟机环境配置的需求.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br></pre></td><td class="code"><pre><span class="line">1.检测是否支持KVM</span><br><span class="line">KVM 是基于 x86 虚拟化扩展(Intel VT 或者 AMD-V) 技术的虚拟机软件，所以查看 CPU 是否支持 VT 技术，</span><br><span class="line">就可以判断是否支持KVM。有返回结果，如果结果中有vmx（Intel）或svm(AMD)字样，就说明CPU的支持的。切记</span><br><span class="line">在VMware CPU选项下点击CPU虚拟化</span><br><span class="line"><span class="meta">#</span><span class="bash"> cat /proc/cpuinfo | egrep <span class="string">'vmx|svm'</span></span></span><br><span class="line">关闭 Selinux 和 firewalld </span><br><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/selinux</span></span><br><span class="line">selinux=disabled</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl stop firewalld</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl disabled firewalld</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iptables -F</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iptables -vnL</span></span><br><span class="line"></span><br><span class="line">2.安装KVM环境</span><br><span class="line">yum -y install qemu-kvm python-virtinst libvirt libvirt-python virt-manager libguestfs-tools bridge-utils virt-install kvm acpid</span><br><span class="line">装载 kvm 模块</span><br><span class="line"><span class="meta">#</span><span class="bash"> modprobe kvm</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> lsmod | grep kvm</span></span><br><span class="line">开启KVM服务,并设置开机自动启动</span><br><span class="line">systemctl start acpid.service</span><br><span class="line">systemctl enable acpid.service</span><br><span class="line">systemctl start libvirtd.service</span><br><span class="line">systemctl enable libvirtd.service</span><br><span class="line"></span><br><span class="line">3.安装虚拟机</span><br><span class="line">kvm创建虚拟机，特别注意.iso镜像文件一定放到/home 或者根目录重新创建目录，不然会因为权限报</span><br><span class="line">错，无法创建虚拟机。</span><br><span class="line">首先要创建一个虚拟网桥br0,无法创建的话就删除网卡原来的配置文件,然后重新生成(记得备份)</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh iface-bridge ens33 br0</span></span><br><span class="line">然后开始创建虚拟机</span><br><span class="line">创建虚拟机之前最好先把网桥设好并规划好网段,这样下次再创建虚拟机的时候可以直接连接到网桥上.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> virt-install \</span></span><br><span class="line">--name=centos7C1 \</span><br><span class="line">--vcpus=2 \</span><br><span class="line">--memory=4096 \</span><br><span class="line">--location=/tmp/CentOS-7-x86_64-Minimal-1511.iso \</span><br><span class="line">--disk path=/home/vms/c1/centosC1.qcow2,size=40,format=qcow2 \</span><br><span class="line">--network bridge=br0 \</span><br><span class="line">--graphics none \</span><br><span class="line">--extra-args='console=ttyS0' \</span><br><span class="line">--force</span><br><span class="line"></span><br><span class="line">选项参考:</span><br><span class="line">name: 虚拟机名</span><br><span class="line">vcpus: 虚拟cpu数量</span><br><span class="line">memory: 虚拟内存大小</span><br><span class="line">location: ios文件路径</span><br><span class="line">没有的话可以手动在 ftp 服务器上下载:</span><br><span class="line"><span class="meta">#</span><span class="bash"> wget ftp://172.20.0.1/pub/ISOs/CentOS/CentOS-7-x86_64-Minimal-1511.iso</span></span><br><span class="line">disk path: 虚拟机安装位置</span><br><span class="line">network bridge: 网桥名称</span><br><span class="line">graphics: 图形界面</span><br><span class="line"></span><br><span class="line">4.命令行配置系统:</span><br><span class="line">上面创建虚拟机命令最终需要你配置系统基础设置，带 [!] 基本都是要配置的，按照顺序往下配置，</span><br><span class="line">按对用的数字以此进行设置。</span><br><span class="line">Installation</span><br><span class="line"></span><br><span class="line"> 1) [x] Language settings                 2) [!] Timezone settings</span><br><span class="line">        (English (United States))                (Timezone is not set.)</span><br><span class="line"> 3) [!] Installation source               4) [!] Software selection</span><br><span class="line">        (Processing...)                          (Processing...)</span><br><span class="line"> 5) [!] Installation Destination          6) [x] Kdump</span><br><span class="line">        (No disks selected)                      (Kdump is enabled)</span><br><span class="line"> 7) [ ] Network configuration             8) [!] Root password</span><br><span class="line">        (Not connected)                          (Password is not set.)</span><br><span class="line"> 9) [!] User creation</span><br><span class="line">        (No user will be created)</span><br><span class="line">  Please make your choice from above ['q' to quit | 'b' to begin installation |</span><br><span class="line">  'r' to refresh]:</span><br><span class="line">  </span><br><span class="line"><span class="meta">&gt;</span><span class="bash">2 Timezone settings 时区设置选择 5) Asia亚洲，再选择城市 62) Shanghai上海</span></span><br><span class="line"></span><br><span class="line">Available regions</span><br><span class="line"> 1)  Africa                 6)  Atlantic              10)  Pacific</span><br><span class="line"> 2)  America                7)  Australia             11)  US</span><br><span class="line"> 3)  Antarctica             8)  Europe                12)  Etc</span><br><span class="line"> 4)  Arctic                 9)  Indian</span><br><span class="line"> 5)  Asia</span><br><span class="line">Please select the timezone.</span><br><span class="line">Use numbers or type names directly [b to region list, q to quit]: 5</span><br><span class="line">--------------------</span><br><span class="line"></span><br><span class="line"> 8)  Baghdad               35)  Kathmandu             61)  Seoul</span><br><span class="line"> 9)  Bahrain               36)  Khandyga              62)  Shanghai</span><br><span class="line">10)  Baku                  37)  Kolkata               63)  Singapore</span><br><span class="line">26)  Hong_Kong             53)  Pontianak</span><br><span class="line">27)  Hovd</span><br><span class="line">Please select the timezone.</span><br><span class="line">Use numbers or type names directly [b to region list, q to quit]: 62</span><br><span class="line"></span><br><span class="line">Installation source 安装源输入数字2</span><br><span class="line">Choose an installation source type.</span><br><span class="line"> 1)  CD/DVD</span><br><span class="line"> 2)  local ISO file</span><br><span class="line"> 3)  Network</span><br><span class="line">  Please make your choice from above ['q' to quit | 'c' to continue |</span><br><span class="line">  'r' to refresh]: 2</span><br><span class="line">  </span><br><span class="line">Software selection 软件选择:</span><br><span class="line">Base environment</span><br><span class="line">Software selection</span><br><span class="line"></span><br><span class="line">Base environment</span><br><span class="line"></span><br><span class="line"> 1)  [x] Minimal Install</span><br><span class="line">  Please make your choice from above ['q' to quit | 'c' to continue |</span><br><span class="line">  'r' to refresh]:</span><br><span class="line">  </span><br><span class="line">Installation Destination 安装目的地</span><br><span class="line">Installation Destination</span><br><span class="line"></span><br><span class="line">[x] 1) : 40 GiB (vda)</span><br><span class="line"></span><br><span class="line">1 disk selected; 40 GiB capacity; 40 GiB free ...</span><br><span class="line"></span><br><span class="line">  Please make your choice from above ['q' to quit | 'c' to continue |</span><br><span class="line">  'r' to refresh]: c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Autopartitioning Options 自动分区选项</span><br><span class="line"></span><br><span class="line">[ ] 1) Replace Existing Linux system(s) 替换现有的Linux系统</span><br><span class="line"></span><br><span class="line">[x] 2) Use All Space 使用所有空间</span><br><span class="line"></span><br><span class="line">[ ] 3) Use Free Space 使用可用空间</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">Partition Scheme Options 分区方案选项</span><br><span class="line"></span><br><span class="line">[ ] 1) Standard Partition 标准分区</span><br><span class="line"></span><br><span class="line">[ ] 2) Btrfs Btrfs</span><br><span class="line"></span><br><span class="line">[x] 3) LVM LVM(逻辑卷管理)</span><br><span class="line"></span><br><span class="line">[ ] 4) LVM Thin Provisioning 精简配置</span><br><span class="line"></span><br><span class="line">Select a partition scheme configuration.</span><br><span class="line"></span><br><span class="line">  Please make your choice from above ['q' to quit | 'c' to continue |</span><br><span class="line">  'r' to refresh]: c</span><br><span class="line"></span><br><span class="line">然后输入8录入root账户的密码</span><br><span class="line">  </span><br><span class="line">此处也可以只设置 Root 密码和Installation Destination 安装目的地其它进入系统设置比如时区设置如下：</span><br><span class="line">echo "TZ='Asia/Shanghai'; export TZ" &gt;&gt; /etc/profile  </span><br><span class="line"></span><br><span class="line">选择完成后输入 b 就可以开始安装系统了.</span><br><span class="line">安装完成之后默认是在桌面环境的.直接登录并操作即可.</span><br><span class="line"></span><br><span class="line">安装完成之后第一次启动网卡eth0是获取不到ip地址的,所以需要手动启动</span><br><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl restart network</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ip a</span></span><br><span class="line">查看到ip地址之后最好将ip地址固定下来,方便以后使用</span><br><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=172.20.124.138</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.添加第一个网桥之后还需要对网桥进行控制划分其他的网段</span><br><span class="line"><span class="meta">#</span><span class="bash"> brctl show</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/libvirt/qemu/networks</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp default.xml mynet1.xml </span></span><br><span class="line"></span><br><span class="line">拷贝完成之后需要对配置文件进行修改如修改网桥名称,划分子网范围</span><br><span class="line"><span class="meta">#</span><span class="bash"> vi mynet1.xml </span></span><br><span class="line">&lt;network&gt;</span><br><span class="line">  &lt;name&gt;mynet1&lt;/name&gt;</span><br><span class="line">  &lt;bridge name='mybr1' stp='on' delay='0'/&gt;</span><br><span class="line">  &lt;ip address='12.20.20.40' netmask='255.255.255.0'&gt;</span><br><span class="line">    &lt;dhcp&gt;</span><br><span class="line">      &lt;range start='12.20.20.12' end='12.20.20.100'/&gt;</span><br><span class="line">    &lt;/dhcp&gt;</span><br><span class="line">  &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line">配置文件修改完成之后即可创建网桥</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh net-create mynet1.xml</span></span><br><span class="line">查看虚拟网桥信息</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh net-list</span></span><br><span class="line"></span><br><span class="line">6.VM虚拟机添加网卡并配置网络</span><br><span class="line"><span class="meta">1&gt;</span><span class="bash">手动添加网桥并插入虚拟机</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh domiflist centos7C1</span></span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0      bridge     br0        virtio      52:54:00:8c:b8:60</span><br><span class="line"></span><br><span class="line"><span class="meta">2&gt;</span><span class="bash">成功附加接口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh attach-interface centos7C1 --<span class="built_in">type</span> bridge --<span class="built_in">source</span> br0 </span></span><br><span class="line"></span><br><span class="line">永久添加网卡命令</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh attach-interface centos7C1 --<span class="built_in">type</span> bridge --<span class="built_in">source</span> br0  --config</span></span><br><span class="line"></span><br><span class="line"><span class="meta">3&gt;</span><span class="bash">查看添加网卡的信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh domiflist centos7C1</span></span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0      bridge     br0        virtio      52:54:00:8c:b8:60</span><br><span class="line">vnet1      bridge     br0        -           52:54:00:14:86:cf</span><br><span class="line">在KVM中查看添加的信息:</span><br><span class="line">ip a</span><br><span class="line"></span><br><span class="line"><span class="meta">4&gt;</span><span class="bash">命令行增加的网卡只保存在内存中，重启就失效，所以需要保存到配置文件中</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh dumpxml centos7C1 &gt;/etc/libvirt/qemu/centos7C1.xml </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh define /etc/libvirt/qemu/centos7C1.xml </span></span><br><span class="line"></span><br><span class="line">删除网卡命令</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh detach-interface centos7C1  --<span class="built_in">type</span> bridge --mac  52:54:00:14:86:cf</span></span><br><span class="line">成功分离接口</span><br><span class="line"></span><br><span class="line">7.克隆KVM虚拟机,创建虚拟机镜像.</span><br><span class="line">暂停原始虚拟机</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh shutdown centos72</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virt-clone -o centos72 -n centos.112 -f /home/vms/centos.112.qcow2 -m 00:00:00:00:00:01</span></span><br><span class="line"></span><br><span class="line">复制第一次安装的干净系统镜像，作为基础镜像文件，</span><br><span class="line">后面创建虚拟机使用这个基础镜像</span><br><span class="line">cp /home/vms/centos.88.qcow2 /home/vms/centos7.base.qcow2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用基础镜像文件，创建新的虚拟机镜像</span></span><br><span class="line">cp /home/vms/centos7.base.qcow2 /home/vms/centos7.113.qcow2</span><br><span class="line"></span><br><span class="line">8.热插拔网卡实现切换网桥</span><br><span class="line">查看当前宿主机网卡的状态</span><br><span class="line"><span class="meta">#</span><span class="bash"> brctl show</span></span><br><span class="line">查看KVM虚拟机的运行状态</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh list</span></span><br><span class="line">查看KVM虚拟机网卡列表</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh domiflist centos7C1</span></span><br><span class="line"></span><br><span class="line">添加一个网卡到物理桥myBr1上</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh attach-interface centos7C1 bridge myBr1</span></span><br><span class="line">撤销网卡，撤销网卡前先关闭网卡</span><br><span class="line"><span class="meta">#</span><span class="bash"> ip link <span class="built_in">set</span> dev ens10 down</span></span><br><span class="line">注意：撤销某一块网卡要指定该网卡的MAC，要不会撤销该网卡所在网桥上所有的网卡</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh detach-interface centos7C1 bridge --mac 52:54:00:f1:22:5b</span></span><br><span class="line"></span><br><span class="line">9.分布式部署LAMP</span><br><span class="line">9.1 HTTPD的实现</span><br><span class="line"><span class="meta">#</span><span class="bash"> yum -y install httpd</span></span><br><span class="line">修改主配置文件，把php的首页加上</span><br><span class="line"><span class="meta">#</span><span class="bash"> vi httpd.conf </span></span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">    DirectoryIndex index.php index.html</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">新建虚拟主机文件,对php文件做解析的服务器的地址可以暂时不写.等软件部署成功之后再补上.</span><br><span class="line">[root@web-server conf.d]# vi www.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">        ServerName  www.dklwj.com</span><br><span class="line">        DocumentRoot "/vhosts/www/htdocs"</span><br><span class="line">        &lt;Directory "/vhosts/www/htdocs"&gt;</span><br><span class="line">                Options FollowSymLinks</span><br><span class="line">                AllowOverride None</span><br><span class="line">                Require all granted</span><br><span class="line">        &lt;/directory&gt;</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPassMatch ^/(.*\.php)$ fcgi://192.168.137.147:9000/vhosts/www/htdocs/$1</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">创建虚拟主机的目录</span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir /vhosts/www/htdocs -p</span></span><br><span class="line">修改目录的所属组的权限为apache</span><br><span class="line"><span class="meta">#</span><span class="bash"> chown -R apache.apache /vhosts/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /vhosts/www/htdocs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"&lt;h1&gt;It works!!&lt;/h1&gt;"</span> &gt; ./index.html</span></span><br><span class="line"></span><br><span class="line">启动http服务,查看80端口有没有被监听.</span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl start httpd            </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ss -tnl </span></span><br><span class="line">State      Recv-Q Send-Q  Local Address:Port                 Peer Address:Port              </span><br><span class="line">LISTEN     0      128                 *:22                              *:*                  </span><br><span class="line">LISTEN     0      100         127.0.0.1:25                              *:*                  </span><br><span class="line">LISTEN     0      128                :::80                             :::*                  </span><br><span class="line">LISTEN     0      128                :::22                             :::*                  </span><br><span class="line">LISTEN     0      100               ::1:25                             :::*  </span><br><span class="line"></span><br><span class="line">服务启动之后可以在本机上查看访问html网页的效果,这里就不修改 hosts 文件来实现域名的跳转了</span><br><span class="line"><span class="meta">#</span><span class="bash"> curl 192.168.100.233/index.html</span></span><br><span class="line"></span><br><span class="line">9.2 php-fpm的实现</span><br><span class="line">安装php-fpm 和php-mysql模块</span><br><span class="line"><span class="meta">#</span><span class="bash"> yum -y install php-fpm php-mysql</span></span><br><span class="line"></span><br><span class="line">修改配置文件</span><br><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/php-fpm.d/www.conf </span></span><br><span class="line"><span class="meta">#</span><span class="bash">作为单独服务运行需要把监听端口改成所有接口，http后续会使用反代</span></span><br><span class="line">listen = 0.0.0.0:9000  </span><br><span class="line"><span class="meta">#</span><span class="bash">只允许192.168.137.144这台服务器也就是http服务器</span></span><br><span class="line">listen.allowed_clients = 192.168.100.233</span><br><span class="line"> </span><br><span class="line">创建php程序存放路径</span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir /vhosts/www/htdocs -p</span></span><br><span class="line"></span><br><span class="line">进入目录然后创建一个php测试页面</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /vhosts/www/htdocs/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vim info.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">        phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">启动PHP服务</span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl start php-fpm</span></span><br><span class="line"></span><br><span class="line">测试对php网页的反向代理是否可以实现</span><br><span class="line"><span class="meta">#</span><span class="bash"> curl 192.168.100.233/info.php</span></span><br><span class="line"></span><br><span class="line">9.3 MariaDB的实现</span><br><span class="line"><span class="meta">#</span><span class="bash"> yum -y install mariadb-server</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置mariadb禁止解析反向IP地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip_name_resolve=on</span><br><span class="line"></span><br><span class="line">修改mysql的root密码然后删除匿名用户</span><br><span class="line">[root@mysql-server ~]# mysql</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 2</span><br><span class="line">Server version: 5.5.56-MariaDB MariaDB Server</span><br><span class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line">MariaDB [(none)]&gt; use mysql</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [mysql]&gt; update user set password=password('123456') where user='root';</span><br><span class="line">Query OK, 4 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 4  Changed: 4  Warnings: 0</span><br><span class="line">MariaDB [mysql]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">MariaDB [mysql]&gt; drop user ''@'localhost';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">MariaDB [mysql]&gt; drop user ''@'mysql-server';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">MariaDB [mysql]&gt; select user,host,password from user;</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| user | host         | password                                  |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| root | localhost    | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span><br><span class="line">| root | mysql-server | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span><br><span class="line">| root | 127.0.0.1    | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span><br><span class="line">| root | ::1          | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">在php服务器上创一个测试一个连接数据库的页面</span><br><span class="line">[root@php-server /vhosts/www/htdocs]#vim mysql.php</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta">$</span><span class="bash">link=mysql_connect(<span class="string">"192.168.137.148"</span>,<span class="string">"root"</span>,<span class="string">"123456"</span>);  </span></span><br><span class="line">if(!$link) echo "FAILD,Error!";</span><br><span class="line">else echo "OK.......!";</span><br><span class="line"></span><br><span class="line">测试对php访问数据库模块是否可以正常工作</span><br><span class="line"><span class="meta">#</span><span class="bash"> curl 192.168.100.233/mysql.php</span></span><br><span class="line"></span><br><span class="line">9.4部署WordPress软件</span><br><span class="line"></span><br><span class="line">在php服务器上下载WordPress包，这里需要强调一下，目录需要添加写权限要不然回出现文件无法写入的情况.</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /vhosts/www/</span></span><br><span class="line">wordpress文件自行在官网下载</span><br><span class="line"><span class="meta">#</span><span class="bash"> tar xf wordpress-4.9.4-zh_CN.tar.gz</span></span><br><span class="line">删除原有存放网页的 htdoc 文件夹并将其以软连接形式呈现</span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf htdocs/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ln -sv wordpress htdocs</span></span><br><span class="line"></span><br><span class="line">在把软件包复制一份到http上去里面静态资源需要由HTTP来处理所以两台服务器得各放一份</span><br><span class="line"><span class="meta">#</span><span class="bash"> scp -r wordpress root@192.168.137.144:/vhosts/www/</span></span><br><span class="line"></span><br><span class="line">在数据库服务器上创建所需要的库和帐号</span><br><span class="line">MariaDB [(none)]&gt; create database blog;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">MariaDB [(none)]&gt; grant all on blog.* to 'wpuser'@'%' identified by 'wppass';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">在HTTP服务器上配置</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /vhosts/www</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ls</span></span><br><span class="line">htdocs  index.html  wordpress</span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf htdocs/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ln -s wordpress/ htdocs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ll </span></span><br><span class="line">lrwxrwxrwx. 1 root   root     10 Oct 29 21:51 htdocs -&gt; wordpress/</span><br><span class="line">drwxr-xr-x. 5 root   root   4096 Oct 29 21:50 wordpress</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chown -R apache.apache www/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ll </span></span><br><span class="line">lrwxrwxrwx. 1 apache apache   10 Oct 29 21:51 htdocs -&gt; wordpress/</span><br><span class="line">drwxr-xr-x. 5 apache apache 4096 Oct 29 21:50 wordpress</span><br><span class="line"></span><br><span class="line">部署完成之后即可在浏览器上访问然后配置wordpress了,配置步骤不明白的可自行google,注意在php服务器上添加</span><br><span class="line">/vhosts/www/wordpress/wp-config.php 这个文件,这是wordpress的配置文件.</span><br><span class="line"></span><br><span class="line">10.隐藏真实主机网络访问控制</span><br><span class="line">现在我们一共有4台KVM虚拟机,DB服务器和php服务器不能暴露在外网环境中而实现操控和访问的httpd服务器和跳板</span><br><span class="line">机反而要对外实现通信,因此需要对网络进行设置</span><br><span class="line">10.1 网桥的准备工作</span><br><span class="line">之前已经设置好了可以访问外网桥街的br0,接下需要新建两个内网通信的网桥</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/libvirt/qemu/networks/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> brctl show</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp default.xml mynet1.xml</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi mynet1.xml</span></span><br><span class="line">&lt;network&gt;</span><br><span class="line">  &lt;name&gt;mynet1&lt;/name&gt;</span><br><span class="line">  &lt;bridge name='mybr1' stp='on' delay='0'/&gt;</span><br><span class="line">  &lt;ip address='10.10.10.1' netmask='255.255.255.0'&gt;</span><br><span class="line">    &lt;dhcp&gt;</span><br><span class="line">      &lt;range start='10.10.10.10' end='10.10.10.100'/&gt;</span><br><span class="line">    &lt;/dhcp&gt;</span><br><span class="line">  &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh net-create mynet1.xml </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp mynet1.xml mynet2.xml </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi mynet2.xml </span></span><br><span class="line"></span><br><span class="line">&lt;network&gt;</span><br><span class="line">  &lt;name&gt;mynet2&lt;/name&gt;</span><br><span class="line">  &lt;bridge name='mybr2' stp='on' delay='0'/&gt;</span><br><span class="line">  &lt;ip address='20.20.20.1' netmask='255.255.255.0'&gt;</span><br><span class="line">    &lt;dhcp&gt;</span><br><span class="line">      &lt;range start='20.20.20.20' end='20.20.20.100'/&gt;</span><br><span class="line">    &lt;/dhcp&gt;</span><br><span class="line">  &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh net-create mynet2.xml </span></span><br><span class="line">10.2为虚拟机配置网桥</span><br><span class="line">主要是对网卡的插拔操作,上文中有提到如何热插拔网卡实现切换网桥</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh attach-interface centos7C1 --<span class="built_in">type</span> bridge --<span class="built_in">source</span> mybr1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh attach-interface centos7C2 --<span class="built_in">type</span> bridge --<span class="built_in">source</span> mybr2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh detach-interface centos7C2 --<span class="built_in">type</span> bridge --mac 52:54:00:9c:0f:b4</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh attach-interface centos7C3 --<span class="built_in">type</span> bridge --<span class="built_in">source</span> mybr2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh detach-interface centos7C3 --<span class="built_in">type</span> bridge --mac 52:54:00:16:a8:a6</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh attach-interface centos7C4 --<span class="built_in">type</span> bridge --<span class="built_in">source</span> mybr2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh attach-interface centos7C4 --<span class="built_in">type</span> bridge --<span class="built_in">source</span> mybr1</span></span><br><span class="line"></span><br><span class="line">网桥插拔完成之后对虚拟机的网络接入情况进行查看:</span><br><span class="line">[root@localhost vms]# virsh domiflist centos7C1</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0      bridge     br0        virtio      52:54:00:13:29:30</span><br><span class="line">vnet5      bridge     mybr1      rtl8139     52:54:00:a9:b8:6c</span><br><span class="line"></span><br><span class="line">[root@localhost vms]# virsh domiflist centos7C2</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet1      bridge     mybr1      virtio      52:54:00:f6:c9:d0</span><br><span class="line">vnet6      bridge     mybr2      rtl8139     52:54:00:87:f1:0d</span><br><span class="line"></span><br><span class="line">[root@localhost vms]# virsh domiflist centos7C3</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet2      bridge     mybr2      rtl8139     52:54:00:1e:ab:d6</span><br><span class="line"></span><br><span class="line">[root@localhost vms]# virsh domiflist centos7C4</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet4      bridge     br0        virtio      52:54:00:6f:fa:c7</span><br><span class="line">vnet3      bridge     mybr2      rtl8139     52:54:00:78:ea:44</span><br><span class="line">vnet7      bridge     mybr1      rtl8139     52:54:00:c4:61:9b </span><br><span class="line"></span><br><span class="line">查看网桥及网卡的连接情况:</span><br><span class="line"><span class="meta">#</span><span class="bash"> brctl show</span></span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">br0             8000.000c29120c94       yes             ens33</span><br><span class="line">                                                        vnet0</span><br><span class="line">                                                        vnet4</span><br><span class="line">mybr1           8000.525400c30ff7       yes             mybr1-nic</span><br><span class="line">                                                        vnet1</span><br><span class="line">                                                        vnet5</span><br><span class="line">                                                        vnet7</span><br><span class="line">mybr2           8000.525400dc598f       yes             mybr2-nic</span><br><span class="line">                                                        vnet2</span><br><span class="line">                                                        vnet3</span><br><span class="line">                                                        vnet6</span><br><span class="line">virbr0          8000.525400a975d4       yes             virbr0-nic</span><br><span class="line"> </span><br><span class="line">然后按照下面定义的网络地址来配置虚拟机的网络,网卡名有改变,但是不影响操作.</span><br><span class="line">Mysql(C3)</span><br><span class="line">ens8:20.20.20.35</span><br><span class="line">FPM(C2)</span><br><span class="line">ens9:20.20.20.63</span><br><span class="line">eth0:10.10.10.12</span><br><span class="line">HTTPD(C1)</span><br><span class="line">eth8:10.10.10.95</span><br><span class="line">eth1:172.20.124.138</span><br><span class="line">JUMPS(C4):16.40.40.80</span><br><span class="line">ens9:10.10.10.73 e78fde6e-933c-4ee4-851b-4b4a5fe7e744</span><br><span class="line">ens8:20.20.20.87 8bad1d1e-2247-4c54-a4e0-60094beddcdd</span><br><span class="line">eth0:172.20.124.151</span><br><span class="line">网桥设置:</span><br><span class="line">mybr1(host only):</span><br><span class="line">ip:10.10.10.1/24</span><br><span class="line">dhcp range:10.10.10.10 10.10.10.100</span><br><span class="line">mybr2(host only):</span><br><span class="line">ip:20.20.20.1/24</span><br><span class="line">dhcp range:20.20.20.20 20.20.20.100</span><br><span class="line">br0(nat):</span><br><span class="line">ip:192.168.122.1/24</span><br><span class="line">dhcp range: 192.168.122.2 192.168.122.254</span><br><span class="line">这样设置的话不同的主机就存在与不同的网域中,外界就没法直接访问敏感服务器咯.</span><br><span class="line"></span><br><span class="line">跳板机的网络设置</span><br><span class="line"></span><br><span class="line">mysql iptables rule</span><br><span class="line">	允许跳板机的ssh</span><br><span class="line">      iptables -A INPUT -d 10.10.20.20 -s 10.10.20.100 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">      iptables -A OUTPUT -s 10.10.20.20 -d 10.10.20.100 -p tcp --sport 22 -j ACCEPT</span><br><span class="line">    拒绝所有连接</span><br><span class="line">     iptables -A INPUT -j DROP</span><br><span class="line">     iptables -A OUTPUT -j DROP</span><br><span class="line">    允许php的IP连接数据库</span><br><span class="line">     iptables -I INPUT -d 10.10.20.20 -s 10.10.20.30 -p tcp --dport 3306 -j ACCEPT </span><br><span class="line">     iptables -I OUTPUT -s 10.10.20.20 -d 10.10.20.30 -p tcp --sport 3306 -j ACCEPT    	</span><br><span class="line"></span><br><span class="line">PHP iptables rule</span><br><span class="line">   允许跳板机的ssh</span><br><span class="line">     iptables -A INPUT -d 172.30.20.30 -s 172.30.20.100 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">     iptables -A OUTPUT -s 172.30.20.30 -d 172.30.20.100 -p tcp --sport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line">    拒绝所有连接</span><br><span class="line">     iptables -A INPUT -j ACCEPT</span><br><span class="line">     iptables -A OUTPUT -j ACCEPT</span><br><span class="line"></span><br><span class="line">    允许httpd的反代端口9000通过</span><br><span class="line"><span class="meta">	#</span><span class="bash"> iptables -I INPUT -d 172.30.20.30 -s 172.30.20.152 -p tcp --dport 9000 -j ACCEPT</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> iptables -I OUTPUT -s 172.30.20.30 -d 172.30.20.152 -p tcp --sport 9000 -j ACCEPT </span></span><br><span class="line">      </span><br><span class="line"><span class="meta">	#</span><span class="bash"> iptables -I OUTPUT -d 10.10.20.20 -s 10.10.20.30 -p tcp --dport 3306 -j ACCEPT</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> iptables -I INPUT -d 10.10.20.30 -s 10.10.20.20 -p tcp --sport 3306 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTPD iptables rule</span><br><span class="line"> 允许跳板机的ssh</span><br><span class="line">    # iptables -A INPUT -d 172.30.20.152 -s 172.30.20.100 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">    #iptables -A OUTPUT -s 172.30.20.152 -d 172.30.20.100 -p tcp --sport 22 -j ACCEPT</span><br><span class="line"> 拒绝所有连接</span><br><span class="line">    # iptables -A INPUT -j DROP</span><br><span class="line">    # iptables -A OUTPUT -j DROP</span><br><span class="line"> 允许客户端通过外网接口访问80和443接口</span><br><span class="line"> 	进口配置</span><br><span class="line">    # iptables -I INPUT -d 192.168.137.152 -i eth0 -p tcp -m multiport --dports 80,443 -j ACCEPT</span><br><span class="line">   出口设置</span><br><span class="line">    # iptables -I OUTPUT -s 192.168.137.152 -o eth0 -p tcp -m multiport --sports 80,443 -j ACCEPT</span><br><span class="line"></span><br><span class="line">   允许http能连接到后端的PHP服务器的9000端口</span><br><span class="line">    # iptables -I OUTPUT -d 172.30.20.30 -s 172.30.20.152 -p tcp --dport 9000 -j ACCEPT</span><br><span class="line">    # iptables -I INPUT -d 172.30.20.152 -s 172.30.20.30 -p tcp --sport 9000 -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">补充:</span><br><span class="line">使用dhcp分配网络地址之后没有相应的网络配置文件</span><br><span class="line">解决方案:</span><br><span class="line">1.使用nmcli con show命令，查看网卡的UUID信息，记下UUID值</span><br><span class="line"><span class="meta">#</span><span class="bash"> nmcli con show</span></span><br><span class="line">2.使用ip addr命令查看网卡信息，记下ens37网卡的MAC地址</span><br><span class="line">3.将 /etc/sysconfig/network-scripts/目录中ifcfg-ens33文件复制一份，并命名为 ifcfg-ens37，</span><br><span class="line">重新修改配置文件，注意修改必要的硬件信息</span><br><span class="line">4.最后重启网络即可</span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl restart network</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BANSIBLE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BANSIBLE/" class="post-title-link" itemprop="url">运维自动化之ANSIBLE(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-21 13:00:51" itemprop="dateCreated datePublished" datetime="2018-12-21T13:00:51+08:00">2018-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-01-01 11:33:08" itemprop="dateModified" datetime="2019-01-01T11:33:08+08:00">2019-01-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="运维自动化发展历程及技术应用"><a href="#运维自动化发展历程及技术应用" class="headerlink" title="运维自动化发展历程及技术应用"></a>运维自动化发展历程及技术应用</h3><h5 id="企业实际应用场景分析"><a href="#企业实际应用场景分析" class="headerlink" title="企业实际应用场景分析"></a>企业实际应用场景分析</h5><p>Dev开发环境</p>
<p>使用者:程序员</p>
<p>功能:程序员开发软件，测试BUG的环境</p>
<p>管理者:程序员</p>
<p>测试环境</p>
<p>使用者:QA测试工程师</p>
<p>功能:测试经过Dev环境测试通过的软件的功能</p>
<p>管理者:运维</p>
<p>说明:测试环境往往有多套,测试环境满足测试功能即可，不宜过多</p>
<p>1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试</p>
<p>2、通常测试环境有多少套和产品线数量保持一样</p>
<p>发布环境:代码发布机，有些公司为堡垒机（安全屏障）</p>
<p>使用者:运维</p>
<p>功能:发布代码至生产环境</p>
<p>管理者:运维（有经验）</p>
<p>发布机:往往需要有2台（主备）</p>
<p>生产环境</p>
<p>使用者:运维，少数情况开放权限给核心开发人员，极少数公司将权限完全开放给开发人员并其维护</p>
<p>功能:对用户提供公司产品的服务</p>
<p>管理者:只能是运维</p>
<p>生产环境服务器数量:一般比较多，且应用非常重要。往往需要自动工具协助部署配置应用<br>灰度环境（生产环境的一部分）</p>
<p>使用者:运维</p>
<p>功能:在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基于主机或用户执行灰度发布</p>
<p>案例:共100台生产服务器，先发布其中的10台服务器，这10台服务器就是灰度服务器</p>
<p>管理者:运维</p>
<p>灰度环境:往往该版本功能变更较大，为保险起见特意先让一部分用户优化体验该功能，待这部分用户使用没有重大问题的时候，再全量发布至所有服务器</p>
<h5 id="程序发布"><a href="#程序发布" class="headerlink" title="程序发布"></a>程序发布</h5><p>程序发布要求:</p>
<p>不能导致系统故障或造成系统完全不可用</p>
<p>不能影响用户体验</p>
<p>预发布验证:</p>
<p>新版本的代码先发布到服务器（跟线上环境配置完全相同，只是未接入到调度器）</p>
<p>灰度发布:</p>
<p>基于主机，用户，业务</p>
<p>发布路径:</p>
<pre><code>/webapp/markupzh 

/webapp/markupzh-1.1 

/webapp/markupzh-1.2</code></pre><p>发布过程:</p>
<p>在调度器上下线一批主机(标记为maintanance状态) –&gt; 关闭服务 –&gt; 部署新版本的应用程序 –&gt; 启动服务 –&gt; 在调度器上启用这一批服务器</p>
<p>自动化灰度发布:</p>
<p>脚本、发布平台</p>
<h5 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h5><p>文件传输</p>
<p>应用部署</p>
<p>配置管理</p>
<p>任务流编排</p>
<h5 id="常用自动化运维工具"><a href="#常用自动化运维工具" class="headerlink" title="常用自动化运维工具"></a>常用自动化运维工具</h5><pre><code>Ansible:python,Agentless,中小型应用环境

Saltstack:python，一般需部署agent，执行效率更高

Puppet:ruby, 功能强大,配置复杂，重型,适合大型环境

Fabric:python，agentless

Chef: ruby,国内应用少

Cfengine

func</code></pre><h3 id="企业级自动化运维工具应用实战ansible"><a href="#企业级自动化运维工具应用实战ansible" class="headerlink" title="企业级自动化运维工具应用实战ansible"></a>企业级自动化运维工具应用实战ansible</h3><p>公司计划在年底做一次大型市场促销活动，全面冲刺下交易额，为明年的上市做准备。公司要求各业务组对年底大促做准备，运维部要求所有业务容量进行三倍的扩容，并搭建出多套环境可以共开发和测试人员做测试，运维老大为了在年底有所表现，要求运维部门同学尽快实现，接到这个任务时，有没有更快的解决方案？</p>
<h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><p>模块化:调用特定的模块，完成特定任务</p>
<p>有Paramiko，PyYAML，Jinja2（模板语言）三个关键模块</p>
<p>支持自定义模块</p>
<p>基于Python语言实现</p>
<p>部署简单，基于python和SSH(默认已安装)，agentless</p>
<p>安全，基于OpenSSH</p>
<p>支持playbook编排任务</p>
<p>幂等性:一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</p>
<p>无需代理不依赖PKI（无需ssl）</p>
<p>可使用任何编程语言写模块</p>
<p>YAML格式，编排任务，支持丰富的数据结构</p>
<p>较强大的多层解决方案</p>
<h4 id="Ansible主要组成部分"><a href="#Ansible主要组成部分" class="headerlink" title="Ansible主要组成部分"></a>Ansible主要组成部分</h4><p>ANSIBLE PLAYBOOKS:任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</p>
<p>INVENTORY:Ansible管理主机的清单/etc/anaible/hosts</p>
<p>MODULES:Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</p>
<p>PLUGINS:模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</p>
<p>API:供第三方程序调用的应用程序编程接口</p>
<p>ANSIBLE:组合INVENTORY、API、MODULES、PLUGINS的绿框，可以理解为是ansible命令工具，其为核心执行工具</p>
<p>Ansible命令执行来源:</p>
<pre><code>USER，普通用户，即SYSTEM ADMINISTRATOR

CMDB（配置管理数据库） API 调用

PUBLIC/PRIVATE CLOUD API调用

USER-&gt; Ansible Playbook -&gt; Ansibile</code></pre><p>利用ansible实现管理的方式:</p>
<pre><code>Ad-Hoc 即ansible命令，主要用于临时命令使用场景

Ansible-playbook 主要用于长期规划好的，大型项目的场景，需要有前提的规划</code></pre><p>Ansible-playbook（剧本）执行过程:</p>
<pre><code>将已有编排好的任务集写入Ansible-Playbook

通过ansible-playbook命令分拆任务集至逐条ansible命令，按预定规则逐条执行</code></pre><p>Ansible主要操作对象:</p>
<pre><code>HOSTS主机

NETWORKING网络设备</code></pre><p>注意事项</p>
<p>执行ansible的主机一般称为主控端，中控，master或堡垒机</p>
<p>主控端Python版本需要2.6或以上</p>
<p>被控端Python版本小于2.4需要安装python-simplejson</p>
<p>被控端如开启SELinux需要安装libselinux-python</p>
<p>windows不能做为主控端</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><h5 id="rpm包安装-EPEL源"><a href="#rpm包安装-EPEL源" class="headerlink" title="rpm包安装: EPEL源"></a>rpm包安装: EPEL源</h5><p><code>yum install ansible</code>    </p>
<p>编译安装:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tar xf ansible-1.5.4.tar.gz </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ansible-1.5.4 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> python setup.py build </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> python setup.py install </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/ansible</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp -r examples/* /etc/ansible</span></span><br></pre></td></tr></table></figure>

<h5 id="Git方式"><a href="#Git方式" class="headerlink" title="Git方式:"></a>Git方式:</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> git://github.com/ansible/ansible.git --recursive <span class="built_in">cd</span> ./ansible</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> ./hacking/env-setup</span></span><br></pre></td></tr></table></figure>

<h5 id="pip安装"><a href="#pip安装" class="headerlink" title="pip安装:"></a>pip安装:</h5><p>pip是安装Python包的管理器，类似yum </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum install python-pip python-devel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel pip install --upgrade pip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pip install ansible --upgrade</span></span><br></pre></td></tr></table></figure>

<h5 id="确认安装"><a href="#确认安装" class="headerlink" title="确认安装:"></a>确认安装:</h5><p><code>ansible --version</code></p>
<h4 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h4><h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><pre><code>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性                     

/etc/ansible/hosts 主机清单

/etc/ansible/roles/ 存放角色的目录</code></pre><h5 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h5><pre><code>/usr/bin/ansible 主程序，临时命令执行工具 

/usr/bin/ansible-doc 查看配置文档，模块功能查看工具 

/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台

/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具

/usr/bin/ansible-pull 远程执行命令的工具

/usr/bin/ansible-vault 文件加密工具 

/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</code></pre><h5 id="主机清单inventory"><a href="#主机清单inventory" class="headerlink" title="主机清单inventory"></a>主机清单inventory</h5><p>Inventory 主机清单</p>
<p>ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名</p>
<p>默认的inventory file为/etc/ansible/hosts</p>
<p>inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成</p>
<p>/etc/ansible/hosts文件格式</p>
<p>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中；此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ntp.markupzh.com</span><br><span class="line">[webservers]</span><br><span class="line">www1.markupzh.com:2222</span><br><span class="line">www2.markupzh.com</span><br><span class="line">[dbservers]</span><br><span class="line">db1.markupzh.com</span><br><span class="line">db2.markupzh.com</span><br><span class="line">db3.markupzh.com</span><br></pre></td></tr></table></figure>

<p>如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www[01:100].example.com</span><br><span class="line">[dbsrvs] </span><br><span class="line">db-[a:f].example.com</span><br></pre></td></tr></table></figure>

<h5 id="ansible-配置文件"><a href="#ansible-配置文件" class="headerlink" title="ansible 配置文件"></a>ansible 配置文件</h5><p>Ansible 配置文件/etc/ansible/ansible.cfg （一般保持默认）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"><span class="meta">#</span><span class="bash">inventory = /etc/ansible/hosts <span class="comment"># 主机列表配置文件</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">library = /usr/share/my_modules/ <span class="comment"># 库文件存放目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment">#临时py命令文件存放在远程主机目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment"># 本机的临时命令执行目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">forks = 5	<span class="comment"># 默认并发数</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">sudo_user = root <span class="comment"># 默认sudo 用户</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_sudo_pass = True <span class="comment">#每次执行ansible命令是否询问ssh密码</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_pass = True</span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_port = 22</span></span><br><span class="line"><span class="meta">#</span><span class="bash">host_key_checking = False <span class="comment"># 检查对应服务器的host_key，建议取消注释 #log_path=/var/log/ansible.log #日志文件</span></span></span><br></pre></td></tr></table></figure>

<h4 id="ansible系列命令"><a href="#ansible系列命令" class="headerlink" title="ansible系列命令"></a>ansible系列命令</h4><p>ansible ansible-doc </p>
<p>ansible-playbook </p>
<p>ansible-vault </p>
<p>ansible-console     </p>
<p>ansible-galaxy </p>
<p>ansible-pull</p>
<p>ansible-doc: 显示模块帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc options</span><br><span class="line">-a	显示所有模块的文档</span><br><span class="line">-l, --list	列出可用模块</span><br><span class="line">-s, --snippet显示指定模块的playbook片段</span><br></pre></td></tr></table></figure>

<h5 id="示例"><a href="#示例" class="headerlink" title="示例:"></a>示例:</h5><p>ansible-doc –l 列出所有模块<br>ansible-doc ping 查看指定模块帮助用法<br>ansible-doc –s ping 查看指定模块帮助用法</p>
<p>ansible通过ssh实现配置管理、应用部署、任务执行等功能，建议配置ansible端能基于密钥认证的方式联系各被管理节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible &lt;host-pattern&gt; -m module_name</span><br><span class="line">--version 显示版本</span><br><span class="line">-m module	指定模块，默认为command</span><br><span class="line">-v 详细过程 –vv -vvv更详细</span><br><span class="line">--list-hosts 显示主机列表，可简写 --list</span><br><span class="line">-k, --ask-pass	提示输入ssh连接密码，默认Key验证</span><br><span class="line">-K, --ask-become-pass 提示输入sudo时的口令</span><br><span class="line">-C, --check	检查，并不执行</span><br><span class="line">-T, --timeout=TIMEOUT 执行命令的超时时间，默认10s </span><br><span class="line">-u, --user=REMOTE_USER 执行远程执行的用户 </span><br><span class="line">-b, --become 代替旧版的sudo 切换</span><br></pre></td></tr></table></figure>

<h5 id="ansible的Host-pattern"><a href="#ansible的Host-pattern" class="headerlink" title="ansible的Host-pattern"></a>ansible的Host-pattern</h5><p>匹配主机的列表</p>
<p>All :表示所有Inventory中的所有主机 </p>
<pre><code>ansible all –m ping</code></pre><p><code>*</code>:通配符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible "*" -m ping</span><br><span class="line">ansible 192.168.1.* -m ping</span><br><span class="line">ansible "*srvs" -m ping</span><br></pre></td></tr></table></figure>

<p>或关系</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible "websrvs:appsrvs" -m ping</span><br><span class="line">ansible "192.168.1.10:192.168.1.20"  -m ping</span><br></pre></td></tr></table></figure>

<p>逻辑与</p>
<p><code>ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</code></p>
<p>在websrvs组并且在dbsrvs组中的主机</p>
<p>逻辑非</p>
<p><code>ansible &#39;websrvs:!dbsrvs&#39; –m ping</code></p>
<p>在websrvs组，但不在dbsrvs组中的主机注意:此处为单引号</p>
<p>综合逻辑</p>
<p><code>ansible &#39;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#39; –m ping</code></p>
<p>正则表达式</p>
<p><code>ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</code></p>
<p><code>ansible &quot;~(web|db).*\.markupzh\.com&quot; –m ping</code></p>
<h4 id="ansible命令执行过程"><a href="#ansible命令执行过程" class="headerlink" title="ansible命令执行过程"></a>ansible命令执行过程</h4><pre><code>1. 加载自己的配置文件 默认/etc/ansible/ansible.cfg

2. 加载自己对应的模块文件，如command

3. 通过ansible将模块或命令生成对应的临时py文件，并将该 文件传输至远程服务器的对应执行用户$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件

4. 给文件+x执行

5. 执行并返回结果

6. 删除临时py文件，sleep 0退出

执行状态:

    绿色:执行成功并且不需要做改变的操作

    黄色:执行成功并且对目标主机做变更

    红色:执行失败</code></pre><h4 id="ansible使用示例"><a href="#ansible使用示例" class="headerlink" title="ansible使用示例"></a>ansible使用示例</h4><p>以mark用户执行ping存活检测 </p>
<p><code>ansible all -m ping -u mark -k</code></p>
<p>以mark sudo至root执行ping存活检测 </p>
<p><code>ansible all -m ping -u mark –b -k</code></p>
<p>以mark sudo至markupzh用户执行ping存活检测</p>
<p><code>ansible all -m ping -u mark –b -k --become-user markupzh</code></p>
<p>以mark sudo至root用户执行ls</p>
<p><code>ansible all -m command -u mark --become-user=root -a &#39;ls /root&#39; -b –k -K</code></p>
<h4 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h4><p>Command:在远程主机执行命令，默认模块，可忽略-m选项</p>
<p><code>ansible srvs -m command -a &#39;service vsftpd start&#39;</code></p>
<p><code>ansible srvs -m command -a &#39;echo markupzh |passwd --stdin mark&#39;</code>不成功</p>
<p>此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，用shell模块实现</p>
<p>Shell:和command相似，用shell执行命令</p>
<p><code>ansible srv -m shell -a &#39;echo markupzh |passwd –stdin mark&#39;</code></p>
<p>调用bash执行命令 类似 cat /tmp/stanley.md | awk -F’|’ ‘{print $1,$2}’ &amp;&gt; /tmp/example.txt 这些复杂命令，即使使用shell也可能会失败，解决办法:写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器</p>
<p><strong>Script</strong>:运行脚本</p>
<p><code>-a &quot;/PATH/TO/SCRIPT_FILE&quot;</code></p>
<p><code>snsible websrvs -m script -a f1.sh</code></p>
<p><strong>Copy</strong>:从服务器复制文件到客户端</p>
<p><code>ansible srv -m copy -a &quot;src=/root/f1.sh dest=/tmp/f2.sh owner=mark mode=600 backup=yes&quot;</code></p>
<p>如目标存在，默认覆盖，此处指定先备份</p>
<p><code>ansible srv -m copy -a &quot;content=&#39;test content\n&#39; dest=/tmp/f1.txt&quot;</code></p>
<p>利用内容，直接生成目标文件</p>
<p><strong>Fetch</strong>:从客户端取文件至服务器端，copy相反，目录可先tar</p>
<p><code>ansible srv -m fetch -a &#39;src=/root/a.sh dest=/data/scripts&#39;</code></p>
<p><strong>File</strong>:设置文件属性</p>
<p><code>ansible srv -m file -a &quot;path=/root/a.sh owner=mark mode=755&quot;</code></p>
<p><code>ansible web -m file -a &#39;src=/app/testfile dest=/app/testfile-link state=link&#39;</code></p>
<p><strong>Hostname</strong>:管理主机名</p>
<p><code>ansible node1 -m hostname -a &quot;name=websrv&quot;</code></p>
<p><strong>Cron</strong>:计划任务</p>
<p>支持时间:minute，hour，day，month，weekday</p>
<p><code>ansible srv -m cron -a &quot;minute=*/5 job=&#39;/usr/sbin/ntpdate</code></p>
<p><code>172.16.0.1 &amp;&gt;/dev/null&#39; name=Synctime&quot;</code>创建任务</p>
<p><code>ansible srv -m cron -a &#39;state=absent name=Synctime&#39;</code> 删除任务</p>
<p><strong>Yum</strong>:管理包</p>
<p><code>ansible srv -m yum -a &#39;name=httpd state=latest&#39;</code> 安装</p>
<p><code>ansible srv -m yum -a &#39;name=httpd state=absent&#39;</code> 删除</p>
<p><strong>Service</strong>:管理服务</p>
<p><code>ansible srv -m service -a &#39;name=httpd state=stopped&#39;</code></p>
<p><code>ansible srv -m service -a &#39;name=httpd state=started&#39;</code></p>
<p><code>ansible srv –m service –a &#39;name=httpd state=reloaded&#39;</code></p>
<p><code>ansible srv -m service -a &#39;name=httpd state=restarted&#39;</code></p>
<p><strong>User</strong>:管理用户</p>
<p><code>ansible srv -m user -a &#39;name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1 group=root&#39;</code></p>
<p><code>ansible srv -m user -a &#39;name=sysuser1 system=yes home=/app/sysuser1 &#39;</code></p>
<p><code>ansible srv -m user -a &#39;name=user1 state=absent remove=yes&#39;</code>删除用户及家目录等数据</p>
<p><strong>Group</strong>:管理组</p>
<p><code>ansible srv -m group -a &quot;name=testgroup system=yes&quot;</code></p>
<p><code>ansible srv -m group -a &quot;name=testgroup state=absent&quot;</code></p>
<h4 id="ansible系列命令-1"><a href="#ansible系列命令-1" class="headerlink" title="ansible系列命令"></a>ansible系列命令</h4><p><code>ansible-galaxy</code></p>
<p>连接 <a href="https://galaxy.ansible.com" target="_blank" rel="noopener">https://galaxy.ansible.com</a> 下载相应的roles</p>
<p>列出所有已安装的galaxy</p>
<p><code>ansible-galaxy list</code></p>
<p>安装galaxy</p>
<p><code>ansible-galaxy install geerlingguy.redis</code></p>
<p>删除galaxy</p>
<p><code>ansible-galaxy remove geerlingguy.redis</code></p>
<p>ansible-pull</p>
<p>推送命令至远程，效率无限提升，对运维要求较高</p>
<h5 id="Ansible-playbook"><a href="#Ansible-playbook" class="headerlink" title="Ansible-playbook"></a>Ansible-playbook</h5><p>ansible-playbook hello.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">hello.yml</span></span><br><span class="line"><span class="comment">#hello world yml file</span></span><br><span class="line"><span class="string">-hosts:</span> <span class="string">websrvs</span></span><br><span class="line">    <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">tasks:</span></span><br><span class="line">    <span class="string">-name:</span> <span class="string">hello</span> <span class="string">world</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">/usr/bin/wall</span> <span class="string">hello</span> <span class="string">world</span></span><br></pre></td></tr></table></figure>

<h5 id="Ansible-vault"><a href="#Ansible-vault" class="headerlink" title="Ansible-vault"></a>Ansible-vault</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">功能:管理加密解密yml文件</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">[create|decrypt|edit|encrypt|rekey|view]</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">encrypt</span> <span class="string">hello.yml</span> <span class="string">加密</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">decrypt</span> <span class="string">hello.yml</span> <span class="string">解密</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">view</span> <span class="string">hello.yml</span> <span class="string">查看</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">edit</span> <span class="string">hello.yml</span> <span class="string">编辑加密文件</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">rekey</span> <span class="string">hello.yml</span> <span class="string">修改口令</span></span><br><span class="line"><span class="string">ansible-vault</span> <span class="string">create</span> <span class="string">new.yml</span> <span class="string">创建新文件</span></span><br></pre></td></tr></table></figure>

<h5 id="Ansible-console"><a href="#Ansible-console" class="headerlink" title="Ansible-console"></a>Ansible-console</h5><p>Ansible-console:2.0+新增，可交互执行命令，支持tab</p>
<p><code>root@test (2)[f:10] $</code></p>
<p>执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$</p>
<p>设置并发数: forks n 例如: forks 10</p>
<p>切换组: cd 主机组 例如: cd web</p>
<p>列出当前组主机列表: list</p>
<p>列出所有的内置命令: ?或help</p>
<p>示例:    </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@all (2)[f:5]$ list </span><br><span class="line">root@all (2)[f:5]$ cd appsrvs </span><br><span class="line">root@appsrvs (2)[f:5]$ list</span><br><span class="line">root@appsrvs (2)[f:5]$ yum name=httpd state=present </span><br><span class="line">root@appsrvs (2)[f:5]$ service name=httpd state=started</span><br></pre></td></tr></table></figure>

<h5 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h5><p>playbook是由一个或多个”play”组成的列表</p>
<p>play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上来讲，所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可以让它们联同起来按事先编排的机制同唱一台大戏</p>
<p>Playbook采用YAML语言编写</p>
<h4 id="YAML介绍"><a href="#YAML介绍" class="headerlink" title="YAML介绍"></a>YAML介绍</h4><p>YAML是一个可读性高的用来表达资料序列的格式。YAML参考了其他多种语言，包括:XML、C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者</p>
<p>YAML Ain’t Markup Language，即YAML不是XML。不过，在开发的这种语言时，YAML的意思其实是:”Yet Another Markup Language”（仍是一种标记语言）</p>
<p>特性    </p>
<p>YAML的可读性好</p>
<p>YAML和脚本语言的交互性好</p>
<p>YAML使用实现语言的数据类型</p>
<p>YAML有一个一致的信息模型</p>
<p>YAML易于实现</p>
<p>YAML可以基于流来处理</p>
<p>YAML表达能力强，扩展性好</p>
<p>更多的内容及规范参见<a href="http://www.yaml.org" target="_blank" rel="noopener">http://www.yaml.org</a></p>
<h5 id="YAML语法简介"><a href="#YAML语法简介" class="headerlink" title="YAML语法简介"></a>YAML语法简介</h5><p>在单一档案中，可用连续三个连字号(——)区分多个档案。另外，还有选择性的连续三个点号( … )用来表示档案结尾</p>
<p>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</p>
<p>使用#号注释代码</p>
<p>缩进必须是统一的，不能空格和tab混用</p>
<p>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</p>
<p>YAML文件内容是区别大小写的，k/v的值均需大小写敏感</p>
<p>k/v的值可同行写也可换行写。同行使用:分隔</p>
<p>v可是个字符串，也可是另一个列表</p>
<p>一个完整的代码块功能需最少元素需包括 name: task</p>
<p>一个name只能包括一个task</p>
<p>YAML文件扩展名通常为yml或yaml</p>
<p>List:列表，其所有元素均使用”-“打头</p>
<h5 id="示例-1"><a href="#示例-1" class="headerlink" title="示例:"></a>示例:</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">A</span> <span class="string">list</span> <span class="string">of</span> <span class="string">tasty</span> <span class="string">fruits</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Apple</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Orange</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Strawberry</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Mango</span></span><br></pre></td></tr></table></figure>

<p>Dictionary:字典，通常由多个key与value构成</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">An</span> <span class="string">employee</span> <span class="string">record</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Example</span> <span class="string">Developer</span></span><br><span class="line"><span class="attr">job:</span> <span class="string">Developer</span></span><br><span class="line"><span class="attr">skill:</span> <span class="string">Elite</span></span><br></pre></td></tr></table></figure>

<p>也可以将key:value放置于{}中进行表示，用,分隔多个key:value</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">An</span> <span class="string">employee</span> <span class="string">record</span></span><br><span class="line"><span class="string">&#123;name:</span> <span class="string">Example</span> <span class="string">Developer,</span> <span class="attr">job:</span> <span class="string">Developer,</span> <span class="attr">skill:</span> <span class="string">Elite&#125;</span></span><br></pre></td></tr></table></figure>

<p>YAML语法</p>
<p>YAML的语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据结构。其结构（Structure）通过空格来展示，序列（Sequence）里的项用”-“来代表，Map里的键值对用”:”分隔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">John</span> <span class="string">Smith</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">41</span></span><br><span class="line"><span class="attr">gender:</span> <span class="string">Male</span> </span><br><span class="line"><span class="attr">spouse:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">Jane</span> <span class="string">Smith</span></span><br><span class="line">	<span class="attr">age:</span> <span class="number">37</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Female</span> </span><br><span class="line"><span class="attr">children:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Jimmy</span> <span class="string">Smith</span></span><br><span class="line">	<span class="attr">age:</span> <span class="number">17</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Male</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Jenny</span> <span class="string">Smith</span> </span><br><span class="line">	<span class="string">age</span> <span class="number">13</span></span><br><span class="line">	<span class="attr">gender:</span> <span class="string">Female</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h4><p>Hosts  执行的远程主机列表<br>Tasks  任务集<br>Varniables 内置变量或自定义变量在playbook中调用<br>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件<br>Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行<br>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断<br><code>ansible-playbook –t tagsname useradd.yml</code></p>
<h4 id="playbook基础组件"><a href="#playbook基础组件" class="headerlink" title="playbook基础组件"></a>playbook基础组件</h4><p>Hosts:<br>playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中<br>可以是如下形式:<br>​    one.example.com<br>​    one.example.com:two.example.com<br>​    192.168.1.50<br>​    192.168.1.*</p>
<p>Websrvs:dbsrvs   两个组的并集</p>
<p>Websrvs:&amp;dbsrvs   两个组的交集</p>
<p>webservers:!phoenix 在websrvs组，但不在dbsrvs组</p>
<p>示例: - hosts: websrvs:dbsrvs</p>
<p>remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">	<span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">	<span class="string">-name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line"><span class="attr">ping:</span></span><br><span class="line">	<span class="attr">remote_user:</span> <span class="string">markupzh</span></span><br><span class="line">	<span class="attr">sudo:</span> <span class="literal">yes</span>	<span class="string">默认sudo为root</span></span><br><span class="line">	<span class="string">sudo_user:mark</span>	<span class="string">sudo为mark</span></span><br></pre></td></tr></table></figure>

<p>task列表和action<br>play的主体部分是task list。task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后，再开始第二个任务</p>
<p>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</p>
<p>每个task都应该有其name，用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤。如果未提供name，则action的结果将用于输出</p>
<p>playbook基础组件<br>tasks:任务列表</p>
<p>格式:<br>(1) action: module arguments</p>
<p>(2) module: arguments    建议使用</p>
<p>注意:shell和command模块后面跟命令，而非key=value</p>
<p>某任务的状态在运行后为changed时，可通过”notify”通知给相应的 handlers</p>
<p>任务可以通过”tags”打标签，而后可在ansible-playbook命令上使用-t指定进行调用</p>
<p>示例: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">disable</span> <span class="string">selinux</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">/sbin/setenforce</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>如果命令或脚本的退出码不为零，可以使用如下方式替代 </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br></pre></td></tr></table></figure>

<p>或者使用ignore_errors来忽略错误信息:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">/usr/bin/somecommand</span></span><br><span class="line">  <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h4 id="运行playbook"><a href="#运行playbook" class="headerlink" title="运行playbook"></a>运行playbook</h4><p>运行playbook的方式</p>
<p><code>ansible-playbook &lt;filename.yml&gt; ... [options]</code></p>
<p>常见选项</p>
<p>–check 只检测可能会发生的改变，但不真正执行操作</p>
<p>–list-hosts 列出运行任务的主机</p>
<p>–limit 主机列表 只针对主机列表中的主机执行</p>
<p>-v 显示过程 -vv -vvv 更详细</p>
<p>示例</p>
<p><code>ansible-playbook file.yml --check</code> 只检测 </p>
<p><code>ansible-playbook file.yml</code></p>
<p><code>ansible-playbook file.yml --limit websrvs</code></p>
<h4 id="Playbook与ShellScripts相比较"><a href="#Playbook与ShellScripts相比较" class="headerlink" title="Playbook与ShellScripts相比较"></a>Playbook与ShellScripts相比较</h4><p>SHELL脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装Apache</span></span><br><span class="line">yum install --quiet -y httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制配置文件</span></span><br><span class="line">cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf </span><br><span class="line">cp /tmp/vhosts.conf /etc/httpd/conf.d/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动Apache，并设置开机启动 </span></span><br><span class="line">service httpd start </span><br><span class="line">chkconfig httpd on</span><br></pre></td></tr></table></figure>

<p>Playbook定义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span> </span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"安装Apache"</span></span><br><span class="line">  <span class="attr">yum:</span>  <span class="string">name=httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=/tmp/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=/tmp/vhosts.conf</span> <span class="string">dest=/etc/httpd/conf.cd/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"启动Apache，并设置开机启动"</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook示例"><a href="#Playbook示例" class="headerlink" title="Playbook示例"></a>Playbook示例</h4><p>示例:sysuser.yml创建mysql用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">mysql</span> <span class="string">user</span></span><br><span class="line">	<span class="attr">user:</span> <span class="string">name=mysql</span> <span class="string">system=yes</span> <span class="string">uid=36</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">group</span></span><br><span class="line">	<span class="attr">group:</span> <span class="string">name=httpd</span> <span class="string">system=yes</span></span><br></pre></td></tr></table></figure>

<p>示例:httpd.yml安装httpd</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<h4 id="handlers和notify结合使用触发条件"><a href="#handlers和notify结合使用触发条件" class="headerlink" title="handlers和notify结合使用触发条件"></a>handlers和notify结合使用触发条件</h4><p>Handlers</p>
<p>是task列表，这些task与前述的task并没有本质上的不同,用于当关注的资源发生变化时，才会采取一定的操作</p>
<p>Notify此action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作</p>
<h4 id="Playbook中handlers使用"><a href="#Playbook中handlers使用" class="headerlink" title="Playbook中handlers使用"></a>Playbook中handlers使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span> <span class="attr">handlers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">status=restarted</span></span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=/root/config.txt</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">notify:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">Process</span> </span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> <span class="string">enabled=yes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">process</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">killall</span> <span class="number">-0</span> <span class="string">nginx</span> <span class="string">&gt;</span> <span class="string">/tmp/nginx.log</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook中tags使用"><a href="#Playbook中tags使用" class="headerlink" title="Playbook中tags使用"></a>Playbook中tags使用</h4><p>示例:httpd.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">conf</span></span><br><span class="line"></span><br><span class="line"> 	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line"> 	<span class="attr">tags:</span> <span class="string">service</span></span><br><span class="line"> 	<span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line">  <span class="string">ansible-playbook</span> <span class="string">–t</span> <span class="string">conf</span> <span class="string">httpd.yml</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook中变量使用"><a href="#Playbook中变量使用" class="headerlink" title="Playbook中变量使用"></a>Playbook中变量使用</h4><p>变量名:</p>
<p>仅能由字母、数字和下划线组成，且只能以字母开头</p>
<p>变量来源:</p>
<p>1 ansible setup facts 远程主机的所有变量都可直接调用</p>
<p>2 在/etc/ansible/hosts中定义</p>
<p>普通变量:主机组中主机单独定义，优先级高于公共变量公共（组）变量:针对主机组中所有主机定义统一变量</p>
<p>3 通过命令行指定变量，优先级最高</p>
<p>ansible-playbook –e varname=value</p>
<p>4 在playbook中定义<br>  vars:<br>​    -    var1: value1<br>​    -    var2: value2</p>
<p>5 在独立的变量YAML文件中定义</p>
<p>6 在role中定义<br>变量命名<br>变量名仅能由字母、数字和下划线组成，且只能以字母开头</p>
<p>变量定义:key=value<br>示例:http_port=80</p>
<p>变量调用方式:<br>​<br>通过 调用变量，且变量名前后必须有空格，有时用”“才生效</p>
<p>ansible-playbook –e 选项指定<br><code>ansible-playbook test.yml -e &quot;hosts=www user=markupzh&quot;</code></p>
<p>示例:使用setup变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">log</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">name=/var/log/</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_fqdn</span> <span class="string">&#125;&#125;</span> <span class="string">state=touch</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">var.yml</span></span><br></pre></td></tr></table></figure>
<p>示例:变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">–e</span> <span class="string">pkname=httpd</span> <span class="string">var.yml</span></span><br></pre></td></tr></table></figure>

<p>示例:变量</p>
<p>var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">username:</span> <span class="string">user1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">groupname:</span> <span class="string">group1</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">	  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">var.yml</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">-e</span> <span class="string">"username=user2 groupname=group2"</span>  <span class="string">var2.yml</span></span><br></pre></td></tr></table></figure>

<p>主机变量</p>
<p>可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www1.markupzh.com http_port=80 maxRequestsPerChild=808 www2.markupzh.com http_port=8080 maxRequestsPerChild=909</span><br></pre></td></tr></table></figure>

<p>组变量</p>
<p>组变量是指赋予给指定组内所有主机上的在playbook中可用的变量</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">www1.markupzh.com</span><br><span class="line">www2.markupzh.com</span><br><span class="line">[websrvs:vars]</span><br><span class="line">ntp_server=ntp.markupzh.com nfs_server=nfs.markupzh.com</span><br></pre></td></tr></table></figure>

<p>普通变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">192.168.99.101 http_port=8080 hname=www1</span><br><span class="line">192.168.99.102 http_port=80   hname=www2</span><br></pre></td></tr></table></figure>

<p>公共（组）变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[websvrs:vars] </span><br><span class="line">http_port=808</span><br><span class="line">mark="_"</span><br><span class="line"></span><br><span class="line">[websrvs]</span><br><span class="line">192.168.99.101 http_port=8080 hname=www1</span><br><span class="line">192.168.99.102 http_port=80 hname=www2</span><br><span class="line"></span><br><span class="line">ansible websvrs –m hostname –a 'name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;'</span><br></pre></td></tr></table></figure>

<p>命令行指定变量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible websvrs –e http_port&#x3D;8000 –m hostname –a &#39;name&#x3D;&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>使用变量文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat vars.yml </span><br><span class="line"></span><br><span class="line">var1: httpd </span><br><span class="line">var2: nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat var.yml</span><br><span class="line"></span><br><span class="line">- hosts: web</span><br><span class="line">  remote_user: root </span><br><span class="line">  vars_files:</span><br><span class="line">    - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create httpd log</span><br><span class="line">    file: name=/app/&#123;&#123; var1 &#125;&#125;.log state=touch</span><br><span class="line">    - name: create nginx log</span><br><span class="line">    file: name=/app/&#123;&#123; var2 &#125;&#125;.log state=touch</span><br></pre></td></tr></table></figure>

<p>模板templates</p>
<p>文本文件，嵌套有脚本（使用模板编程语言编写）</p>
<p>Jinja2语言，使用字面量，有下面形式字符串:使用单引号或双引号</p>
<p>数字:整数，浮点数</p>
<p>列表:[item1, item2, …]</p>
<p>元组:(item1, item2, …)</p>
<p>字典:{key1:value1, key2:value2, …}</p>
<p>布尔型:true/false</p>
<p>算术运算:+, -, <em>, /, //, %, *</em></p>
<p>比较操作:==, !=, &gt;, &gt;=, &lt;, &lt;=</p>
<p>逻辑运算:and, or, not</p>
<p>流表达式:For If When</p>
<h4 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h4><p>templates功能:根据模块文件动态生成对应的配置文件</p>
<p>templates文件必须存放于templates目录下，且命名为 .j2 结尾</p>
<p>yaml/yml 文件需和templates目录平级，目录结构如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">├── temnginx.yml</span><br><span class="line">└── templates</span><br><span class="line">	  └── nginx.conf.j2</span><br></pre></td></tr></table></figure>

<h4 id="Templates示例"><a href="#Templates示例" class="headerlink" title="Templates示例"></a>Templates示例</h4><p>示例:利用templates 同步nginx配置文件准备templates/nginx.conf.j2文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim temnginx.yml</span><br><span class="line"></span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: template config to remote hosts</span><br><span class="line">	 template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">ansible-playbook temnginx.yml</span><br></pre></td></tr></table></figure>

<h4 id="Playbook中template变更替换"><a href="#Playbook中template变更替换" class="headerlink" title="Playbook中template变更替换"></a>Playbook中template变更替换</h4><p>修改文件nginx.conf.j2 下面行为</p>
<p><code>worker_processes ;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat temnginx2.yml</span><br><span class="line"></span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">	- name: template config to remote hosts</span><br><span class="line">	template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">ansible-playbook temnginx2.yml</span><br></pre></td></tr></table></figure>

<h4 id="Playbook中template算术运算"><a href="#Playbook中template算术运算" class="headerlink" title="Playbook中template算术运算"></a>Playbook中template算术运算</h4><p>算法运算:</p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf.j2</span><br><span class="line"></span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;; </span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus+2 &#125;&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="when"><a href="#when" class="headerlink" title="when"></a>when</h4><p>条件测试:如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,通过when语句实现，在task中使用，jinja2的语法格式</p>
<p>when语句</p>
<p>在task后添加when子句即可使用条件测试；when语句支持Jinja2表达式语法</p>
<p>示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"shutdown RedHat flavored systems"</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">/sbin/shutdown</span> <span class="string">-h</span> <span class="string">now</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br></pre></td></tr></table></figure>

<p>示例:when条件判断</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br></pre></td></tr></table></figure>

<p>示例:when条件判断</p>
<p>示例: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos7</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=nginx.conf.c7.j2</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos6</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=nginx.conf.c6.j2</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br></pre></td></tr></table></figure>

<p>迭代:with_items</p>
<p>迭代:当有需要重复性执行的任务时，可以使用迭代机制</p>
<p>对迭代项的引用，固定变量名为”item”</p>
<p>要在task中使用with_items给定要迭代的元素列表</p>
<p>列表格式:</p>
<p>字符串</p>
<p>字典</p>
<p>示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="string">groups=wheel</span> </span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">testuser1</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">testuser2</span></span><br></pre></td></tr></table></figure>

<p>上面语句的功能等同于下面的语句:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser1</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=testuser1</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser2</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=testuser2</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<p>将多个文件进行copy到被控端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">testsrv</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="string">tasks</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">rsyncd</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/etc/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsyncd.secrets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsyncd.conf</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">file</span></span><br><span class="line">	  <span class="attr">copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/tmp/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file1</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file2</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">file3</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">apr</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">apr-util</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">httpd</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts:websrvs</span> </span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="string">tasks</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">some</span> <span class="string">packages</span></span><br><span class="line">	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">	  <span class="attr">with_items:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">memcached</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">php-fpm</span></span><br></pre></td></tr></table></figure>

<p>示例:迭代嵌套子变量</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts:websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group3</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span></span><br><span class="line">	  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="attr">with_items:</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user1'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group1'</span> <span class="string">&#125;</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user2'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group2'</span> <span class="string">&#125;</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user3'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group3'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h4><p>ansilbe自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中</p>
<p>复杂场景:建议使用roles，代码复用度高</p>
<p>变更指定主机或主机组</p>
<p>如命名不规范维护和传承成本大</p>
<p>某些功能需多个Playbook，通过Includes即可实现</p>
<p>角色(roles):角色集合 </p>
<p>roles/</p>
<p>  mysql/</p>
<p>  httpd/</p>
<p>  nginx/</p>
<p>  memcached/</p>
<h4 id="roles目录结构"><a href="#roles目录结构" class="headerlink" title="roles目录结构"></a>roles目录结构</h4><p>每个角色，以特定的层级目录结构进行组织</p>
<p>roles目录结构: </p>
<p>playbook.yml </p>
<p>  roles/<br>​     project/<br>​     tasks/<br>​     files/<br>​     vars/<br>​     templates/<br>​     handlers/<br>​     default/  不常用<br>​     meta/    不常用</p>
<p>Roles各目录作用:</p>
<pre><code>/roles/project/ :项目名称,有以下子目录

files/ :存放由copy或script模块等调用的文件

templates/:template模块查找所需要模板文件的目录

tasks/:定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

handlers/:至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

vars/:定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含

meta/:定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含

default/:设定默认变量时使用此目录中的main.yml文件</code></pre><p>创建role:</p>
<pre><code>创建role的步骤

(1) 创建以roles命名的目录

(2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等

(3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；用不到的目录可以创建为空目录，也可以不创建

(4) 在playbook文件中，调用各角色</code></pre><h4 id="playbook调用角色"><a href="#playbook调用角色" class="headerlink" title="playbook调用角色"></a>playbook调用角色</h4><p>调用角色方法1:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span> </span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">memcached</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>调用角色方法2:传递变量给角色</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="attr">remote_user:</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>键role用于指定角色名称</p>
<p>后续的k/v用于传递变量给角色</p>
<p>调用角色方法3:还可基于条件测试实现角色调用 roles:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx,</span> <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">'7'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="推荐资料"><a href="#推荐资料" class="headerlink" title="推荐资料"></a>推荐资料</h4><pre><code>http://galaxy.ansible.com
https://galaxy.ansible.com/explore#/
http://github.com/
http://ansible.com.cn/
https://github.com/ansible/ansible
https://github.com/ansible/ansible-examples</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E9%85%8D%E7%BD%AELinux%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4SSH%E4%BA%92%E4%BF%A1%E8%BF%9E%E6%8E%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E9%85%8D%E7%BD%AELinux%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4SSH%E4%BA%92%E4%BF%A1%E8%BF%9E%E6%8E%A5/" class="post-title-link" itemprop="url">配置Linux主机之间SSH互信连接</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-12-05 15:16:37 / 修改时间：15:37:11" itemprop="dateCreated datePublished" datetime="2018-12-05T15:16:37+08:00">2018-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>无论在本地搭建实验环境还是在生产环境中,多节点并行计算设置中,建立Linux主机间的SSH互信是非常重要的环节.常见的互信机制包括RSH和SSH两种,其中SSH互信较常用到,下面介绍SSH的原理及其配置方法.</p>
<p>首先,我们先了解下配置ssh互信的原理,ssh互信,说白了,就是在目标机器上,预先设置好经过认证的key文件,当需要访问目标机器时,目标机器通过key文件,对访问者进行自动认证,从而实现互信.</p>
<p>了解了ssh互信的原理,我们把配置ssh互信的步骤,进行有效的分割:</p>
<p>1.首先,在要配置互信的机器上,生成各自的经过认证的key文件;</p>
<p>2.其次,将所有的key文件汇总到一个总的认证文件中;</p>
<p>3.将这个包含了所有互信机器认证key的认证文件,分发到各个机器中去;</p>
<p>4.验证互信;</p>
<p>实例演示:CentOS 7.5系统的两台电脑,IP分别为192.168.0.100和192.168.0.101,主机名(hostname)分别为node0和node1,默认都已安装SSH服务,要实现两个名称相同的账号root间的互信连接.</p>
<p>备注:主机名可以通过root用户修改/etc/sysconfig/network中的hostname变量名,重启设定生效,而hostname命令只修改当前显示的主机名,重启后即失效. </p>
<p>1.节点node1上,以root身份修改/etc/hosts文件,以建立主机IP和主机名(hostname)间的映射,其文件格式如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Do not remove the following line, or various programs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that require network functionality will fail.</span></span><br><span class="line">127.0.0.1       localhost.localdomain localhost</span><br><span class="line">::1             localhost6.localdomain6 localhost6</span><br><span class="line">192.168.100.100 node1.localdomain     node1</span><br><span class="line">192.168.100.101 node2.localdomain     node2</span><br></pre></td></tr></table></figure>

<p>IP hostname.domainname hostname,其中各项以Tab键隔开.</p>
<p>注意:修改该文件不是必须步骤,但方便以后用主机名直接访问各主机,省去了输入IP地址的麻烦.在节点node2上进行相同操作.</p>
<p> 2.用户root身份,在node1上生成认证RSA密钥(这里有个细节,就是ssh互信的认证文件,需要放在用户的home目录下的.ssh目录中,因此我们要首先建立这个目录,并且保证这个目录的权限是700):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir .ssh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chmod 700 .ssh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh-keygen -t rsa</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/home/deven/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in /home/deven/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /home/deven/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">89:56:d6:4a:b2:6c:4a:05:86:ae:cd:7d:80:dd:3c:f1 deven@node1</span><br></pre></td></tr></table></figure>

<p>中间过程直接3个回车.在~/.ssh/目录下,生成了两个文件:id_rsa(私钥文件放在本地) 和 id_rsa.pub(公钥文件放在信任服务器).</p>
<p>在node2上,以用户root身份进行相同操作.</p>
<p>3.将所有的公钥文件 id_rsa.pub汇总到一个总的认证文件authorized-keys中:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh root@node2 cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span></span><br></pre></td></tr></table></figure>

<p>4.经过1,2两步,目前node1上存在一份完整的认证key文件,这时候,把她拷到node2主机的对应目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> scp ~/.ssh/authorized_keys root@node2:~/.ssh/authorized_keys</span></span><br></pre></td></tr></table></figure>

<p>5.大功告成,这时候,再互相用ssh命令连接,看看是否配置成功.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/vmware-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%89%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F-%E6%A1%A5%E6%8E%A5-NAT-%E4%BB%85%E4%B8%BB%E6%9C%BA%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/vmware-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%89%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F-%E6%A1%A5%E6%8E%A5-NAT-%E4%BB%85%E4%B8%BB%E6%9C%BA%E5%8C%BA%E5%88%AB/" class="post-title-link" itemprop="url">vmware 虚拟机三种网络模式 桥接 NAT 仅主机</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-04 14:58:37" itemprop="dateCreated datePublished" datetime="2018-12-04T14:58:37+08:00">2018-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-12-05 12:18:12" itemprop="dateModified" datetime="2018-12-05T12:18:12+08:00">2018-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>vmware为我们提供了3种网络工作模式,分别是:Bridge(桥接模式),NAT(网络地址转换模式),Host-Only(仅主机模式).</p>
<p>首先在说到VMware的网络模型前,先说一下VMware的几个虚拟设备:</p>
<p>VMnet0:这是VMware用于虚拟机桥接网络下的虚拟交换机</p>
<p>VMnet1:这是VMware用于Host-Only网络下的虚拟交换机</p>
<p>VMnet8:这是VMware用于虚拟NAT网络下的虚拟交换机</p>
<p>VMware Network Adapter VMnet1:这是Host用于Host-Only虚拟网络进行通信的虚拟网卡</p>
<p>VMware Network Adapter VMnet8:这是Host用于NAT虚拟网络进行通信的虚拟网卡</p>
<p>那么如何查看这些网卡的信息呢?</p>
<p>在windows主机命令行提示符环境中输入 ipconfig 便可以查询到VMware Network Adapter VMnet1,VMware Network Adapter VMnet8的ip地址.</p>
<h4 id="Bridge-桥接模式"><a href="#Bridge-桥接模式" class="headerlink" title="Bridge(桥接模式)"></a>Bridge(桥接模式)</h4><p>桥接模式就是将主机网卡与虚拟机网卡利用虚拟网桥进行通信,在桥接的作用下,类似把主机虚拟为一个交换机,所有桥接设置的虚拟机连接到这个交换机的一个接口上,物理主机也同样连接到这个交换机中,所以所有桥接下的网卡与网卡都是交换模式的,相互可以访问而不干扰,在桥接模式下,虚拟机的ip地址需要与主机在同一个网段,如果需要联网,则网关与DNS需要与主机网卡一致.</p>
<p>在桥接模式下,VMware虚拟出来的操作系统就像是局域网中的一台独立的主机,它可以访问该类网段内任何一台机器.</p>
<p>桥接网络环境下需要做到:</p>
<p>1.手动为虚拟机系统配置ip地址,子网掩码</p>
<p>2.在桥接的模式下虚拟机必须与物理机处于同一网段,(举个例子,物理机ip:192.168.1.2 虚拟机ip:192.168.1.3)这样虚拟系统才能和真实主机进行通信.</p>
<p>当我们想利用VMware在局域网内新建一个虚拟服务器,为局域网用户提供网络服务,就应该选择桥接模式,便可将虚拟机模拟接入主机所在的局域网,桥接网络相当于虚拟机与主机在一台交换机上,同时上网,虚拟机对物理机的直接影响较小.</p>
<p>但是桥接模式也有一定的问题,如果网络环境很缺少,或者对ip的管理比较严格的话,那桥接模式就不太适用了.如果解决这个问题就引入了vmware的另一种网络模式:NAT模式</p>
<h4 id="NAT-地址转换模式"><a href="#NAT-地址转换模式" class="headerlink" title="NAT(地址转换模式)"></a>NAT(地址转换模式)</h4><p>在NAT网络中,会使用到VMnet8虚拟交换机,物理机上的VMware Network Adapter VMnet8 虚拟网卡将会和VMnet8交换机相连,来实现物理机与虚拟机之间的通信.</p>
<p>注意:VMware Network Adapter VMnet8虚拟网卡仅仅是用于和VMnet8网段通信用的,它并不为VMnet8网段提供路由功能,处于虚拟NAT网络下的Guest是使用虚拟的NAT服务器连接的Internet的.</p>
<p>VMware Network Adapter VMnet8 虚拟网卡它仅仅是为Host和NAT虚拟网络下的Guest通信提供一个接口,所以,即便去掉这块网卡,虚拟机仍然是可以上网的,只是物理机无法再访问到VMnet8网段而已.</p>
<p>1.主机需要开启vmdhcp和vmnat服务.</p>
<p>2.NAT模式下的虚拟机的TCP/IP配置信息将由VMnet8(NAT)虚拟网络的DHCP服务器自动分配,需要开启DHCP功能.</p>
<p>使用NAT模式,就是让虚拟系统借助NAT功能,通过物理机所在的网络来访问外网,也就是说,使用NAT模式可以实现在虚拟机里访问到互联网,NAT模式下的虚拟机的TCP/IP配置信息是由VMnet8(NAT)虚拟网络的DHCP服务器提供的,无法进行手动修改,因此虚拟系统也就无法和本局域网中的其他真实主机进行通讯,采用NAT模式最大的优势就是虚拟系统接入互联网非常简单,不需要进行任何其他的配置,只需要宿主机能访问互联网即可.</p>
<p>NAT模式下的网络,相当于说虚拟机是通过物理机连接上的网络,等于物理机是个路由器,申请到一个上网的名额,带着隐藏在它下下面的虚拟机上网,自然所有的虚拟机使用的网络总和都限制在实体机的一个网络通道内,虚拟机会抢占物理机的网络,对物理机上网会有很大的影响.</p>
<h4 id="Host-Only-仅主机模式"><a href="#Host-Only-仅主机模式" class="headerlink" title="Host-Only(仅主机模式)"></a>Host-Only(仅主机模式)</h4><p>Host-Only模式其实就是NAT模式去除了虚拟NAT设备,然后使用VMware Network Adapter VMnet1 虚拟网卡连接VMnet1虚拟交换机来与虚拟机通信的,Host-Only模式将虚拟机与外网隔开,是虚拟机成为一个独立的系统,只与主机相互通讯.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96-%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96-%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2-%E4%BA%8C/" class="post-title-link" itemprop="url">运维自动化-系统部署(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-09-20 20:38:21 / 修改时间：20:46:57" itemprop="dateCreated datePublished" datetime="2018-09-20T20:38:21+08:00">2018-09-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="使用cobbler"><a href="#使用cobbler" class="headerlink" title="使用cobbler"></a>使用cobbler</h3><p>Cobbler:<br>    快速网络安装linux操作系统的服务，支持众多的Linux发行版：Red Hat、Fedora、CentOS、Debian、Ubuntu和SuSE，也可以支持网络安装windows<br>    PXE的二次封装，将多种安装参数封装到一个菜单<br>    Python编写<br>    提供了CLI和Web的管理形式</p>
<h4 id="cobbler-工作流程"><a href="#cobbler-工作流程" class="headerlink" title="cobbler 工作流程"></a>cobbler 工作流程</h4><pre><code>client裸机配置了从网络启动后，开机后会广播包请求DHCP服务器（cobbler server）发送其分配好的一个IP
DHCP服务器（cobbler server）收到请求后发送responese，包括其ip地址
client裸机拿到ip后再向cobbler server发送请求OS引导文件的请求
cobbler server告诉裸机OS引导文件的名字和TFTP server的ip和port
client裸机通过上面告知的TFTP server地址通信，下载引导文件
client裸机执行执行该引导文件，确定加载信息，选择要安装的os，期间会再向 cobbler server请求kickstart文件和os image
cobbler server发送请求的kickstart和os iamge
client裸机加载kickstart文件
client裸机接收os image，安装该os image</code></pre><h4 id="cobbler-介绍"><a href="#cobbler-介绍" class="headerlink" title="cobbler 介绍"></a>cobbler 介绍</h4><p>安装包<br>    cobbler 基于EPEL源<br>cobbler 服务集成<br>    PXE<br>    DHCP<br>    rsync<br>    Http<br>    DNS<br>    Kickstart<br>    IPMI 电源管理<br>检查cobbler环境<br>    cobbler check</p>
<p>cobbler 相关术语<br>    发行版：<br>        表示一个操作系统版本，它承载了内核和 initrd 的信息，以及内核参数等其他数据<br>    配置文件：<br>        包含一个发行版、一个 kickstart 文件以及可能的存储库，还包含更多特定的内核参数等其他数据<br>    系统：<br>        表示要配置的主机，它包含一个配置文件或一个镜像，还包含 IP 和 MAC 地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息<br>    存储库：<br>        保存一个 yum 或 rsync 存储库的镜像信息</p>
<h4 id="cobbler-各种配置目录说明"><a href="#cobbler-各种配置目录说明" class="headerlink" title="cobbler 各种配置目录说明"></a>cobbler 各种配置目录说明</h4><pre><code>安装：yum install cobbler dhcp
配置文件目录 /etc/cobbler
    /etc/cobbler/settings : cobbler 主配置文件
    /etc/cobbler/iso/: iso模板配置文件
    /etc/cobbler/pxe: pxe模板文件
    /etc/cobbler/power: 电源配置文件
    /etc/cobbler/user.conf: web服务授权配置文件
    /etc/cobbler/users.digest: web访问的用户名密码配置文件
    /etc/cobbler/dhcp.template : dhcp服务器的的配置末班
    /etc/cobbler/dnsmasq.template : dns服务器的配置模板
    /etc/cobbler/tftpd.template : tftp服务的配置模板
    /etc/cobbler/modules.conf : 模块的配置文件</code></pre><h4 id="cobbler-目录介绍"><a href="#cobbler-目录介绍" class="headerlink" title="cobbler 目录介绍"></a>cobbler 目录介绍</h4><p>数据目录<br>    /var/lib/cobbler/config/: 用于存放distros，system，profiles 等信息配置文件<br>    /var/lib/cobbler/triggers/: 用于存放用户定义的cobbler命令<br>    /var/lib/cobbler/kickstart/: 默认存放kickstart文件<br>    /var/lib/cobbler/loaders/: 存放各种引导程序</p>
<p>镜像目录<br>    /var/www/cobbler/ks_mirror/: 导入的发行版系统的所有数据<br>    /var/www/cobbler/images/ : 导入发行版的kernel和initrd镜像用于远程网络启动<br>    /var/www/cobbler/repo_mirror/: yum 仓库存储目录</p>
<p>日志目录<br>    /var/log/cobbler/installing: 客户端安装日志<br>    /var/log/cobbler/cobbler.log : cobbler日志</p>
<h4 id="cobbler-命令介绍"><a href="#cobbler-命令介绍" class="headerlink" title="cobbler 命令介绍"></a>cobbler 命令介绍</h4><p>cobbler check 核对当前设置是否有问题<br>cobbler list 列出所有的cobbler元素<br>cobbler report 列出元素的详细信息<br>cobbler sync 同步配置到数据目录,更改配置最好都要执行下<br>cobbler reposync 同步yum仓库<br>cobbler distro 查看导入的发行版系统信息<br>cobbler system 查看添加的系统信息<br>cobbler profile 查看配置信息</p>
<h4 id="cobbler-重要的参数"><a href="#cobbler-重要的参数" class="headerlink" title="cobbler 重要的参数"></a>cobbler 重要的参数</h4><pre><code>/etc/cobbler/settings中重要的参数设置
default_password_crypted: &quot;$1$gEc7ilpP$pg5iSOj/mlxTxEslhRvyp/&quot;
manage_dhcp：1
manage_tftpd：1
pxe_just_once：1
next_server：&lt; tftp服务器的 IP 地址&gt;
server：&lt;cobbler服务器的 IP 地址&gt;</code></pre><h4 id="cobbler-环境检查"><a href="#cobbler-环境检查" class="headerlink" title="cobbler 环境检查"></a>cobbler 环境检查</h4><p>执行Cobbler check命令会报如下异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1 : The ‘server’ field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than localhost, or kickstarting features will not work. This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the ‘next_server’ field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.</span><br><span class="line">3 : some network boot-loaders are missing from &#x2F;var&#x2F;lib&#x2F;cobbler&#x2F;loaders, you may run ‘cobbler get-loaders’ to download them, or, if you only want to handle x86&#x2F;x86_64 netbooting, you may ensure that you have installed a recent version of the syslinux package installed and can ignore this message entirely. Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The ‘cobbler get-loaders’ command is the easiest way to resolve these requirements.</span><br><span class="line">4 : change ‘disable’ to ‘no’ in &#x2F;etc&#x2F;xinetd.d&#x2F;rsync</span><br><span class="line">5 : comment ‘dists’ on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">6 : comment ‘arches’ on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">7 : The default password used by the sample templates for newly installed machines (default_password_crypted in &#x2F;etc&#x2F;cobbler&#x2F;settings)</span><br><span class="line">is still set to ‘cobbler’ and should be changed, try: “openssl passwd -1 -salt ‘random-phrase-here’ ‘your-password-here’” to generate new one</span><br><span class="line">8 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br></pre></td></tr></table></figure>



<h4 id="cobbler-报错解决"><a href="#cobbler-报错解决" class="headerlink" title="cobbler 报错解决"></a>cobbler 报错解决</h4><pre><code>执行Cobbler check报错解决方式
修改/etc/cobbler/settings文件中的server参数的值为提供cobbler服务的主机相应的IP地址或主机名
修改/etc/cobbler/settings文件中的next_server参数的值为提供PXE服务的主机相应的IP地址
如果当前节点可以访问互联网，执行“cobbler get-loaders”命令即可；否则，需要安装syslinux程序包，而后复制/usr/share/syslinux/{pxelinux.0,memu.c32}等文件至/var/lib/cobbler/loaders/目录中
执行“chkconfig rsync on”命令即可
执行“openssl passwd -1 生成密码，并用其替换/etc/cobbler/settings文件中default_password_crypted参数的值</code></pre><h4 id="cobbler-相关管理"><a href="#cobbler-相关管理" class="headerlink" title="cobbler 相关管理"></a>cobbler 相关管理</h4><pre><code>下载启动菜单：
    联网：cobbler get-loaders
    不联网：cp /usr/share/syslinux/{pxelinux.0,menu.c32}  /var/lib/tftpboot

管理distro
    cobbler import --name=centos-7.5-x86_64 --path=/media/cdrom --arch=x86_64

管理profile
    cobbler profile add --name=centos-7.5-x86_64-basic --distro=centos-7.5-x86_64 --kickstart= /var/lib/cobbler/kickstarts/centos7_x86_64.cfg</code></pre><h4 id="cobbler-命令"><a href="#cobbler-命令" class="headerlink" title="cobbler 命令"></a>cobbler 命令</h4><pre><code>查看profiles
    cobbler profile list
查看引导文件
    cat /var/lib/tftpboot/pxelinux.cfg/default
同步cobbler配置
    cobbler sync
多系统引导方案
    cobbler import --name=CentOS-7-x86_64 --path=/media/cdrom 
    cobbler distro list
    cobbler profile list 
    cobbler sync</code></pre><h4 id="cobbler-实现步骤"><a href="#cobbler-实现步骤" class="headerlink" title="cobbler 实现步骤"></a>cobbler 实现步骤</h4><pre><code>安装包，并设置服务
检查配置
根据上面提示修改配置
下载启动相关文件菜单
配置DHCP服务
分别导入centos的安装源,并查看
准备kickstart文件并导入cobbler
测试</code></pre><h4 id="cobbler的web管理实现"><a href="#cobbler的web管理实现" class="headerlink" title="cobbler的web管理实现"></a>cobbler的web管理实现</h4><p>cobbler-web</p>
<pre><code>提供cobbler的基于web管理界面，epel源 yum install cobbler-web

认证方式
    认证方法配置文件：/etc/cobbler/modules.conf
    支持多种认证方法：
        authn_configfile
        authn_pam</code></pre><p>  使用authn_configfile模块认证cobbler_web用户<br>        vim /etc/cobbler/modules.conf<br>        [authentication]<br>        module=authn_configfile</p>
<p>创建其认证文件/etc/cobbler/users.digest，并添加所需的用户 htdigest -c /etc/cobbler/users.digest Cobbler admin<br>注意:添加第一个用户时,使用“-c”选项，后续添加其他用户时不要再使用，cobbler_web的realm只能为Cobbler</p>
<pre><code>使用authn_pam模块认证cobbler_web用户
    vim /etc/cobbler/modules.conf 
    [authentication]
    module = authn_pam
创建cobbler用户：useradd cobbler
    vim /etc/cobbler/users.conf
    [admins]
    admin = &quot;cobbler“

Web访问cobbler
    重启cobblerd服务
    通过https://cobblerserver/cobbler_web访问</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mark"
      src="/images/mark_avatar.png">
  <p class="site-author-name" itemprop="name">Mark</p>
  <div class="site-description" itemprop="description">半吊子民工 英特纳雄耐尔就一定要实现</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:markupzh@gmail.com" title="E-Mail → mailto:markupzh@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mark</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
