<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/M_32px.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/M_16px.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":7,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
<meta property="og:type" content="website">
<meta property="og:title" content="Mark blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Mark blog">
<meta property="og:description" content="半吊子民工 英特纳雄耐尔就一定要实现">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Mark">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Mark blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Mark blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">知行合一 划水归档</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/AWK-%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8-%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/AWK-%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8-%E4%B8%80/" class="post-title-link" itemprop="url">AWK 工具的使用(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-09-11 13:18:12 / 修改时间：16:46:22" itemprop="dateCreated datePublished" datetime="2018-09-11T13:18:12+08:00">2018-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="AWK介绍"><a href="#AWK介绍" class="headerlink" title="AWK介绍"></a>AWK介绍</h3><p>awk:Aho, Weinberger, Kernighan,报告生成器,格式化文本输出<br> 有多种版本:New awk(nawk),GNU awk( gawk)<br> gawk:模式扫描和处理语言<br> 基本用法:<br>    awk [options] ‘program’ var=value file…<br>    awk [options] -f programfile var=value file…<br>    awk [options] ‘BEGIN{ action;… } pattern{ action;… } END{ action;… }’ file …<br>    awk 程序通常由:BEGIN语句块、能够使用模式匹配的通用语句块、END语句块,共3部分组成<br>    program通常是被单引号或双引号中<br> 选项:<br>    -F 指明输入时用到的字段分隔符<br>    -v var=value: 自定义变量</p>
<h3 id="awk语言"><a href="#awk语言" class="headerlink" title="awk语言"></a>awk语言</h3><p>基本格式:awk [options] ‘program’ file…<br>program:pattern{action statements;..}<br>pattern和action:<br>• pattern部分决定动作语句何时触发及触发事件<br>    BEGIN,END<br>• action statements对数据进行处理,放在{}内指明<br>    print, printf<br>分割符、域和记录<br>• awk执行时,由分隔符分隔的字段(域)标记$1,$2..$n称为域标识.$0为所有域,注意:和shell中变量$符含义不同<br>• 文件的每一行称为记录<br>• 省略action,则默认执行 print $0 的操作</p>
<h3 id="awk工作原理"><a href="#awk工作原理" class="headerlink" title="awk工作原理"></a>awk工作原理</h3><p>第一步:执行BEGIN{action;… }语句块中的语句</p>
<p>第二步:从文件或标准输入(stdin)读取一行,然后执行pattern{ action;… }语句块,它逐行扫描文件,从第一行到最后一行重复这个过程,直到文件全部被读取完毕.</p>
<p>第三步:当读至输入流末尾时,执行END{action;…}语句块</p>
<p>BEGIN语句块在awk开始从输入流中读取行之前被执行,这是一个可选的语句块,比如变量初始化、打印输出表格的表头等语句通常可以写在BEGIN语句块中</p>
<p>END语句块在awk从输入流中读取完所有的行之后即被执行,比如打印所有行的分析结果这类信息汇总都是在END语句块中完成,它也是一个可选语句块</p>
<p>pattern语句块中的通用命令是最重要的部分,也是可选的.如果没有提供pattern语句块,则默认执行{ print },即打印每一个读取到的行,awk读取的每一行都会执行该语句块</p>
<h3 id="awk格式与示例"><a href="#awk格式与示例" class="headerlink" title="awk格式与示例"></a>awk格式与示例</h3><p>print格式: print item1, item2, …<br> 要点:<br>    (1) 逗号分隔符<br>    (2) 输出的各item可以字符串,也可以是数值；当前记录的字段、变量或awk的表达式<br>    (3) 如省略item,相当于print $0<br> 示例:<br>    awk ‘{print “hello,awk”}’<br>    awk –F: ‘{print}’ /etc/passwd<br>    awk –F: ‘{print “wang”}’ /etc/passwd<br>    awk –F: ‘{print $1}’ /etc/passwd<br>    awk –F: ‘{print $0}’ /etc/passwd<br>    awk –F: ‘{print $1”\t”$3}’ /etc/passwd<br>    tail –3 /etc/fstab |awk ‘{print $2,$4}’</p>
<h3 id="awk变量与参数"><a href="#awk变量与参数" class="headerlink" title="awk变量与参数"></a>awk变量与参数</h3><p>变量:内置和自定义变量<br> FS:输入字段分隔符,默认为空白字符<br>    awk -v FS=’:’ ‘{print $1,FS,$3}’ /etc/passwd<br>    awk –F: ‘{print $1,$3,$7}’ /etc/passwd<br> OFS:输出字段分隔符,默认为空白字符<br>    awk -v FS=‘:’ -v OFS=‘:’ ‘{print $1,$3,$7}’ /etc/passwd<br> RS:输入记录分隔符,指定输入时的换行符<br>    awk -v RS=’ ‘ ‘{print }’ /etc/passwd<br> ORS:输出记录分隔符,输出时用指定符号代替换行符<br>    awk -v RS=’ ‘ -v ORS=’###’‘{print }’ /etc/passwd<br> NF:字段数量<br>    awk -F: ‘{print NF}’ /etc/fstab,引用内置变量不用$<br>    awk -F: ‘{print $(NF-1)}’ /etc/passwd<br> NR:记录号<br>    awk ‘{print NR}’ /etc/fstab ; awk END’{print NR}’ /etc/fstab</p>
<p>FNR:各文件分别计数,记录号<br>    awk ‘{print FNR}’ /etc/fstab /etc/inittab<br>FILENAME:当前文件名<br>    awk ‘{print FILENAME}’ /etc/fstab<br>ARGC:命令行参数的个数<br>    awk ‘{print ARGC}’ /etc/fstab /etc/inittab<br>    awk ‘BEGIN {print ARGC}’ /etc/fstab /etc/inittab<br>ARGV:数组,保存的是命令行所给定的各参数<br>    awk ‘BEGIN {print ARGV[0]}’ /etc/fstab /etc/inittab<br>    awk ‘BEGIN {print ARGV[1]}’ /etc/fstab /etc/inittab</p>
<p>自定义变量(区分字符大小写)<br>    (1) -v var=value<br>    (2) 在program中直接定义<br>示例:<br>    awk -v test=’hello gawk’ ‘{print test}’ /etc/fstab<br>    awk -v test=’hello gawk’ ‘BEGIN{print test}’<br>    awk ‘BEGIN{test=”hello,gawk”;print test}’<br>    awk –F:‘{sex=“male”;print $1,sex,age;age=18}’    /etc/passwd<br>    cat awkscript<br>    {print script,$1,$2}<br>    awk -F: -f awkscript script=“awk” /etc/passwd</p>
<h3 id="printf命令"><a href="#printf命令" class="headerlink" title="printf命令"></a>printf命令</h3><p>格式化输出:printf “FORMAT”, item1, item2, …<br>    (1) 必须指定FORMAT<br>    (2) 不会自动换行,需要显式给出换行控制符,\n<br>    (3) FORMAT中需要分别为后面每个item指定格式符<br> 格式符:与item一一对应<br>    %c: 显示字符的ASCII码<br>    %d, %i: 显示十进制整数<br>    %e, %E:显示科学计数法数值<br>    %f:显示为浮点数<br>    %g, %G:以科学计数法或浮点形式显示数值<br>    %s:显示字符串<br>    %u:无符号整数<br>    %%: 显示%自身<br> 修饰符:<br>    #[.#]:第一个数字控制显示的宽度；第二个#表示小数点后精度,%3.1f<br>    -: 左对齐(默认右对齐) %-15s<br>    +:显示数值的正负符号 %+d</p>
<h3 id="printf示例"><a href="#printf示例" class="headerlink" title="printf示例"></a>printf示例</h3><p>awk -F: ‘{printf “%s”,$1}’ /etc/passwd<br>awk -F: ‘{printf “%s\n”,$1}’ /etc/passwd<br>awk -F: ‘{printf “%-20s %10d\n”,$1,$3}’ /etc/passwd<br>awk -F: ‘{printf “Username: %s\n”,$1}’ /etc/passwd<br>awk -F: ‘{printf “Username: %s,UID:%d\n”,$1,$3}’ /etc/passwd<br>awk -F: ‘{printf “Username: %15s,UID:%d\n”,$1,$3}’ /etc/passwd<br>awk -F: ‘{printf “Username: %-15s,UID:%d\n”,$1,$3}’ /etc/passwd</p>
<h3 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h3><p>算术操作符:<br>    x+y, x-y, x*y, x/y, x^y, x%y<br>    -x: 转换为负数<br>    +x: 转换为数值<br>字符串操作符:没有符号的操作符,字符串连接<br>赋值操作符:<br>    =, +=, -=, *=, /=, %=, ^=<br>    ++, –<br>比较操作符:<br>    ==, !=, &gt;, &gt;=, &lt;, &lt;=<br>模式匹配符:<br>    <del>:左边是否和右边匹配包含 !</del>:是否不匹配<br>示例:<br>    awk –F: ‘$0 ~ /root/{print $1}‘ /etc/passwd<br>    awk ‘$0<del>“^root”‘ /etc/passwd<br>    awk ‘$0 !</del> /root/‘ /etc/passwd<br>    awk –F: ‘$3==0’ /etc/passwd</p>
<p>逻辑操作符:与&amp;&amp;,或||,非!<br> 示例:<br>• awk –F: ‘$3&gt;=0 &amp;&amp; $3&lt;=1000 {print $1}’ /etc/passwd<br>• awk -F: ‘$3==0 || $3&gt;=1000 {print $1}’ /etc/passwd<br>• awk -F: ‘!($3==0) {print $1}’ /etc/passwd<br>• awk -F: ‘!($3&gt;=500) {print $3}’ /etc/passwd<br> 函数调用: function_name(argu1, argu2, …)<br> 条件表达式(三目表达式):<br>    selector?if-true-expression:if-false-expression<br>• 示例:<br>    awk -F: ‘{$3&gt;=1000?usertype=”Common User”:usertype=”Sysadmin or SysUser”;printf<br>“%15s:%-s\n”,$1,usertype}’ /etc/passwd</p>
<h3 id="awk-PATTERN"><a href="#awk-PATTERN" class="headerlink" title="awk PATTERN"></a>awk PATTERN</h3><p>PATTERN:根据pattern条件,过滤匹配的行,再做处理<br>(1)如果未指定:空模式,匹配每一行<br>(2) /regular expression/:仅处理能够模式匹配到的行,需要用/ /括起来<br>    awk ‘/^UUID/{print $1}’ /etc/fstab<br>    awk ‘!/^UUID/{print $1}’ /etc/fstab<br>(3) relational expression: 关系表达式,结果为“真”才会被处理<br>    真:结果为非0值,非空字符串<br>    假:结果为空字符串或0值<br> 示例:<br>• awk -F: ‘i=1;j=1{print i,j}’ /etc/passwd<br>• awk ‘!0’ /etc/passwd ; awk ‘!1’ /etc/passwd<br>• awk –F: ‘$3&gt;=1000{print $1,$3}’ /etc/passwd<br>• awk -F: ‘$3&lt;1000{print $1,$3}’ /etc/passwd<br>• awk -F: ‘$NF==”/bin/bash”{print $1,$NF}’ /etc/passwd<br>• awk -F: ‘$NF ~ /bash$/{print $1,$NF}’ /etc/passwd</p>
<p>4) line ranges:行范围<br>    startline,endline:/pat1/,/pat2/ 不支持直接给出数字格式<br>    awk -F: ‘/^root&gt;/,/^nobody&gt;/{print $1}’ /etc/passwd<br>    awk -F: ‘(NR&gt;=10&amp;&amp;NR&lt;=20){print NR,$1}’ /etc/passwd<br>(5) BEGIN/END模式<br>    BEGIN{}: 仅在开始处理文件中的文本之前执行一次<br>    END{}:仅在文本处理完成之后执行一次</p>
<p>awk例程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">awk -F : 'BEGIN &#123;print "USER USERID"&#125; &#123;print $1":"$3&#125; END&#123;print "end file"&#125;'</span><br><span class="line">/etc/passwd</span><br><span class="line">awk -F : '&#123;print "USER USERID“;print $1":"$3&#125; END&#123;print "end file"&#125;' /etc/passwd</span><br><span class="line">awk -F: 'BEGIN&#123;print " USER UID \n--------------- "&#125;&#123;print $1,$3&#125;' /etc/passwd</span><br><span class="line">awk -F: 'BEGIN&#123;print " USER UID \n--------------- "&#125;&#123;print $1,$3&#125;'END&#123;print</span><br><span class="line">"=============="&#125; /etc/passwd</span><br><span class="line">seq 10 |awk ‘i=0’</span><br><span class="line">seq 10 |awk ‘i=1’</span><br><span class="line">seq 10 | awk 'i=!i‘</span><br><span class="line">seq 10 | awk '&#123;i=!i;print i&#125;‘</span><br><span class="line">seq 10 | awk ‘!(i=!i)’</span><br><span class="line">seq 10 |awk -v i=1 'i=!i'</span><br></pre></td></tr></table></figure>



<h3 id="awk-action"><a href="#awk-action" class="headerlink" title="awk action"></a>awk action</h3><p>常用的action分类<br>• (1) Expressions:算术,比较表达式等<br>• (2) Control statements:if, while等<br>• (3) Compound statements:组合语句<br>• (4) input statements<br>• (5) output statements:print等</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/SELinux-%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/SELinux-%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">SELinux 简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-09-11 13:17:49 / 修改时间：16:09:27" itemprop="dateCreated datePublished" datetime="2018-09-11T13:17:49+08:00">2018-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="SELinux介绍"><a href="#SELinux介绍" class="headerlink" title="SELinux介绍"></a>SELinux介绍</h3><p>SELinux: Secure Enhanced Linux, 是美国国家安全局(NSA=The National Security Agency)和SCC(Secure Computing Corporation)开发的 Linux的一个强制访问控制的安全模块.2000年以GNU GPL发布,Linux内核2.6版本后集成在内核中<br>DAC:Discretionary Access Control自由访问控制<br>MAC:Mandatory Access Control 强制访问控制<br>• DAC环境下进程是无束缚的<br>• MAC环境下策略的规则决定控制的严格程度<br>• MAC环境下进程可以被限制的<br>• 策略被用来定义被限制的进程能够使用那些资源(文件和端口)<br>• 默认情况下,没有被明确允许的行为将被拒绝</p>
<h3 id="SELinux工作类型"><a href="#SELinux工作类型" class="headerlink" title="SELinux工作类型"></a>SELinux工作类型</h3><p>SELinux有四种工作类型:<br>    strict: centos5,每个进程都受到selinux的控制<br>    targeted: 用来保护常见的网络服务,仅有限进程受到selinux控制,只监控容易被入侵的进程,centos4只保护13个服务,centos5保护88个服务<br>    minimum:centos7,修改的targeted,只对选择的网络服务<br>    mls:提供MLS(多级安全)机制的安全性<br>targeted为默认类型,minimum和mls稳定性不足,未加以应用,strict已不再使用</p>
<h3 id="SELinux安全上下文"><a href="#SELinux安全上下文" class="headerlink" title="SELinux安全上下文"></a>SELinux安全上下文</h3><p>传统Linux,一切皆文件,由用户,组,权限控制访问<br>在SELinux中,一切皆对象(object),由存放在inode的扩展属性域的安全元素所控制其访问<br>所有文件和端口资源和进程都具备安全标签:安全上下文(security context)<br>安全上下文有五个元素组成:<br>    user:role:type:sensitivity:category<br>    user_u:object_r:tmp_t:s0:c0<br> 实际上下文:存放在文件系统中,ls –Z;ps –Z<br>期望(默认)上下文:存放在二进制的SELinux策略库(映射目录和期望安全上下<br>文)中<br>    semanage fcontext –l</p>
<h3 id="五个安全元素"><a href="#五个安全元素" class="headerlink" title="五个安全元素"></a>五个安全元素</h3><p>User:指示登录系统的用户类型,进程:如system_u为系统服务进程,是受到管制的,unconfined_u为不管制的进程,用户自己开启的,如 bash,文件:system_u系统进程创建的文件, unconfined_u为用户自已创建的文件<br>Role:定义文件,进程和用户的用途:进程:system_r为系统服务进程,受到管制.unconfined_r 为不管制进程,通常都是用户自己开启的,如 bash,文件:object_r<br>Type:指定数据类型,规则中定义何种进程类型访问何种文件Target策略基于type实现,多服务共用:public_content_t<br>Sensitivity:限制访问的需要,由组织定义的分层安全级别,如<br>unclassified,secret,top,secret, 一个对象有且只有一个sensitivity,分0-15级,s0最低,Target策略默认使用s0<br>Category:对于特定组织划分不分层的分类,如FBI Secret,NSA secret, 一个对象可以有多个categroy, c0-c1023共1024个分类, Target 策略不使用category</p>
<h3 id="SELinux策略"><a href="#SELinux策略" class="headerlink" title="SELinux策略"></a>SELinux策略</h3><p>对象(object):所有可以读取的对象,包括文件、目录和进程,端口等<br>主体:进程称为主体(subject)<br>SELinux中对所有的文件都赋予一个type的文件类型标签,对于所有的进程也赋予各自的一个domain的标签.domain标签能够执行的操作由安全策略里定义<br>当一个subject试图访问一个object,Kernel中的策略执行服务器将检查AVC (访问矢量缓存Access Vector Cache), 在AVC中,subject和object的权限被缓存(cached),查找“应用+文件”的安全环境.然后根据查询结果允许或拒绝访问<br>安全策略:定义主体读取对象的规则数据库,规则中记录了哪个类型的主体使用哪个方法读取哪一个对象是允许还是拒绝的,并且定义了哪种行为是充许或拒绝</p>
<h3 id="设置SELinux"><a href="#设置SELinux" class="headerlink" title="设置SELinux"></a>设置SELinux</h3><p>配置SELinux:<br>    SELinux是否启用<br>    给文件重新打安全标签<br>    给端口设置安全标签<br>    设定某些操作的布尔型开关<br>    SELinux的日志管理<br>SELinux的状态:<br>    enforcing: 强制,每个受限的进程都必然受限<br>    permissive: 允许,每个受限的进程违规操作不会被禁止,但会被记录于审<br>计日志<br>    disabled: 禁用</p>
<h3 id="配置SELinux"><a href="#配置SELinux" class="headerlink" title="配置SELinux"></a>配置SELinux</h3><p>相关命令:<br>    getenforce: 获取selinux当前状态<br>    sestatus :查看selinux状态<br>    setenforce 0|1<br>        0: 设置为permissive<br>        1: 设置为enforcing<br>配置文件:<br>    /boot/grub/grub.conf<br>        在kernel行使用selinux=0禁用SELinux<br>    /etc/selinux/config<br>    /etc/sysconfig/selinux<br>    SELINUX={disabled|enforcing|permissive}</p>
<h3 id="修改SELinux安全标签"><a href="#修改SELinux安全标签" class="headerlink" title="修改SELinux安全标签"></a>修改SELinux安全标签</h3><p>给文件重新打安全标签:<br>    chcon [OPTION]… [-u USER][-r ROLE] [-t TYPE] FILE…<br>    chcon [OPTION]… –reference=RFILE FILE…<br>    -R:递归打标<br>恢复目录或文件默认的安全上下文:<br>    restorecon [-R] /path/to/somewhere</p>
<h3 id="默认安全上下文查询与修改"><a href="#默认安全上下文查询与修改" class="headerlink" title="默认安全上下文查询与修改"></a>默认安全上下文查询与修改</h3><p>semanage:来自policycoreutils-python包<br>查看默认的安全上下文<br>    semanage fcontext –l<br>添加安全上下文<br>    semanage fcontext -a –t httpd_sys_content_t ‘/testdir(/.*)?’</p>
<pre><code>restorecon –Rv /testdir</code></pre><p>删除安全上下文<br>    semanage fcontext -d –t httpd_sys_content_t ‘/testdir(/.*)?’</p>
<h3 id="SElinux端口标签"><a href="#SElinux端口标签" class="headerlink" title="SElinux端口标签"></a>SElinux端口标签</h3><p>查看端口标签<br>    semanage port –l<br>添加端口<br>    semanage port -a -t port_label -p tcp|udp PORT<br>    semanage port -a -t http_port_t -p tcp 9527<br>删除端口<br>    semanage port -d -t port_label -p tcp|udp PORT<br>    semanage port -d -t http_port_t -p tcp 9527<br>修改现有端口为新标签<br>    semanage port -m -t port_label -p tcp|udp PORT<br>    semanage port -m -t http_port_t -p tcp 9527 </p>
<h3 id="SELinux布尔值"><a href="#SELinux布尔值" class="headerlink" title="SELinux布尔值"></a>SELinux布尔值</h3><p>布尔型规则:<br>    getsebool<br>    setsebool<br>查看bool命令:<br>    getsebool [-a][boolean]<br>    semanage boolean –l<br>    semanage boolean -l –C 查看修改过的布尔值<br>设置bool值命令:<br>    setsebool [-P] boolean value(on,off)<br>    setsebool [-P] Boolean=value(0,1)</p>
<h3 id="SELinux日志管理"><a href="#SELinux日志管理" class="headerlink" title="SELinux日志管理"></a>SELinux日志管理</h3><p>yum install setroubleshoot(重启生效)<br>将错误的信息写入/var/log/message<br>    grep setroubleshoot /var/log/messages<br>查看安全事件日志说明<br>    sealert -l UUID<br>扫描并分析日志<br>    sealert -a /var/log/audit/audit.log</p>
<h3 id="SELinux帮助"><a href="#SELinux帮助" class="headerlink" title="SELinux帮助"></a>SELinux帮助</h3><p>yum –y install selinux-policy-devel ( centos7.2)<br>yum –y install selinux-policy-doc<br>mandb | makewhatis<br>man -k _selinux</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/Linux-%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Linux-%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86-%E4%BA%8C/" class="post-title-link" itemprop="url">Linux 启动和内核管理(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-09-11 13:17:08 / 修改时间：16:52:17" itemprop="dateCreated datePublished" datetime="2018-09-11T13:17:08+08:00">2018-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="grub-legacy"><a href="#grub-legacy" class="headerlink" title="grub legacy"></a>grub legacy</h3><p>CentOS 6启动流程：<br>POST –&gt; Boot Sequence(BIOS) –&gt; Boot Loader –&gt; Kernel(ramdisk)<br>–&gt; rootfs –&gt; switchroot –&gt; /sbin/init –&gt;(/etc/inittab, /etc/init/*.conf) –&gt; 设定默认运行级别 –&gt; 系统初始化脚本rc.sysinit –&gt; 关闭或启动对应级别的服务 –&gt; 启动终端<br>grub: GRand Unified Bootloader<br>    grub 0.97: grub legacy<br>    grub 2.x: grub2<br>    grub legacy:<br>        stage1: mbr<br>        stage1_5: mbr之后的扇区,让stage1中的bootloader能识别stage2所在的分区上的文件系统<br>        stage2：磁盘分区(/boot/grub/)</p>
<p>配置文件：/boot/grub/grub.conf &lt;– /etc/grub.conf<br>stage2及内核等通常放置于一个基本磁盘分区<br>功用：<br>(1) 提供启动菜单、并提供交互式接口<br>    a：内核参数<br>    e: 编辑模式,用于编辑菜单<br>    c: 命令模式,交互式接口<br>(2) 加载用户选择的内核或操作系统<br>    允许传递参数给内核<br>    可隐藏启动菜单<br>(3) 为菜单提供了保护机制<br>    为编辑启动菜单进行认证<br>    为启用内核或操作系统进行认证</p>
<p>grub的命令行接口<br>    help: 获取帮助列表<br>    help KEYWORD: 详细帮助信息<br>    find (hd#,#)/PATH/TO/SOMEFILE：<br>    root (hd#,#)<br>    kernel /PATH/TO/KERNEL_FILE: 设定本次启动时用到的内核文件；额外还可添加许多内核支持使用的cmdline参数<br>    例如：max_loop=100 selinux=0 init=/path/to/init<br>    initrd /PATH/TO/INITRAMFS_FILE: 设定为选定的内核提供额外文件的ramdisk<br>    boot: 引导启动选定的内核<br> cat /proc/cmdline 内核参数<br> 内核参数文档:/usr/share/doc/kernel-doc-.6.32/Documentation/kernelparameters.txt</p>
<p>识别硬盘设备<br>    (hd#,#)<br>    hd#: 磁盘编号,用数字表示；从0开始编号<br>    #: 分区编号,用数字表示: 从0开始编号<br>    (hd0,0) 第一块硬盘,第一个分区<br>手动在grub命令行接口启动系统<br>    grub&gt; root (hd#,#)<br>    grub&gt; kernel /vmlinuz-VERSION-RELEASE ro root=/dev/DEVICE<br>    grub&gt; initrd /initramfs-VERSION-RELEASE.img<br>    grub&gt; boot</p>
<h3 id="grub-安装"><a href="#grub-安装" class="headerlink" title="grub 安装"></a>grub 安装</h3><p>安装grub：<br>    (1) grub-install<br>    安装grub stage1和stage1_5到/dev/DISK磁盘上,并复制GRUB相关文件到 DIR/boot目录下<br>    grub-install –root-directory=DIR /dev/DISK<br>    (2) grub<br>    grub&gt; root (hd#,#)<br>    grub&gt; setup (hd#)</p>
<h3 id="grub-legacy配置文件"><a href="#grub-legacy配置文件" class="headerlink" title="grub legacy配置文件"></a>grub legacy配置文件</h3><p>配置文件：/boot/grub/grub.conf<br>default=#: 设定默认启动的菜单项；落单项(title)编号从0开始<br>timeout=#：指定菜单项等待选项选择的时长<br>splashimage=(hd#,#)/PATH/XPM_FILE：菜单背景图片文件路径<br>password [–md5] STRING: 启动菜单编辑认证<br>hiddenmenu：隐藏菜单<br>title TITLE：定义菜单项”标题”, 可出现多次<br>root (hd#,#)：查找stage2及kernel文件所在设备分区；为grub的根<br>kernel /PATH/TO/VMLINUZ_FILE [PARAMETERS]：启动的内核<br>initrd /PATH/TO/INITRAMFS_FILE: 内核匹配的ramfs文件<br>password [–md5|–encrypted ] STRING: 启动选定的内核或操作系统时进行认证</p>
<h3 id="自制linux系统"><a href="#自制linux系统" class="headerlink" title="自制linux系统"></a>自制linux系统</h3><p>分区并创建文件系统<br>    fdisk /dev/sdb<br>    分两个必要的分区<br>    /dev/sdb1对应/boot /dev/sdb2对应根 /<br>    mkfs.ext4 /dev/sdb1<br>    mkfs.ext4 /dev/sdb2<br>挂载boot<br>    mkdir /mnt/boot 子目录必须为boot<br>    mount /dev/sdb1 /mnt/boot<br>安装grub<br>    grub-install –root-directory=/mnt /dev/sdb</p>
<p>恢复内核和initramfs文件<br>    cp /boot/vmlinuz-2.6.32-642.el6.x86_64 /mnt/boot/<br>    cp /boot/initramfs-2.6.32-642.el6.x86_64.img /mnt/boot<br>建立grub.conf<br>    vim /mnt/boot/grub.conf<br>        title wanglinux<br>        root (hd0,0)<br>        kernel /vmlinuz-2.6.32-642.el6.x86_64 root=/dev/sda2 selinux=0 init=/bin/bash<br>        initrd /initramfs-2.6.32-642.el6.x86_64.img<br>chroot /mnt/sysroot</p>
<p>创建一级目录<br>    mkdir /mnt/sysroot<br>    mount /dev/sdb2 /mnt/sysroot<br>    mkdir –pv<br>/mnt/sysroot/{etc,lib,lib64,bin,sbin,tmp,var,usr,sys,proc,opt,home,root,boot,dev,mnt,media}<br>复制bash和相关库文件<br>复制相关命令及相关库文件<br>    如：ifconfig,insmod,ping,mount,ls,cat,df,lsblk,blkid等</p>
<h3 id="救援环境"><a href="#救援环境" class="headerlink" title="救援环境"></a>救援环境</h3><p>在根文件系统无法使用时需要,如/bin/mount删除<br>对系统没有特殊要求<br>从光盘引导（boot.iso或者安装光盘#1）<br>从USB盘（可由boot.iso制作）引导</p>
<p>文件系统重组<br>Anaconda将会询问是否应该挂载文件系统<br>/mnt/sysimage/*<br>/mnt/stage2<br>$PATH包括硬盘的目录<br>文件系统节点<br>提供系统特定的设备文件<br>mknod了解major/minor </p>
<h3 id="系统配置文件丢失修复"><a href="#系统配置文件丢失修复" class="headerlink" title="系统配置文件丢失修复"></a>系统配置文件丢失修复</h3><p>系统在引导期间,很重要的一个过程就是init进程读取其配置文件/etc/inittab,启动系统基本服务程序及默认运行级别的服务程序完成系统引导,如果/etc/inittab误删除或修改错误,Linux将无法正常启动.此时,只有通过救援模式才可以解决此类问题.<br>• 有备份文件的回复方法<br>• 没有备份文件的恢复办法</p>
<h4 id="有备份文件的恢复办法："><a href="#有备份文件的恢复办法：" class="headerlink" title="有备份文件的恢复办法："></a>有备份文件的恢复办法：</h4><p>进入救援模式,执行chroot命令后,如果有此文件的备份（强烈建议系统中的重要数据目录,如/etc、/boot等要进行备份）,直接将备份文件拷贝回去,退出重启即可.如果是配置文件修改错误,如比较典型的/boot/grub/grub.conf及/etc/passwd的文件修改错误,也可以直接修正恢复.假设有备份文件/etc/inittab.bak,则在救援模式下执行：<br>    chroot /mnt/sysimage<br>    cp /etc/inittab.bak /etc/inittab</p>
<h4 id="没有备份文件的恢复办法"><a href="#没有备份文件的恢复办法" class="headerlink" title="没有备份文件的恢复办法"></a>没有备份文件的恢复办法</h4><p>如果一些配置文件丢失或软件误删除,且无备份,可以通过重新安装软件包来恢复,首先查找到/etc/inittab属于哪一个RPM包<br>    chroot /mnt/sysimage</p>
<pre><code>rpm -qf /etc/inittab 查询到此文件来自initscripts包

exit 退出chroot模式

mount /dev/sr0 /mnt/source 挂载存放RPM包的安装光盘

rpm -ivh --replacepkgs | force /mnt/source/Packages/</code></pre><p>initscripts-9.03.49-1.el6.centos.x86_64.rpm CentOS6系统的要修复的硬盘系统的根目录在/mnt/sysimage下,需要使用–root选项指定其位置.覆盖安装/etc/inittab文件所在的RPM包,使用选项”—replacepkgs 或—force 表示覆盖安装</p>
<p>如果想只提取RPM包中的/etc/inittab文件进行恢复,可以在进入救援模式后,执行命令：</p>
<pre><code>rpm2cpio /mnt/source/Packages/initscripts-9.03.49-1.el6.centos.x86_64.rpm| cpio -idv ./etc/inittab

cp etc/inittab /mnt/sysimage/etc</code></pre><p>注意此命令执行时不能将文件直接恢复至/etc目录,只能提取到当前目录下,且恢复的文件名称所在路径要写完整的路径.提取文件成功后,将其复制到根分区所在的/mnt/sysimage目录下相应位置即可</p>
<h3 id="proc-目录"><a href="#proc-目录" class="headerlink" title="/proc 目录"></a>/proc 目录</h3><p>/proc目录：</p>
<p>内核把自己内部状态信息及统计信息,以及可配置参数通过proc伪文件系统加以输出</p>
<p>参数：</p>
<pre><code>只读：输出信息

可写：可接受用户指定&quot;新值&quot;来实现对内核某功能或特性的配置</code></pre><p>/proc/sys<br>    (1) sysctl命令用于查看或设定此目录中诸多参数</p>
<pre><code>sysctl -w path.to.parameter=VALUE

sysctl -w kernel.hostname=mail.magedu.com

(2) echo命令通过重定向方式也可以修改大多数参数的值

echo &quot;VALUE&quot; &gt; /proc/sys/path/to/parameter

echo &quot;websrv&quot; &gt; /proc/sys/kernel/hostname</code></pre><h3 id="sysctl命令"><a href="#sysctl命令" class="headerlink" title="sysctl命令"></a>sysctl命令</h3><p>sysctl命令：<br>    默认配置文件：/etc/sysctl.conf<br>    (1) 设置某参数<br>        sysctl -w parameter=VALUE<br>    (2) 通过读取配置文件设置参数<br>        sysctl -p [/path/to/conf_file]<br>    (3) 查看所有生效参数<br>        sysctl -a<br>常用的几个参数：<br>    net.ipv4.ip_forward<br>    net.ipv4.icmp_echo_ignore_all<br>    vm.drop_caches</p>
<h3 id="sys-目录"><a href="#sys-目录" class="headerlink" title="/sys 目录"></a>/sys 目录</h3><p>/sys目录：<br>    sysfs：为用户使用的伪文件系统,输出内核识别出的各硬件设备的相关属性信息,也有内核对硬件特性的设定信息；有些参数是可以修改的,用于调整硬件工作特性<br>    udev通过此路径下输出的信息动态为各设备创建所需要设备文件,udev是运行用户空间程序<br>    专用工具：udevadmin, hotplug<br>    udev为设备创建设备文件时,会读取其事先定义好的规则文件,一般在/etc/udev/rules.d及/usr/lib/udev/rules.d目录下</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/Linux-%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86-%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Linux-%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86-%E4%B8%80/" class="post-title-link" itemprop="url">Linux 启动和内核管理(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-09-11 13:16:31 / 修改时间：16:55:07" itemprop="dateCreated datePublished" datetime="2018-09-11T13:16:31+08:00">2018-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Linux组成"><a href="#Linux组成" class="headerlink" title="Linux组成"></a>Linux组成</h3><p>Linux: kernel+rootfs<br>    kernel: 进程管理、内存管理、网络管理、驱动程序、文件系统、安全功能<br>    rootfs:程序和glibc<br>    库：函数集合, function, 调用接口（头文件负责描述）<br>        过程调用：procedure,无返回值<br>        函数调用：function<br>    程序：二进制执行文件<br>内核设计流派：<br>    单内核(monolithic kernel)：Linux<br>        把所有功能集成于同一个程序<br>    微内核(micro kernel)：Windows, Solaris<br>        每种功能使用一个单独子系统实现</p>
<h3 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h3><p>Linux内核特点：<br>    支持模块化：.ko（内核对象）<br>        如：文件系统,硬件驱动,网络协议等<br>    支持内核模块的动态装载和卸载<br>组成部分：<br>核心文件：/boot/vmlinuz-VERSION-release<br>    ramdisk：辅助的伪根系统<br>    CentOS 5: /boot/initrd-VERSION-release.img<br>    CentOS 6,7: /boot/initramfs-VERSION-release.img<br>模块文件：/lib/modules/VERSION-release</p>
<h3 id="CentOS6启动流程"><a href="#CentOS6启动流程" class="headerlink" title="CentOS6启动流程"></a>CentOS6启动流程</h3><p>1.加载BIOS的硬件信息,获取第一个启动设备<br>2.读取第一个启动设备MBR的引导加载程序(grub)的启动信息<br>3.加载核心操作系统的核心信息,核心开始解压缩,并尝试驱动所有的硬件设备<br>4.核心执行init程序,并获取默认的运行信息<br>5.init程序执行/etc/rc.d/rc.sysinit文件<br>6.启动核心的外挂模块<br>7.init执行运行的各个批处理文件(scripts)<br>8.init执行/etc/rc.d/rc.local<br>9.执行/bin/login程序,等待用户登录<br>10.登录之后开始以Shell控制主机</p>
<h4 id="详细步骤"><a href="#详细步骤" class="headerlink" title="详细步骤"></a>详细步骤</h4><p> POST：Power-On-Self-Test,加电自检,是BIOS功能的一个主要部分.负责完成对CPU、主板、内存、硬盘子系统、显示子系统、串并行接口、键盘等硬件情况的检测<br>    ROM：BIOS,Basic Input and Output System,保存着有关计算机系统最重要的基本输入输出程序,系统信息设置、开机加电自检程序和系统启动自举程序等<br>    RAM：CMOS互补金属氧化物半导体,保存各项参数的设定<br>    按次序查找引导设备,第一个有引导程序的设备为本次启动设备<br> bootloader: 引导加载器,引导程序<br>    windows: ntloader,仅是启动OS<br>    Linux：功能丰富,提供菜单,允许用户选择要启动系统或不同的内核版本；把用户选定的内核装载到内存中的特定空间中,解压、展开,并把系统控制权移交给内核<br>        LILO：LInux LOader<br>        GRUB: GRand Unified Bootloader<br>            GRUB 0.X: GRUB Legacy, GRUB2</p>
<p>MBR:<br>    446: bootloader, 64: 分区表, 2: 55AA<br>GRUB:<br>    primary boot loader : 1st stage,1.5 stage<br>    secondary boot loader ：2nd stage,分区文件<br>kernel：<br>自身初始化：<br>    探测可识别到的所有硬件设备<br>    加载硬件驱动程序（借助于ramdisk加载驱动）<br>    以只读方式挂载根文件系统<br>    运行用户空间的第一个应用程序：/sbin/init</p>
<p>ramdisk：<br>内核中的特性之一：使用缓冲和缓存来加速对磁盘上的文件访问,并加载相应的硬件驱动<br>    ramdisk –&gt; ramfs 提高速度<br>    CentOS 5: initrd<br>        工具程序：mkinitrd<br>    CentOS 6,7: initramfs<br>        工具程序：mkinitrd, dracut<br>系统初始化：<br>POST –&gt; BootSequence (BIOS) –&gt; Bootloader(MBR) –&gt; kernel(ramdisk) –&gt; rootfs(只读) –&gt; init（systemd）</p>
<h3 id="ramdisk管理"><a href="#ramdisk管理" class="headerlink" title="ramdisk管理"></a>ramdisk管理</h3><p>ramdisk文件的制作：<br>(1) mkinitrd命令<br>    为当前正在使用的内核重新制作ramdisk文件<br>    mkinitrd /boot/initramfs-$(uname -r).img $(uname -r)<br>(2) dracut命令<br>    为当前正在使用的内核重新制作ramdisk文件<br>    dracut /boot/initramfs-$(uname -r).img $(uname -r) </p>
<h3 id="系统启动流程"><a href="#系统启动流程" class="headerlink" title="系统启动流程"></a>系统启动流程</h3><p>init程序的类型：</p>
<p>SysV: init, CentOS 5之前</p>
<pre><code>配置文件：/etc/inittab</code></pre><p>Upstart: init,CentOS 6</p>
<pre><code>配置文件：/etc/inittab, /etc/init/*.conf</code></pre><p>Systemd：systemd, CentOS 7</p>
<pre><code>配置文件：

    /usr/lib/systemd/system

    /etc/systemd/system</code></pre><h3 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h3><p>/sbin/init CentOS6之前<br>运行级别：为系统运行或维护等目的而设定；0-6：7个级别<br>    0：关机<br>    1：单用户模式(root自动登录), single, 维护模式<br>    2: 多用户模式,启动网络功能,但不会启动NFS；维护模式<br>    3：多用户模式,正常模式；文本界面<br>    4：预留级别；可同3级别<br>    5：多用户模式,正常模式；图形界面<br>    6：重启<br>默认级别：3, 5<br>切换级别：init #<br>查看级别：runlevel : who -r</p>
<h3 id="init初始化"><a href="#init初始化" class="headerlink" title="init初始化"></a>init初始化</h3><p>init读取其初始化文件：/etc/inittab<br>初始运行级别(RUN LEVEL)<br>系统初始化脚本<br>对应运行级别的脚本目录<br>捕获某个关键字顺序<br>定义UPS电源终端/恢复脚本<br>在虚拟控制台生成getty<br>在运行级别5初始化X</p>
<h3 id="CentOS-5-的inittab文件"><a href="#CentOS-5-的inittab文件" class="headerlink" title="CentOS 5 的inittab文件"></a>CentOS 5 的inittab文件</h3><p>配置文件：</p>
<pre><code>/etc/inittab</code></pre><p> 每一行格式： </p>
<pre><code>id:runlevel:action:process

id：是惟一标识该项的字符序列

runlevels： 定义了操作所使用的运行级别

action： 指定了要执行的特定操作

    wait: 切换至此级别运行一次</code></pre><p>​        respawn：此process终止,就重新启动之</p>
<pre><code>    initdefault：设定默认运行级别；process省略

    sysinit：设定系统初始化方式

process：定义了要执行的进程</code></pre><p> 示例：</p>
<pre><code>id:3:initdefault:

si::sysinit:/etc/rc.d/rc.sysinit

l0:0:wait:/etc/rc.d/rc 0

l1:1:wait:/etc/rc.d/rc 1...

l6:6:wait:/etc/rc.d/rc 6

ca::ctrlaltdel:/sbin/shutdown -t3 -r now</code></pre><p>CentOS 6 /etc/inittab和相关文件</p>
<p>/etc/inittab</p>
<pre><code>设置系统默认的运行级别

id:3:initdefault:</code></pre><p> 示例：</p>
<pre><code>破解CentOS5和6的root口令</code></pre><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/etc/init/control-alt-delete.conf</span><br><span class="line"></span><br><span class="line">/etc/init/tty.conf</span><br><span class="line"></span><br><span class="line">/etc/init/start-ttys.conf</span><br><span class="line"></span><br><span class="line">/etc/init/rc.conf</span><br><span class="line"></span><br><span class="line">/etc/init/prefdm.conf</span><br></pre></td></tr></table></figure>



<h3 id="启动流程-1"><a href="#启动流程-1" class="headerlink" title="启动流程"></a>启动流程</h3><p>/etc/rc.d/rc.sysinit: 系统初始化脚本<br>    (1) 设置主机名<br>    (2) 设置欢迎信息<br>    (3) 激活udev和selinux<br>    (4) 挂载/etc/fstab文件中定义的文件系统<br>    (5) 检测根文件系统,并以读写方式重新挂载根文件系统<br>    (6) 设置系统时钟<br>    (7) 激活swap设备<br>    (8) 根据/etc/sysctl.conf文件设置内核参数<br>    (9) 激活lvm及software raid设备<br>    (10) 加载额外设备的驱动程序<br>    (11) 清理操作</p>
<p>说明：rc N –&gt; 意味着读取/etc/rc.d/rcN.d/<br>    K<em>: K##*：##运行次序；数字越小,越先运行；数字越小的服务,通常为依赖到别的服务<br>    S</em>: S##<em>：##运行次序；数字越小,越先运行；数字越小的服务,通常为被依赖到的服务<br>    for srv in /etc/rc.d/rcN.d/K</em>: do<br>        $srv stop<br>    done<br>    for srv in /etc/rc.d/rcN.d/S*: do<br>        $srv start<br>    done</p>
<h3 id="chkconfig命令"><a href="#chkconfig命令" class="headerlink" title="chkconfig命令"></a>chkconfig命令</h3><p>ntsysv命令<br> chkconfig命令<br> 查看服务在所有级别的启动或关闭设定情形：<br>    chkconfig [–list][name]<br> 添加：<br>    SysV的服务脚本放置于/etc/rc.d/init.d (/etc/init.d)<br>    chkconfig –add name<br>        #!/bin/bash</p>
<p>​        #LLLL 表示初始在哪个级别下启动,-表示都不启动</p>
<pre><code># chkconfig: LLLL nn nn</code></pre><p> 删除：<br>    chkconfig –del name<br> 修改指定的链接类型<br>    chkconfig [–level levels] name<br>        –level LLLL: 指定要设置的级别；省略时表示2345</p>
<h3 id="xinetd管理的服务"><a href="#xinetd管理的服务" class="headerlink" title="xinetd管理的服务"></a>xinetd管理的服务</h3><p>service 命令：手动管理服务<br>    service 服务 start|stop|restart<br>    service –status-all<br>瞬态（Transient）服务被xinetd进程所管理<br>进入的请求首先被xinetd代理<br>配置文件：/etc/xinetd.conf、/etc/xinetd.d/<br>与libwrap.so文件链接<br>用chkconfig控制的服务：<br>示例：chkconfig tftp on</p>
<h3 id="启动流程-2"><a href="#启动流程-2" class="headerlink" title="启动流程"></a>启动流程</h3><p>注意：正常级别下,最后启动一个服务S99local没有链接至/etc/rc.d/init.d一个<br>服务脚本,而是指向了/etc/rc.d/rc.local脚本<br>不便或不需写为服务脚本放置于/etc/rc.d/init.d/目录,且又想开机时自动运行<br>的命令,可直接放置于/etc/rc.d/rc.local文件中<br>• /etc/rc.d/rc.local在指定运行级别脚本后运行<br>• 可以根据情况,进行自定义修改</p>
<p>1:2345:respawn:/usr/sbin/mingetty tty1<br>2:2345:respawn:/usr/sbin/mingetty tty2<br>…<br>6:2345:respawn:/usr/sbin/mingetty tty6<br>    mingetty会自动调用login程序<br>x:5:respawn:/etc/X11/prefdm -nodaemon</p>
<h3 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h3><p>总结：/sbin/init –&gt; (/etc/inittab) –&gt; 设置默认运行级别 –&gt; 运行系统初始脚本、完成系统初始化 –&gt; (关闭对应下需要关闭的服务)启动需要启动服务 –&gt; 设置登录终端<br>CentOS 6 init程序为: upstart, 其配置文件：<br>/etc/inittab, /etc/init/*.conf,配置文件的语法 遵循 upstart配置文件语法格式,和CentOS5不同</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/Go-%E8%AF%AD%E8%A8%80%E7%AE%80%E4%BB%8B-%E5%9B%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Go-%E8%AF%AD%E8%A8%80%E7%AE%80%E4%BB%8B-%E5%9B%9B/" class="post-title-link" itemprop="url">Go 语言简介(四)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-03-22 00:24:09" itemprop="dateCreated datePublished" datetime="2017-03-22T00:24:09+08:00">2017-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-01-03 09:57:31" itemprop="dateModified" datetime="2019-01-03T09:57:31+08:00">2019-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h4><p>Go语言中可以使用time.NewTimer或time.NewTicker来设置一个定时器，这个定时器会绑定在你的当前channel中，通过channel的阻塞通知机器来通知你的程序。</p>
<p>下面是一个timer的示例。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    timer := time.NewTimer(<span class="number">2</span>*time.Second)</span><br><span class="line"> </span><br><span class="line">    &lt;- timer.C</span><br><span class="line">    fmt.Println(<span class="string">"timer expired!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的例程看起来像一个Sleep，是的，不过Timer是可以Stop的。你需要注意Timer只通知一次。如果你要像C中的Timer能持续通知的话，你需要使用Ticker。下面是Ticker的例程：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ticker := time.NewTicker(time.Second)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> t := <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">        fmt.Println(<span class="string">"Tick at"</span>, t)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的这个ticker会让你程序进入死循环，我们应该放其放在一个goroutine中。下面这个程序结合了timer和ticker</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> </span><br><span class="line">    ticker := time.NewTicker(time.Second)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> t := <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">            fmt.Println(t)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//设置一个timer，10钞后停掉ticker</span></span><br><span class="line">    timer := time.NewTimer(<span class="number">10</span>*time.Second)</span><br><span class="line">    &lt;- timer.C</span><br><span class="line"> </span><br><span class="line">    ticker.Stop()</span><br><span class="line">    fmt.Println(<span class="string">"timer expired!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Socket编程"><a href="#Socket编程" class="headerlink" title="Socket编程"></a>Socket编程</h4><p>下面是我尝试的一个Echo Server的Socket代码，感觉还是挺简单的。</p>
<p>SERVER端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"io"</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> RECV_BUF_LEN = <span class="number">1024</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"0.0.0.0:6666"</span>)<span class="comment">//侦听在6666端口</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"error listening:"</span>+err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">"Starting the server"</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        conn, err := listener.Accept() <span class="comment">//接受连接</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(<span class="string">"Error accept:"</span>+err.Error())</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(<span class="string">"Accepted the Connection :"</span>, conn.RemoteAddr())</span><br><span class="line">        <span class="keyword">go</span> EchoServer(conn)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EchoServer</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, RECV_BUF_LEN)</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        n, err := conn.Read(buf);</span><br><span class="line">        <span class="keyword">switch</span> err &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line">                conn.Write( buf[<span class="number">0</span>:n] )</span><br><span class="line">            <span class="keyword">case</span> io.EOF:</span><br><span class="line">                fmt.Printf(<span class="string">"Warning: End of data: %s \n"</span>, err);</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                fmt.Printf(<span class="string">"Error: Reading data : %s \n"</span>, err);</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CLIENT端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> RECV_BUF_LEN = <span class="number">1024</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    conn,err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"127.0.0.1:6666"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"> </span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, RECV_BUF_LEN)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        <span class="comment">//准备要发送的字符串</span></span><br><span class="line">        msg := fmt.Sprintf(<span class="string">"Hello World, %03d"</span>, i)</span><br><span class="line">        n, err := conn.Write([]<span class="keyword">byte</span>(msg))</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">println</span>(<span class="string">"Write Buffer Error:"</span>, err.Error())</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(msg)</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//从服务器端收字符串</span></span><br><span class="line">        n, err = conn.Read(buf)</span><br><span class="line">        <span class="keyword">if</span> err !=<span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">println</span>(<span class="string">"Read Buffer Error:"</span>, err.Error())</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(<span class="keyword">string</span>(buf[<span class="number">0</span>:n]))</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//等一秒钟</span></span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h4><p>Go语言那么C，所以，一定会有一些系统调用。Go语言主要是通过两个包完成的。一个是<a href="http://golang.org/pkg/os/" target="_blank" rel="noopener">os包</a>，一个是<a href="http://golang.org/pkg/syscall/" target="_blank" rel="noopener">syscall包</a>。（注意，链接被墙）</p>
<p>这两个包里提供都是Unix-Like的系统调用，</p>
<ul>
<li>syscall里提供了什么Chroot/Chmod/Chmod/Chdir…，Getenv/Getgid/Getpid/Getgroups/Getpid/Getppid…，还有很多如Inotify/Ptrace/Epoll/Socket/…的系统调用。</li>
<li>os包里提供的东西不多，主要是一个跨平台的调用。它有三个子包，Exec（运行别的命令）, Signal（捕捉信号）和User（通过uid查name之类的）</li>
</ul>
<p>syscall包的东西我不举例了，大家可以看看《Unix高级环境编程》一书。</p>
<p>os里的取几个例：</p>
<p><strong>环境变量</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"os"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"strings"</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    os.Setenv(<span class="string">"WEB"</span>, <span class="string">"https://coolshell.cn"</span>) <span class="comment">//设置环境变量</span></span><br><span class="line">    <span class="built_in">println</span>(os.Getenv(<span class="string">"WEB"</span>)) <span class="comment">//读出来</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> _, env := <span class="keyword">range</span> os.Environ() &#123; <span class="comment">//穷举环境变量</span></span><br><span class="line">        e := strings.Split(env, <span class="string">"="</span>)</span><br><span class="line">        <span class="built_in">println</span>(e[<span class="number">0</span>], <span class="string">"="</span>, e[<span class="number">1</span>])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行命令行"><a href="#执行命令行" class="headerlink" title="执行命令行"></a>执行命令行</h4><p>下面是一个比较简单的示例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"os/exec"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cmd := exec.Command(<span class="string">"ping"</span>, <span class="string">"127.0.0.1"</span>)</span><br><span class="line">    out, err := cmd.Output()</span><br><span class="line">    <span class="keyword">if</span> err!=<span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"Command Error!"</span>, err.Error())</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="keyword">string</span>(out))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正规一点的用来处理标准输入和输出的示例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">    <span class="string">"bytes"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"os/exec"</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cmd := exec.Command(<span class="string">"tr"</span>, <span class="string">"a-z"</span>, <span class="string">"A-Z"</span>)</span><br><span class="line">    cmd.Stdin = strings.NewReader(<span class="string">"some input"</span>)</span><br><span class="line">    <span class="keyword">var</span> out bytes.Buffer</span><br><span class="line">    cmd.Stdout = &amp;out</span><br><span class="line">    err := cmd.Run()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">"in all caps: %q\n"</span>, out.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h4><p>Go语言中处理命令行参数很简单：(使用os的Args就可以了)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    args := os.Args</span><br><span class="line">    fmt.Println(args) <span class="comment">//带执行文件的</span></span><br><span class="line">    fmt.Println(args[<span class="number">1</span>:]) <span class="comment">//不带执行文件的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Windows下，如果运行结果如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Projects\Go&gt;go run args.go aaa bbb ccc ddd[<span class="type">C</span>:\<span class="type">Users</span>\<span class="type">haoel</span>\<span class="type">AppData</span>\<span class="type">Local</span>\<span class="type">Temp</span>\<span class="type">go</span>-<span class="type">build742679827</span>\<span class="type">command</span>-<span class="type">line</span>-<span class="type">arguments</span>\<span class="type">_obj</span>\<span class="type">a.out.exe</span> <span class="type">aaa</span> <span class="type">bbb</span> <span class="type">ccc</span> <span class="type">ddd</span>]</span><br><span class="line">[<span class="type">aaa</span> <span class="type">bbb</span> <span class="type">ccc</span> <span class="type">ddd</span>]</span><br></pre></td></tr></table></figure>

<p>那么，如果我们要搞出一些像 mysql -uRoot -hLocalhost -pPwd 或是像 cc -O3 -Wall -o a a.c 这样的命令行参数我们怎么办？Go提供了一个package叫flag可以容易地做到这一点</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"flag"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//第一个参数是“参数名”，第二个是“默认值”，第三个是“说明”。返回的是指针</span></span><br><span class="line">    host := flag.String(<span class="string">"host"</span>, <span class="string">"coolshell.cn"</span>, <span class="string">"a host name "</span>)</span><br><span class="line">    port := flag.Int(<span class="string">"port"</span>, <span class="number">80</span>, <span class="string">"a port number"</span>)</span><br><span class="line">    debug := flag.Bool(<span class="string">"d"</span>, <span class="literal">false</span>, <span class="string">"enable/disable debug mode"</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//正式开始Parse命令行参数</span></span><br><span class="line">    flag.Parse()</span><br><span class="line"> </span><br><span class="line">    fmt.Println(<span class="string">"host:"</span>, *host)</span><br><span class="line">    fmt.Println(<span class="string">"port:"</span>, *port)</span><br><span class="line">    fmt.Println(<span class="string">"debug:"</span>, *debug)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行起来会是这个样子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#如果没有指定参数名，则使用默认值</span><br><span class="line">$ <span class="keyword">go</span> run flagtest.<span class="keyword">go</span></span><br><span class="line">host: coolshell.cn</span><br><span class="line">port: <span class="number">80</span></span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line">#指定了参数名后的情况</span><br><span class="line">$ <span class="keyword">go</span> run flagtest.<span class="keyword">go</span> -host=localhost -port=<span class="number">22</span> -d</span><br><span class="line">host: localhost</span><br><span class="line">port: <span class="number">22</span></span><br><span class="line">debug: <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line">#用法出错了（如：使用了不支持的参数，参数没有=）</span><br><span class="line">$ <span class="keyword">go</span> build flagtest.<span class="keyword">go</span></span><br><span class="line">$ ./flagtest -debug -host localhost -port=<span class="number">22</span></span><br><span class="line">flag provided but not defined: -debug</span><br><span class="line">Usage of flagtest:</span><br><span class="line">  -d=<span class="literal">false</span>: enable/disable debug mode</span><br><span class="line">  -host=<span class="string">"coolshell.cn"</span>: a host name</span><br><span class="line">  -port=<span class="number">80</span>: a port number</span><br><span class="line">exit status <span class="number">2</span></span><br></pre></td></tr></table></figure>



<h4 id="一个简单的HTTP-Server"><a href="#一个简单的HTTP-Server" class="headerlink" title="一个简单的HTTP Server"></a>一个简单的HTTP Server</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"path/filepath"</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> http_root = <span class="string">"/home/haoel/coolshell.cn/"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">"/"</span>, rootHandler)</span><br><span class="line">    http.HandleFunc(<span class="string">"/view/"</span>, viewHandler)</span><br><span class="line">    http.HandleFunc(<span class="string">"/html/"</span>, htmlHandler)</span><br><span class="line"> </span><br><span class="line">    http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//读取一些HTTP的头</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">rootHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    fmt.Fprintf(w, <span class="string">"rootHandler: %s\n"</span>, r.URL.Path)</span><br><span class="line">    fmt.Fprintf(w, <span class="string">"URL: %s\n"</span>, r.URL)</span><br><span class="line">    fmt.Fprintf(w, <span class="string">"Method: %s\n"</span>, r.Method)</span><br><span class="line">    fmt.Fprintf(w, <span class="string">"RequestURI: %s\n"</span>, r.RequestURI )</span><br><span class="line">    fmt.Fprintf(w, <span class="string">"Proto: %s\n"</span>, r.Proto)</span><br><span class="line">    fmt.Fprintf(w, <span class="string">"HOST: %s\n"</span>, r.Host) </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//特别的URL处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">viewHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    fmt.Fprintf(w, <span class="string">"viewHandler: %s"</span>, r.URL.Path)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//一个静态网页的服务示例。（在http_root的html目录下）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">htmlHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"htmlHandler: %s\n"</span>, r.URL.Path)</span><br><span class="line">     </span><br><span class="line">    filename := http_root + r.URL.Path</span><br><span class="line">    fileext := filepath.Ext(filename)</span><br><span class="line"> </span><br><span class="line">    content, err := ioutil.ReadFile(filename)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"   404 Not Found!\n"</span>)</span><br><span class="line">        w.WriteHeader(http.StatusNotFound)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> contype <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">switch</span> fileext &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">".html"</span>, <span class="string">"htm"</span>:</span><br><span class="line">            contype = <span class="string">"text/html"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">".css"</span>:</span><br><span class="line">            contype = <span class="string">"text/css"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">".js"</span>:</span><br><span class="line">            contype = <span class="string">"application/javascript"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">".png"</span>:</span><br><span class="line">            contype = <span class="string">"image/png"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">".jpg"</span>, <span class="string">".jpeg"</span>:</span><br><span class="line">            contype = <span class="string">"image/jpeg"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">".gif"</span>:</span><br><span class="line">            contype = <span class="string">"image/gif"</span></span><br><span class="line">        <span class="keyword">default</span>: </span><br><span class="line">            contype = <span class="string">"text/plain"</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">"ext %s, ct = %s\n"</span>, fileext, contype)</span><br><span class="line">     </span><br><span class="line">    w.Header().Set(<span class="string">"Content-Type"</span>, contype)</span><br><span class="line">    fmt.Fprintf(w, <span class="string">"%s"</span>, content)</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go的功能库有很多，大家自己慢慢看吧。</p>
<p>参考自:</p>
<p>GO 语言简介（下）— 特性</p>
<p><a href="https://coolshell.cn/articles/8489.html" target="_blank" rel="noopener">https://coolshell.cn/articles/8489.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/Go-%E8%AF%AD%E8%A8%80%E7%AE%80%E4%BB%8B-%E4%B8%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Go-%E8%AF%AD%E8%A8%80%E7%AE%80%E4%BB%8B-%E4%B8%89/" class="post-title-link" itemprop="url">Go 语言简介(三)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-03-17 00:24:03" itemprop="dateCreated datePublished" datetime="2017-03-17T00:24:03+08:00">2017-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-01-03 09:57:14" itemprop="dateModified" datetime="2019-01-03T09:57:14+08:00">2019-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="goroutine"><a href="#goroutine" class="headerlink" title="goroutine"></a>goroutine</h4><p>GoRoutine主要是使用go关键字来调用函数，还可以使用匿名函数，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(msg <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(msg)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">go</span> f(<span class="string">"goroutine"</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(msg <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">        fmt.Println(msg)</span><br><span class="line">    &#125;(<span class="string">"going"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再来看一个示例，下面的代码中包括很多内容，包括时间处理，随机数处理，还有goroutine的代码。如果你熟悉C语言，你应该会很容易理解下面的代码。</p>
<p>你可以简单的把go关键字调用的函数想像成pthread_create。下面的代码使用for循环创建了3个线程，每个线程使用一个随机的Sleep时间，然后在routine()函数中会输出一些线程执行的时间信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"math/rand"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">routine</span><span class="params">(name <span class="keyword">string</span>, delay time.Duration)</span></span> &#123;</span><br><span class="line"> </span><br><span class="line">    t0 := time.Now()</span><br><span class="line">    fmt.Println(name, <span class="string">" start at "</span>, t0)</span><br><span class="line"> </span><br><span class="line">    time.Sleep(delay)</span><br><span class="line"> </span><br><span class="line">    t1 := time.Now()</span><br><span class="line">    fmt.Println(name, <span class="string">" end at "</span>, t1)</span><br><span class="line"> </span><br><span class="line">    fmt.Println(name, <span class="string">" lasted "</span>, t1.Sub(t0))</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//生成随机种子</span></span><br><span class="line">    rand.Seed(time.Now().Unix())</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> name <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++&#123;</span><br><span class="line">        name = fmt.Sprintf(<span class="string">"go_%02d"</span>, i) <span class="comment">//生成ID</span></span><br><span class="line">        <span class="comment">//生成随机等待时间，从0-4秒</span></span><br><span class="line">        <span class="keyword">go</span> routine(name, time.Duration(rand.Intn(<span class="number">5</span>)) * time.Second)</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//让主进程停住，不然主进程退了，goroutine也就退了</span></span><br><span class="line">    <span class="keyword">var</span> input <span class="keyword">string</span></span><br><span class="line">    fmt.Scanln(&amp;input)</span><br><span class="line">    fmt.Println(<span class="string">"done"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行的结果可能是:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">go_00  start at  <span class="number">2012</span><span class="number">-11</span><span class="number">-04</span> <span class="number">19</span>:<span class="number">46</span>:<span class="number">35.8974894</span> +<span class="number">0800</span> +<span class="number">0800</span></span><br><span class="line">go_01  start at  <span class="number">2012</span><span class="number">-11</span><span class="number">-04</span> <span class="number">19</span>:<span class="number">46</span>:<span class="number">35.8974894</span> +<span class="number">0800</span> +<span class="number">0800</span></span><br><span class="line">go_02  start at  <span class="number">2012</span><span class="number">-11</span><span class="number">-04</span> <span class="number">19</span>:<span class="number">46</span>:<span class="number">35.8974894</span> +<span class="number">0800</span> +<span class="number">0800</span></span><br><span class="line">go_01  end at  <span class="number">2012</span><span class="number">-11</span><span class="number">-04</span> <span class="number">19</span>:<span class="number">46</span>:<span class="number">36.8975894</span> +<span class="number">0800</span> +<span class="number">0800</span></span><br><span class="line">go_01  lasted  <span class="number">1.0001</span>s</span><br><span class="line">go_02  end at  <span class="number">2012</span><span class="number">-11</span><span class="number">-04</span> <span class="number">19</span>:<span class="number">46</span>:<span class="number">38.8987895</span> +<span class="number">0800</span> +<span class="number">0800</span></span><br><span class="line">go_02  lasted  <span class="number">3.0013001</span>s</span><br><span class="line">go_00  end at  <span class="number">2012</span><span class="number">-11</span><span class="number">-04</span> <span class="number">19</span>:<span class="number">46</span>:<span class="number">39.8978894</span> +<span class="number">0800</span> +<span class="number">0800</span></span><br><span class="line">go_00  lasted  <span class="number">4.0004</span>s</span><br></pre></td></tr></table></figure>

<h4 id="goroutine的并发安全性"><a href="#goroutine的并发安全性" class="headerlink" title="goroutine的并发安全性"></a>goroutine的并发安全性</h4><p>关于goroutine，我试了一下，无论是Windows还是Linux，基本上来说是用操作系统的线程来实现的。不过，goroutine有个特性，也就是说，<strong>如果一个goroutine没有被阻塞，那么别的goroutine就不会得到执行</strong>。这并不是真正的并发，如果你要真正的并发，你需要在你的main函数的第一行加上下面的这段代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"runtime"</span></span><br><span class="line">...</span><br><span class="line">runtime.GOMAXPROCS(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>还是让我们来看一个有并发安全性问题的示例（注意：我使用了C的方式来写这段Go的程序）</p>
<p>这是一个经常出现在教科书里卖票的例子，我启了5个goroutine来卖票，卖票的函数sell_tickets很简单，就是随机的sleep一下，然后对全局变量total_tickets作减一操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"math/rand"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"runtime"</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> total_tickets <span class="keyword">int32</span> = <span class="number">10</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sell_tickets</span><span class="params">(i <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> total_tickets &gt; <span class="number">0</span> &#123; <span class="comment">//如果有票就卖</span></span><br><span class="line">            time.Sleep( time.Duration(rand.Intn(<span class="number">5</span>)) * time.Millisecond)</span><br><span class="line">            total_tickets-- <span class="comment">//卖一张票</span></span><br><span class="line">            fmt.Println(<span class="string">"id:"</span>, i, <span class="string">"  ticket:"</span>, total_tickets)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    runtime.GOMAXPROCS(<span class="number">4</span>) <span class="comment">//我的电脑是4核处理器，所以我设置了4</span></span><br><span class="line">    rand.Seed(time.Now().Unix()) <span class="comment">//生成随机种子</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123; <span class="comment">//并发5个goroutine来卖票</span></span><br><span class="line">         <span class="keyword">go</span> sell_tickets(i)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//等待线程执行完</span></span><br><span class="line">    <span class="keyword">var</span> input <span class="keyword">string</span></span><br><span class="line">    fmt.Scanln(&amp;input)</span><br><span class="line">    fmt.Println(total_tickets, <span class="string">"done"</span>) <span class="comment">//退出时打印还有多少票</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个程序毋庸置疑有并发安全性问题，所以执行起来你会看到下面的结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">go</span> run sell_tickets.<span class="keyword">go</span></span><br><span class="line">id: <span class="number">0</span>   ticket: <span class="number">9</span>  </span><br><span class="line">id: <span class="number">0</span>   ticket: <span class="number">8</span>  </span><br><span class="line">id: <span class="number">4</span>   ticket: <span class="number">7</span>  </span><br><span class="line">id: <span class="number">1</span>   ticket: <span class="number">6</span>  </span><br><span class="line">id: <span class="number">3</span>   ticket: <span class="number">5</span>  </span><br><span class="line">id: <span class="number">0</span>   ticket: <span class="number">4</span>  </span><br><span class="line">id: <span class="number">3</span>   ticket: <span class="number">3</span>  </span><br><span class="line">id: <span class="number">2</span>   ticket: <span class="number">2</span>  </span><br><span class="line">id: <span class="number">0</span>   ticket: <span class="number">1</span>  </span><br><span class="line">id: <span class="number">3</span>   ticket: <span class="number">0</span>  </span><br><span class="line">id: <span class="number">1</span>   ticket: <span class="number">-1</span>  </span><br><span class="line">id: <span class="number">4</span>   ticket: <span class="number">-2</span>  </span><br><span class="line">id: <span class="number">2</span>   ticket: <span class="number">-3</span>  </span><br><span class="line">id: <span class="number">0</span>   ticket: <span class="number">-4</span>  </span><br><span class="line"><span class="number">-4</span> done</span><br></pre></td></tr></table></figure>

<p>可见，我们需要使用上锁，我们可以使用互斥量来解决这个问题。下面的代码，我只列出了修改过的内容：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"math/rand"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"runtime"</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> total_tickets <span class="keyword">int32</span> = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">var</span> mutex = &amp;sync.Mutex&#123;&#125; <span class="comment">//可简写成：var mutex sync.Mutex</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sell_tickets</span><span class="params">(i <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> total_tickets&gt;<span class="number">0</span> &#123;</span><br><span class="line">        mutex.Lock()</span><br><span class="line">        <span class="keyword">if</span> total_tickets &gt; <span class="number">0</span> &#123;</span><br><span class="line">            time.Sleep( time.Duration(rand.Intn(<span class="number">5</span>)) * time.Millisecond)</span><br><span class="line">            total_tickets--</span><br><span class="line">            fmt.Println(i, total_tickets)</span><br><span class="line">        &#125;</span><br><span class="line">        mutex.Unlock()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">.......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h4><p>说到并发就需要说说原子操作在这里就举一个很简单的示例：下面的程序有10个goroutine，每个会对cnt变量累加20次，所以，最后的cnt应该是200。如果没有atomic的原子操作，那么cnt将有可能得到一个小于200的数。</p>
<p>下面使用了atomic操作，所以是安全的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync/atomic"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> cnt <span class="keyword">uint32</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">for</span> i:=<span class="number">0</span>; i&lt;<span class="number">20</span>; i++ &#123;</span><br><span class="line">                time.Sleep(time.Millisecond)</span><br><span class="line">                atomic.AddUint32(&amp;cnt, <span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">    time.Sleep(time.Second)<span class="comment">//等一秒钟等goroutine完成</span></span><br><span class="line">    cntFinal := atomic.LoadUint32(&amp;cnt)<span class="comment">//取数据</span></span><br><span class="line">    fmt.Println(<span class="string">"cnt:"</span>, cntFinal)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的函数还有很多，参看<a href="http://golang.org/pkg/sync/atomic/" target="_blank" rel="noopener">go的atomic包文档</a></p>
<h4 id="Channel信道"><a href="#Channel信道" class="headerlink" title="Channel信道"></a>Channel信道</h4><p>Channal是什么？Channal就是用来通信的，就像Unix下的管道一样，在Go中是这样使用Channel的。</p>
<p>下面的程序演示了一个goroutine和主程序通信的例程。这个程序足够简单了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//创建一个string类型的channel</span></span><br><span class="line">    channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//创建一个goroutine向channel里发一个字符串</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; channel &lt;- <span class="string">"hello"</span> &#125;()</span><br><span class="line"> </span><br><span class="line">    msg := &lt;- channel</span><br><span class="line">    fmt.Println(msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>指定channel的buffer</strong></p>
<p>指定buffer的大小很简单，看下面的程序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">2</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        channel &lt;- <span class="string">"hello"</span></span><br><span class="line">        channel &lt;- <span class="string">"World"</span></span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    msg1 := &lt;-channel</span><br><span class="line">    msg2 := &lt;-channel</span><br><span class="line">    fmt.Println(msg1, msg2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Channel的阻塞</strong></p>
<p>注意，channel默认上是阻塞的，也就是说，如果Channel满了，就阻塞写，如果Channel空了，就阻塞读。于是，我们就可以使用这种特性来同步我们的发送和接收端。</p>
<p>下面这个例程说明了这一点，代码有点乱，不过我觉得不难理解。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> </span><br><span class="line">    channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>) <span class="comment">//注意: buffer为1</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        channel &lt;- <span class="string">"hello"</span></span><br><span class="line">        fmt.Println(<span class="string">"write \"hello\" done!"</span>)</span><br><span class="line"> </span><br><span class="line">        channel &lt;- <span class="string">"World"</span> <span class="comment">//Reader在Sleep，这里在阻塞</span></span><br><span class="line">        fmt.Println(<span class="string">"write \"World\" done!"</span>)</span><br><span class="line"> </span><br><span class="line">        fmt.Println(<span class="string">"Write go sleep..."</span>)</span><br><span class="line">        time.Sleep(<span class="number">3</span>*time.Second)</span><br><span class="line">        channel &lt;- <span class="string">"channel"</span></span><br><span class="line">        fmt.Println(<span class="string">"write \"channel\" done!"</span>)</span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    time.Sleep(<span class="number">2</span>*time.Second)</span><br><span class="line">    fmt.Println(<span class="string">"Reader Wake up..."</span>)</span><br><span class="line"> </span><br><span class="line">    msg := &lt;-channel</span><br><span class="line">    fmt.Println(<span class="string">"Reader: "</span>, msg)</span><br><span class="line"> </span><br><span class="line">    msg = &lt;-channel</span><br><span class="line">    fmt.Println(<span class="string">"Reader: "</span>, msg)</span><br><span class="line"> </span><br><span class="line">    msg = &lt;-channel <span class="comment">//Writer在Sleep，这里在阻塞</span></span><br><span class="line">    fmt.Println(<span class="string">"Reader: "</span>, msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码输出的结果如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Reader Wake up...</span><br><span class="line">Reader:  hello</span><br><span class="line">write <span class="string">"hello"</span> done!</span><br><span class="line">write <span class="string">"World"</span> done!</span><br><span class="line">Write <span class="keyword">go</span> sleep...</span><br><span class="line">Reader:  World</span><br><span class="line">write <span class="string">"channel"</span> done!</span><br><span class="line">Reader:  channel</span><br></pre></td></tr></table></figure>

<p><strong>Channel阻塞的这个特性还有一个好处是，可以让我们的goroutine在运行的一开始就阻塞在从某个channel领任务，这样就可以作成一个类似于线程池一样的东西。</strong></p>
<p><strong>多个Channel的select</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//创建两个channel - c1 c2</span></span><br><span class="line">    c1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    c2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//创建两个goruntine来分别向这两个channel发送数据</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">        c1 &lt;- <span class="string">"Hello"</span></span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">        c2 &lt;- <span class="string">"World"</span></span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//使用select来侦听两个channel</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> msg1 := &lt;-c1:</span><br><span class="line">            fmt.Println(<span class="string">"received"</span>, msg1)</span><br><span class="line">        <span class="keyword">case</span> msg2 := &lt;-c2:</span><br><span class="line">            fmt.Println(<span class="string">"received"</span>, msg2)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：上面的select是阻塞的，所以，才搞出ugly的for i &lt;2这种东西<strong>。</strong></p>
<p><strong>Channel select阻塞的Timeout</strong></p>
<p>解决上述那个for循环的问题，一般有两种方法：一种是阻塞但有timeout，一种是无阻塞。我们来看看如果给select设置上timeout的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    timeout_cnt := <span class="number">0</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> msg1 := &lt;-c1:</span><br><span class="line">        fmt.Println(<span class="string">"msg1 received"</span>, msg1)</span><br><span class="line">    <span class="keyword">case</span> msg2 := &lt;-c2:</span><br><span class="line">        fmt.Println(<span class="string">"msg2 received"</span>, msg2)</span><br><span class="line">    <span class="keyword">case</span>  &lt;-time.After(time.Second * <span class="number">30</span>)：</span><br><span class="line">        fmt.Println(<span class="string">"Time Out"</span>)</span><br><span class="line">        timout_cnt++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> time_cnt &gt; <span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中高亮的代码主要是用来让select返回的，注意 case中的time.After事件。</p>
<p><strong>Channel的无阻塞</strong></p>
<p>好，我们再来看看无阻塞的channel，其实也很简单，就是在select中加入default，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> msg1 := &lt;-c1:</span><br><span class="line">        fmt.Println(<span class="string">"received"</span>, msg1)</span><br><span class="line">    <span class="keyword">case</span> msg2 := &lt;-c2:</span><br><span class="line">        fmt.Println(<span class="string">"received"</span>, msg2)</span><br><span class="line">    <span class="keyword">default</span>: <span class="comment">//default会导致无阻塞</span></span><br><span class="line">        fmt.Println(<span class="string">"nothing received!"</span>)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Channel的关闭</strong></p>
<p>关闭Channel可以通知对方内容发送完了，不用再等了。参看下面的例程：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"math/rand"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> </span><br><span class="line">    channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    rand.Seed(time.Now().Unix())</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//向channel发送随机个数的message</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">()</span></span> &#123;</span><br><span class="line">        cnt := rand.Intn(<span class="number">10</span>)</span><br><span class="line">        fmt.Println(<span class="string">"message cnt :"</span>, cnt)</span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">0</span>; i&lt;cnt; i++&#123;</span><br><span class="line">            channel &lt;- fmt.Sprintf(<span class="string">"message-%2d"</span>, i)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(channel) <span class="comment">//关闭Channel</span></span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> more <span class="keyword">bool</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">var</span> msg <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">for</span> more &#123;</span><br><span class="line">        <span class="keyword">select</span>&#123;</span><br><span class="line">        <span class="comment">//channel会返回两个值，一个是内容，一个是还有没有内容</span></span><br><span class="line">        <span class="keyword">case</span> msg, more = &lt;- channel:</span><br><span class="line">            <span class="keyword">if</span> more &#123;</span><br><span class="line">                fmt.Println(msg)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                fmt.Println(<span class="string">"channel closed!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考自:</p>
<p>GO 语言简介（下）— 特性</p>
<p><a href="https://coolshell.cn/articles/8489.html" target="_blank" rel="noopener">https://coolshell.cn/articles/8489.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/Go-%E8%AF%AD%E8%A8%80%E7%AE%80%E4%BB%8B-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mark_avatar.png">
      <meta itemprop="name" content="Mark">
      <meta itemprop="description" content="半吊子民工 英特纳雄耐尔就一定要实现">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mark blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Go-%E8%AF%AD%E8%A8%80%E7%AE%80%E4%BB%8B-%E4%BA%8C/" class="post-title-link" itemprop="url">Go 语言简介(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-03-11 00:23:56" itemprop="dateCreated datePublished" datetime="2017-03-11T00:23:56+08:00">2017-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-01-03 09:56:55" itemprop="dateModified" datetime="2019-01-03T09:56:55+08:00">2019-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%8B%BE%E8%B4%9D/" itemprop="url" rel="index"><span itemprop="name">学海拾贝</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h4><p><strong>new</strong> 是一个分配内存的内建函数，但不同于其他语言中同名的new所作的工作，<strong>它只是将内存清零，而不是初始化内存</strong>。new(T)为一个类型为T的新项目分配了值为零的存储空间并返回其地址，也就是一个类型为<em>T的值。用Go的术语来说，就是*</em>它返回了一个指向新分配的类型为T的零值的指针**。</p>
<p><code>**make**(T,</code><em>args</em><code>)</code>函数的目的与<code>new(T)</code>不同。它仅用于创建切片、map和chan（消息管道），并返回类型<code>T</code>（不是<code>*T</code>）的一个<strong>被初始化了的</strong>（不是<strong>零</strong>）实例。这种差别的出现是由于这三种类型实质上是对在使用前必须进行初始化的数据结构的引用。例如，切片是一个具有三项内容的描述符，包括指向数据（在一个数组内部）的指针、长度以及容量，在这三项内容被初始化之前，切片值为<code>nil</code>。对于切片、映射和信道，<code>make</code>初始化了其内部的数据结构并准备了将要使用的值。如：</p>
<p>下面的代码分配了一个整型数组，长度为10，容量为100，并返回前10个数组的切片</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>以下示例说明了<code>new</code>和<code>make</code>的不同。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p *[]<span class="keyword">int</span> = <span class="built_in">new</span>([]<span class="keyword">int</span>)   <span class="comment">// 为切片结构分配内存；*p == nil；很少使用</span></span><br><span class="line"><span class="keyword">var</span> v  []<span class="keyword">int</span> = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>) <span class="comment">// 切片v现在是对一个新的有10个整数的数组的引用</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 不必要地使问题复杂化：</span></span><br><span class="line"><span class="keyword">var</span> p *[]<span class="keyword">int</span> = <span class="built_in">new</span>([]<span class="keyword">int</span>)</span><br><span class="line">fmt.Println(p) <span class="comment">//输出：&amp;[]</span></span><br><span class="line">*p = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(p) <span class="comment">//输出：&amp;[0 0 0 0 0 0 0 0 0 0]</span></span><br><span class="line">fmt.Println((*p)[<span class="number">2</span>]) <span class="comment">//输出： 0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 习惯用法:</span></span><br><span class="line">v := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">fmt.Println(v) <span class="comment">//输出：[0 0 0 0 0 0 0 0 0 0]</span></span><br></pre></td></tr></table></figure>

<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><p>要注意Go语言这种声明变量类型和函数返回值是反过来的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">max</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123; <span class="comment">//注意参数和返回值是怎么声明的</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> a &gt; b &#123;</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(max(<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>函数返回多个值</strong></p>
<p>Go中很多Package 都会返回两个值，一个是正常值，一个是错误，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    v, e := multi_ret(<span class="string">"one"</span>)</span><br><span class="line">    fmt.Println(v,e) <span class="comment">//输出 1 true</span></span><br><span class="line"> </span><br><span class="line">    v, e = multi_ret(<span class="string">"four"</span>)</span><br><span class="line">    fmt.Println(v,e) <span class="comment">//输出 0 false</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//通常的用法(注意分号后有e)</span></span><br><span class="line">    <span class="keyword">if</span> v, e = multi_ret(<span class="string">"four"</span>); e &#123;</span><br><span class="line">        <span class="comment">// 正常返回</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 出错返回</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">multi_ret</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">bool</span>)</span></span>&#123;</span><br><span class="line">    m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"one"</span>: <span class="number">1</span>, <span class="string">"two"</span>: <span class="number">2</span>, <span class="string">"three"</span>: <span class="number">3</span>&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> err <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">var</span> val <span class="keyword">int</span></span><br><span class="line"> </span><br><span class="line">    val, err = m[key]</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> val, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>函数不定参数</strong></p>
<p>例子很清楚了，我就不多说了</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(nums ...<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    fmt.Print(nums, <span class="string">" "</span>)  <span class="comment">//输出如 [1, 2, 3] 之类的数组</span></span><br><span class="line">    total := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _, num := <span class="keyword">range</span> nums &#123; <span class="comment">//要的是值而不是下标</span></span><br><span class="line">        total += num</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(total)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sum(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//传数组</span></span><br><span class="line">    nums := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">    sum(nums...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>函数闭包</strong></p>
<p>nextNum这个函数返回了一个匿名函数，这个匿名函数记住了nextNum中i+j的值，并改变了i,j的值，于是形成了一个闭包的用法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nextNum</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    i,j := <span class="number">1</span>,<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> tmp = i+j</span><br><span class="line">        i, j = j, tmp</span><br><span class="line">        <span class="keyword">return</span> tmp</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//main函数中是对nextNum的调用，其主要是打出下一个斐波拉契数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    nextNumFunc := nextNum()</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++ &#123;</span><br><span class="line">        fmt.Println(nextNumFunc())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>函数的递归</strong></p>
<p>和c基本是一样的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fact</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n * fact(n<span class="number">-1</span>)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(fact(<span class="number">7</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h4><p>Go的结构体和C的基本上一样，不过在初始化时有些不一样，Go支持带名字的初始化</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="keyword">string</span></span><br><span class="line">    age  <span class="keyword">int</span></span><br><span class="line">    email <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    person := Person&#123;<span class="string">"Tom"</span>, <span class="number">30</span>, <span class="string">"tom@gmail.com"</span>&#125;</span><br><span class="line">    person = Person&#123;name:<span class="string">"Tom"</span>, age: <span class="number">30</span>, email:<span class="string">"tom@gmail.com"</span>&#125;</span><br><span class="line"> </span><br><span class="line">    fmt.Println(person) <span class="comment">//输出 &#123;Tom 30 tom@gmail.com&#125;</span></span><br><span class="line"> </span><br><span class="line">    pPerson := &amp;person</span><br><span class="line"> </span><br><span class="line">    fmt.Println(pPerson) <span class="comment">//输出 &amp;&#123;Tom 30 tom@gmail.com&#125;</span></span><br><span class="line"> </span><br><span class="line">    pPerson.age = <span class="number">40</span></span><br><span class="line">    person.name = <span class="string">"Jerry"</span></span><br><span class="line">    fmt.Println(person) <span class="comment">//输出 &#123;Jerry 40 tom@gmail.com&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="结构体方法"><a href="#结构体方法" class="headerlink" title="结构体方法"></a>结构体方法</h4><p>注意：Go语言中没有public, protected, private的关键字，所以，<strong>如果想让一个方法可以被别的包访问的话，需要把这个方法的第一个字母大写。这是一种约定</strong>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> rect <span class="keyword">struct</span> &#123;</span><br><span class="line">    width, height <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rect)</span> <span class="title">area</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="comment">//求面积</span></span><br><span class="line">    <span class="keyword">return</span> r.width * r.height</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rect)</span> <span class="title">perimeter</span><span class="params">()</span> <span class="title">int</span></span>&#123; <span class="comment">//求周长</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>*(r.width + r.height)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := rect&#123;width: <span class="number">10</span>, height: <span class="number">15</span>&#125;</span><br><span class="line"> </span><br><span class="line">    fmt.Println(<span class="string">"面积: "</span>, r.area())</span><br><span class="line">    fmt.Println(<span class="string">"周长: "</span>, r.perimeter())</span><br><span class="line"> </span><br><span class="line">    rp := &amp;r</span><br><span class="line">    fmt.Println(<span class="string">"面积: "</span>, rp.area())</span><br><span class="line">    fmt.Println(<span class="string">"周长: "</span>, rp.perimeter())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口和多态"><a href="#接口和多态" class="headerlink" title="接口和多态"></a>接口和多态</h4><p>接口意味着多态，下面是一个经典的例子</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//---------- 接 口 --------//</span></span><br><span class="line"><span class="keyword">type</span> shape <span class="keyword">interface</span> &#123;</span><br><span class="line">    area() <span class="keyword">float64</span> <span class="comment">//计算面积</span></span><br><span class="line">    perimeter() <span class="keyword">float64</span> <span class="comment">//计算周长</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//--------- 长方形 ----------//</span></span><br><span class="line"><span class="keyword">type</span> rect <span class="keyword">struct</span> &#123;</span><br><span class="line">    width, height <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rect)</span> <span class="title">area</span><span class="params">()</span> <span class="title">float64</span></span> &#123; <span class="comment">//面积</span></span><br><span class="line">    <span class="keyword">return</span> r.width * r.height</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rect)</span> <span class="title">perimeter</span><span class="params">()</span> <span class="title">float64</span></span> &#123; <span class="comment">//周长</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>*(r.width + r.height)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//----------- 圆  形 ----------//</span></span><br><span class="line"><span class="keyword">type</span> circle <span class="keyword">struct</span> &#123;</span><br><span class="line">    radius <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *circle)</span> <span class="title">area</span><span class="params">()</span> <span class="title">float64</span></span> &#123; <span class="comment">//面积</span></span><br><span class="line">    <span class="keyword">return</span> math.Pi * c.radius * c.radius</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *circle)</span> <span class="title">perimeter</span><span class="params">()</span> <span class="title">float64</span></span> &#123; <span class="comment">//周长</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * math.Pi * c.radius</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ----------- 接口的使用 -----------//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">interface_test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := rect &#123;width:<span class="number">2.9</span>, height:<span class="number">4.8</span>&#125;</span><br><span class="line">    c := circle &#123;radius:<span class="number">4.3</span>&#125;</span><br><span class="line"> </span><br><span class="line">    s := []shape&#123;&amp;r, &amp;c&#125; <span class="comment">//通过指针实现</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> _, sh := <span class="keyword">range</span> s &#123;</span><br><span class="line">        fmt.Println(sh)</span><br><span class="line">        fmt.Println(sh.area())</span><br><span class="line">        fmt.Println(sh.perimeter())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="错误处理-Error接口"><a href="#错误处理-Error接口" class="headerlink" title="错误处理 - Error接口"></a>错误处理 - Error接口</h4><p>函数错误返回可能是C/C++时最让人纠结的东西的，Go的多值返回可以让我们更容易的返回错误，其可以在返回一个常规的返回值之外，还能轻易地返回一个详细的错误描述。通常情况下，错误的类型是error，它有一个内建的接口</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</span><br><span class="line">    Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来看一个错误处理的示例:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"errors"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//自定义的出错结构</span></span><br><span class="line"><span class="keyword">type</span> myError <span class="keyword">struct</span> &#123;</span><br><span class="line">    arg  <span class="keyword">int</span></span><br><span class="line">    errMsg <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//实现Error接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *myError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"%d - %s"</span>, e.arg, e.errMsg)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//两种出错</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">error_test</span><span class="params">(arg <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> arg &lt; <span class="number">0</span>  &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="number">-1</span>, errors.New(<span class="string">"Bad Arguments - negtive!"</span>)</span><br><span class="line">     &#125;<span class="keyword">else</span> <span class="keyword">if</span> arg &gt;<span class="number">256</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>, &amp;myError&#123;arg, <span class="string">"Bad Arguments - too large!"</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arg*arg, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//相关的测试</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, i := <span class="keyword">range</span> []<span class="keyword">int</span>&#123;<span class="number">-1</span>, <span class="number">4</span>, <span class="number">1000</span>&#125; &#123;</span><br><span class="line">        <span class="keyword">if</span> r, e := error_test(i); e != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"failed:"</span>, e)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"success:"</span>, r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序运行后输出:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">failed: Bad Arguments - negtive!</span><br><span class="line">success: <span class="number">16</span></span><br><span class="line">failed: <span class="number">1000</span> - Bad Arguments - too large!</span><br></pre></td></tr></table></figure>

<h4 id="错误处理-Defer"><a href="#错误处理-Defer" class="headerlink" title="错误处理-Defer"></a>错误处理-Defer</h4><p>下面的程序对于每一个熟悉C语言的人来说都不陌生（有资源泄露的问题），C++使用RAII来解决这种问题。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyFile</span><span class="params">(dstName, srcName <span class="keyword">string</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</span><br><span class="line">    src, err := os.Open(srcName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    dst, err := os.Create(dstName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    written, err = io.Copy(dst, src)</span><br><span class="line">    dst.Close()</span><br><span class="line">    src.Close()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go语言引入了Defer来确保那些被打开的文件能被关闭。如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyFile</span><span class="params">(dstName, srcName <span class="keyword">string</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</span><br><span class="line">    src, err := os.Open(srcName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> src.Close()</span><br><span class="line"> </span><br><span class="line">    dst, err := os.Create(dstName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> dst.Close()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> io.Copy(dst, src)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go的defer语句预设一个函数调用（延期的函数），该调用在函数执行defer返回时立刻运行。该方法显得不同常规，但却是处理上述情况很有效，无论函数怎样返回，都必须进行资源释放。</p>
<p>来看一个defer函数的示例:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">defer</span> fmt.Printf(<span class="string">"%d "</span>, i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>被延期的函数以后进先出（LIFO）的顺行执行，因此以上代码在返回时将打印4 3 2 1 0。</p>
<h4 id="错误处理-Panic-Recover"><a href="#错误处理-Panic-Recover" class="headerlink" title="错误处理-Panic/Recover"></a>错误处理-Panic/Recover</h4><p>对于不可恢复的错误，Go提供了一个内建的panic函数，它将创建一个运行时错误并使程序停止（相当暴力）。该函数接收一个任意类型（往往是字符串）作为程序死亡时要打印的东西。当编译器在函数的结尾处检查到一个panic时，就会停止进行常规的return语句检查。</p>
<p>下面的仅仅是一个示例。实际的库函数应避免panic。如果问题可以容忍，最好是让事情继续下去而不是终止整个程序。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user = os.Getenv(<span class="string">"USER"</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> user == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"no value for $USER"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当panic被调用时，它将立即停止当前函数的执行并开始逐级解开函数堆栈，同时运行所有被defer的函数。如果这种解开达到堆栈的顶端，程序就死亡了。但是，也可以使用内建的recover函数来重新获得Go程的控制权并恢复正常的执行。 对recover的调用会通知解开堆栈并返回传递到panic的参量。由于仅在解开期间运行的代码处在被defer的函数之内，recover仅在被延期的函数内部才是有用的。</p>
<p>你可以简单地理解为recover就是用来捕捉Painc的，防止程序一下子就挂掉了。</p>
<p>下面是一个很简单的例程:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">g</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> i&gt;<span class="number">1</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"Panic!"</span>)</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"%v"</span>, i))</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"Recovered in f"</span>, r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line">        fmt.Println(<span class="string">"Calling g with "</span>, i)</span><br><span class="line">        g(i)</span><br><span class="line">        fmt.Println(<span class="string">"Returned normally from g."</span>)</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    f()</span><br><span class="line">    fmt.Println(<span class="string">"Returned normally from f."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：（我们可以看到Painc后的for循环就没有往下执行了，但是main的程序还在往下走）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Calling g with  <span class="number">0</span></span><br><span class="line">Returned normally from g.</span><br><span class="line">Calling g with  <span class="number">1</span></span><br><span class="line">Returned normally from g.</span><br><span class="line">Calling g with  <span class="number">2</span></span><br><span class="line">Panic!</span><br><span class="line">Recovered in f <span class="number">2</span></span><br><span class="line">Returned normally from f.</span><br></pre></td></tr></table></figure>

<p>参考自:</p>
<p>GO 语言简介（上）— 语法</p>
<p><a href="https://coolshell.cn/articles/8460.html" target="_blank" rel="noopener">https://coolshell.cn/articles/8460.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mark"
      src="/images/mark_avatar.png">
  <p class="site-author-name" itemprop="name">Mark</p>
  <div class="site-description" itemprop="description">半吊子民工 英特纳雄耐尔就一定要实现</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:markupzh@gmail.com" title="E-Mail → mailto:markupzh@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mark</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
